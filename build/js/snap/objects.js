function SpriteMorph(t){this.init(t)}function SpriteHighlightMorph(){this.init()}function StageMorph(t,e){this.thumbnailIsUploadCdn=!0,this.isProductThumbnail=!0,this.init(t,e)}function SpriteBubbleMorph(t,e,o,r){this.init(t,e,o,r)}function Costume(t,e,o){this.contents=t||newCanvas(),this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null,this.src=null}function SVG_Costume(t,e,o){this.contents=t,this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(t){this.init(t)}function Sound(t,e){this.audio=t,this.name=e||"Sound"}function Note(t){this.pitch=0===t?0:t||69,this.setupContext(),this.oscillator=null}function CellMorph(t,e,o,r){this.init(t,e,o,r)}function WatcherMorph(t,e,o,r,i){this.init(t,e,o,r,i)}function StagePrompterMorph(t){this.init(t)}modules.objects="2015-May-18";var SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Note,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph;SpriteMorph.prototype=new PenMorph,SpriteMorph.prototype.constructor=SpriteMorph,SpriteMorph.uber=PenMorph.prototype,SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.cate=["motion","control","looks","sensing","sound","operators","pen","variables"],SpriteMorph.prototype.cateName=["动作","控制","外观","侦测","声音","运算","画笔","变量"],SpriteMorph.prototype.blockColor={motion:new Color(240,100,94),looks:new Color(210,115,173),sound:new Color(247,188,97),pen:new Color(241,138,80),control:new Color(61,174,210),sensing:new Color(112,141,215),operators:new Color(114,180,108),variables:new Color(186,147,213),lists:new Color(228,25,140),other:new Color(150,150,150)},SpriteMorph.prototype.blockColorPressed={motion:new Color(240,100,94).darker(20),looks:new Color(210,115,173).darker(20),sound:new Color(247,188,97).darker(20),pen:new Color(241,138,80).darker(20),control:new Color(61,174,210).darker(20),sensing:new Color(112,141,215).darker(20),operators:new Color(114,180,108).darker(20),variables:new Color(186,147,213).darker(20),lists:new Color(228,25,140).darker(20),other:new Color(150,150,150).darker(20)},SpriteMorph.prototype.paletteColor=new Color(242,239,230),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"移动 %n 歩",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"旋转 %clockwise %n 度",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"旋转 %counterclockwise %n 度",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"面向 %dir 度"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"面向 %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"移到 x: %n  y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"移到 %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"在 %n 秒内，平滑移动到 x: %n  y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"将x坐标增加 %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"将x坐标设定为 %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"将y坐标增加 %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"将y坐标设定为 %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"碰到边缘就反弹"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x坐标"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y坐标"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"方向"},setDraggable:{only:SpriteMorph,type:"command",category:"motion",spec:"设置角色拖动为 %drag",defaults:["可拖动"]},doSwitchToCostume:{type:"command",category:"looks",spec:"切换到造型 %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"下一个造型"},getCostumeIdx:{type:"reporter",category:"looks",spec:"造型编号"},doSayFor:{type:"command",category:"looks",spec:"说 %s  %n 秒",defaults:[localize("你好！"),2]},bubble:{type:"command",category:"looks",spec:"说 %s",defaults:[localize("你好！")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"思考 %s  %n 秒",defaults:[localize("嗯..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"思考 %s",defaults:[localize("嗯...")]},changeEffect:{type:"command",category:"looks",spec:"将 %eff 特效增加 %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"将 %eff 特效设定为 %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"清除所有图形特效"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"将角色的大小增加 %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"将角色的大小设定为 %n",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"大小"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"显示"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"隐藏"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"移至最上层"},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"下移 %n 层",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"警告: %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"c控制台日志 %mult%s"},playSound:{type:"command",category:"sound",spec:"播放声音 %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"播放声音 %snd 直到播放完毕"},doStopAllSounds:{type:"command",category:"sound",spec:"停止所有声音"},doRest:{type:"command",category:"sound",spec:"停止 %n 秒",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"弹奏 %n  %n 拍",defaults:[60,.5]},doChangeTempo:{type:"command",category:"sound",spec:"将节奏加快 %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"将节奏设定为 %n",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"节奏"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"清除所有画笔"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"落笔"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"抬笔"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的颜色设定为 %clr"},changeHue:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的颜色值增加 %n",defaults:[10]},setHue:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的颜色值设定为 %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的色度增加 %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的色度设定为 %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的大小增加 %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"将画笔的大小设定为 %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"图章"},receiveGo:{type:"hat",category:"control",spec:"当 %greenflag 被点击"},receiveKey:{type:"hat",category:"control",spec:"当按下 %keyHat"},receiveInteraction:{type:"hat",category:"control",spec:"当角色被 %interaction",defaults:["点击"]},receiveMessage:{type:"hat",category:"control",spec:"当接收到 %msgHat"},doBroadcast:{type:"command",category:"control",spec:"广播 %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"广播 %msg 并等待"},getLastMessage:{type:"reporter",category:"control",spec:"消息"},doWait:{type:"command",category:"control",spec:"等待 %n 秒",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"直到 %b 前，请保持等待"},doForever:{type:"command",category:"control",spec:"重复执行 %c"},doRepeat:{type:"command",category:"control",spec:"重复执行 %n  %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"重复执行直到 %b  %c"},doIf:{type:"command",category:"control",spec:"如果 %b  %c"},doIfElse:{type:"command",category:"control",spec:"如果 %b  %c 否则 %c"},doStopThis:{type:"command",category:"control",spec:"停止 %stopChoices"},doStopOthers:{type:"command",category:"control",spec:"停止 %stopOthersChoices"},doRun:{type:"command",category:"control",spec:"运行 %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"启动 %cmdRing  %inputs"},evaluate:{type:"reporter",category:"control",spec:"调用 %repRing  %inputs"},doReport:{type:"command",category:"control",spec:"报告 %s"},doCallCC:{type:"command",category:"control",spec:"持续运行 %cmdRing"},reportCallCC:{type:"reporter",category:"control",spec:"持续调用 %cmdRing"},doWarp:{type:"command",category:"other",spec:"直接运行 %c"},receiveOnClone:{type:"hat",category:"control",spec:"当我开始克隆"},createClone:{type:"command",category:"control",spec:"新建一个克隆 %cln"},removeClone:{type:"command",category:"control",spec:"删除这个克隆"},doPauseAll:{type:"command",category:"control",spec:"暂停所有 %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"碰到 %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"碰到颜色 %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"颜色 %clr 碰到了颜色 %clr ？"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"选择颜色 %clr"},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"堆栈大小"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"框架"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"询问 %s 并等待",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"回答"},getLastAnswer:{type:"reporter",category:"sensing",spec:"回答"},reportMouseX:{type:"reporter",category:"sensing",spec:"鼠标的x坐标"},reportMouseY:{type:"reporter",category:"sensing",spec:"鼠标的y坐标"},reportMouseDown:{type:"predicate",category:"sensing",spec:"按下鼠标？"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"按键 %key 是否按下？"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"到 %dst 的距离"},doResetTimer:{type:"command",category:"sensing",spec:"计时器归零"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"计时器"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%spr 的 %att",defaults:["舞台",["costume #"]]},reportURL:{type:"reporter",category:"sensing",spec:"http:// %s",defaults:["codemao.cn"]},reportIsFastTracking:{type:"predicate",category:"sensing",spec:"turbo模式?"},doSetFastTracking:{type:"command",category:"sensing",spec:"设置Turbo模式 %b"},reportDate:{type:"reporter",category:"sensing",spec:"当前 %dates"},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n"},reportProduct:{type:"reporter",category:"operators",spec:"%n × %n"},reportQuotient:{type:"reporter",category:"operators",spec:"%n ÷ %n"},reportRound:{type:"reporter",category:"operators",spec:"将 %n 四舍五入"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun %n",defaults:[null,10]},reportModulus:{type:"reporter",category:"operators",spec:"%n 除以 %n 的余数"},reportRandom:{type:"reporter",category:"operators",spec:"在 %n 到 %n 间随机选一个数",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportContains:{type:"predicate",category:"operators",spec:"%s 包含 %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b 且 %b"},reportOr:{type:"predicate",category:"operators",spec:"%b 或 %b"},reportNot:{type:"predicate",category:"operators",spec:"%b 不成立"},reportTrue:{type:"predicate",category:"operators",spec:"成立"},reportFalse:{type:"predicate",category:"operators",spec:"不成立"},reportJoinWords:{type:"reporter",category:"operators",spec:"将 %words 放一起",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"第 %n 位在文字 %s 中",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"%s 的长度",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"字符 %s 的Unicode编码值",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"Unicode编码值为 %n 的字符",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"%s 是 %typ 类型？",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"%s 与 %s 相同吗？"},reportTextSplit:{type:"reporter",category:"operators",spec:"根据 %delim 分割 %s",defaults:[" ",localize("hello")+" "+localize("world")]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"%s 类型",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun 的 %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",category:"variables",spec:"将变量 %var 的值设定为 %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"将变量 %var 的值增加 %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"显示变量 %var"},doHideVar:{type:"command",category:"variables",spec:"隐藏变量 %var"},doDeclareVariables:{type:"command",category:"other",spec:"脚本变量 %scriptVars"},reportNewList:{type:"reporter",category:"lists",spec:"链表 %exp"},reportCONS:{type:"reporter",category:"lists",spec:"设定 %s 为链表 %l 第一项"},reportListItem:{type:"reporter",category:"lists",spec:"第 %idx 项在链表 %l 中",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"链表 %l 除第一记录以外内容"},reportListLength:{type:"reporter",category:"lists",spec:"链表 %l 的长度"},reportListContainsItem:{type:"predicate",category:"lists",spec:"链表 %l 包含 %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"将 %s 加入链表 %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"将第 %ida 项从链表 %l 中删除",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"将 %s 插入到第 %idx 项在 %l 中",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"将第 %idx 项在链表 %l 中替换为 %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cs",defaults:[localize("each item")]},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapStringCode:{type:"command",category:"other",spec:"map String to code %code",defaults:["<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness","setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient"],reportDifference:["reportSum","reportProduct","reportQuotient"],reportProduct:["reportDifference","reportSum","reportQuotient"],reportQuotient:["reportDifference","reportProduct","reportSum"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],reportTrue:["reportFalse"],reportFalse:["reportTrue"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]},SpriteMorph.prototype.init=function(t){this.name="角色",this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.customBlocks=[],this.costumes=new List,this.costume=null,this.costumeNum=1,this.sounds=new List,this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,this.version=Date.now(),this.isClone=!1,this.cloneOriginName="",this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={negative:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,brightness:0,color:0,comic:0,duplicate:0,confetti:0},SpriteMorph.uber.init.call(this),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(){"use strict";var t,e,o,r=SpriteMorph.uber.fullCopy.call(this),i=this,s=[];r.stopTalking(),r.color=this.color.copy(),r.blocksCache={},r.paletteCache={},r.scripts=this.scripts.fullCopy(),r.scripts.owner=r,r.variables=this.variables.copy(),r.variables.owner=r,r.customBlocks=[],r.graphicsValues={};for(o in this.graphicsValues)this.graphicsValues.hasOwnProperty(o)&&(r.graphicsValues[o]=this.graphicsValues[o]);return this.customBlocks.forEach(function(t){e=t.copyAndBindTo(r),r.customBlocks.push(e),r.allBlockInstances(t).forEach(function(t){t.definition=e})}),this.costumes.asArray().forEach(function(t){var e=t.copy();s.push(e),t===i.costume&&(r.costume=e)}),r.costumes=new List(s),s=[],this.sounds.asArray().forEach(function(t){s.push(t)}),r.sounds=new List(s),r.nestingScale=1,r.rotatesWithAnchor=!0,r.anchor=null,r.parts=[],this.parts.forEach(function(e){t=e.fullCopy(),t.nestingScale=e.nestingScale,t.rotatesWithAnchor=e.rotatesWithAnchor,r.attachPart(t)}),r},SpriteMorph.prototype.appearIn=function(t){this.name=t.newSpriteName(this.name),t.stage.add(this),t.sprites.add(this),t.corral.addSprite(this),this.parts.forEach(function(e){e.appearIn(t)})},SpriteMorph.prototype.setName=function(t){this.name=t||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var t,e,o,r,i,s,n,p,h,a,c,l,u,d,g=this,y=[];if(this.isWarped)return void(this.wantsRedraw=!0);if(t=this.center(),r=this.costume&&"function"==typeof this.costume.loaded,n=this.parent instanceof StageMorph?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(o=!0)),this.costume&&!r)s=o?this.costume.flipped():this.costume,y=s.bounds().corners().map(function(t){return t.rotateBy(radians(e-90),g.costume.center())}),h=y[0],c=y[0],y.forEach(function(t){h=h.min(t),c=c.max(t)}),l=h.corner(c).extent().multiplyBy(this.scale*n),a=new Point(0,0).rotateBy(radians(-(e-90)),s.center()).subtract(h),this.image=newCanvas(l),this.silentSetExtent(l),u=this.image.getContext("2d"),u.scale(this.scale*n,this.scale*n),u.translate(a.x,a.y),u.rotate(radians(e-90)),u.drawImage(s.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(t,!0),this.rotationOffset=a.translateBy(s.rotationCenter).rotateBy(radians(-(e-90)),a).scaleBy(this.scale*n);else if(e=o?-90:e,p=Math.min(Math.max(this.normalExtent.x*this.scale*n,5),1e3),this.silentSetExtent(new Point(p,p)),this.image=newCanvas(this.extent()),this.setCenter(t,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),r)return i=this.costume,d=setInterval(function(){g.wearCostume(i),clearInterval(d)},100),g.wearCostume(null);this.version=Date.now()},SpriteMorph.prototype.endWarp=function(){if(this.isWarped=!1,this.wantsRedraw){var t=this.xPosition(),e=this.yPosition();this.drawNew(),this.silentGotoXY(t,e,!0),this.wantsRedraw=!1}this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(t){var e,o,r,i,s,n=new Morph,p=this.extent();for(o=this.image.getContext("2d").getImageData(0,0,p.x,p.y),n.image=newCanvas(p),n.bounds=this.bounds.copy(),e=n.image.getContext("2d"),s=e.createImageData(p.x,p.y),i=0;i<p.x*p.y*4;i+=4)r=new Color(o.data[i],o.data[i+1],o.data[i+2]),r.eq(t)&&(s.data[i]=o.data[i],s.data[i+1]=o.data[i+1],s.data[i+2]=o.data[i+2],s.data[i+3]=255);return e.putImageData(s,0,0),n},SpriteMorph.prototype.blockForSelector=function(t,e){var o,r,i,s,n,p;if(o=this.blockMigrations[t],r=this.blocks[o?o.selector:t],!r)return null;if(i="command"===r.type?new CommandBlockMorph:"hat"===r.type?new HatBlockMorph:"ring"===r.type?new RingMorph:new ReporterBlockMorph("predicate"===r.type),i.color=this.blockColor[r.category],i.category=r.category,i.selector=o?o.selector:t,contains(["reifyReporter","reifyPredicate"],i.selector)&&(i.isStatic=!0),i.setSpec(localize(r.spec)),e&&r.defaults||o&&o.inputs)if(s=o?o.inputs:r.defaults,i.defaults=s,n=i.inputs(),n[0]instanceof MultiArgMorph)n[0].setContents(s),n[0].defaults=s;else for(p=0;p<s.length;p+=1)null!==s[p]&&n[p].setContents(s[p]);return i},SpriteMorph.prototype.variableBlock=function(t){var e=new ReporterBlockMorph(!1);return e.selector="reportGetVar",e.color=this.blockColor.variables,e.category="variables",e.setSpec(t),e.isDraggable=!0,e},SpriteMorph.prototype.blockTemplates=function(t){function e(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e}function r(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){u.toggleWatcher(t,localize(e.spec),u.blockColor[e.category])},null,function(){return u.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){u.toggleVariableWatcher(t)},null,function(){return u.showingVariableWatcher(t)},null)}function s(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function n(t){t&&(u.variables.silentFind(t[0])?u.inform("that name is already in use"):(u.addVariable(t[0],t[1]),u.toggleVariableWatcher(t[0],t[1]),u.blocksCache[d]=null,u.paletteCache[d]=null,u.parentThatIsA(IDE_Morph).refreshPalette()))}function p(t){t.forEach(function(t){l.push(g[t[1]](t[0]))}),l.push("-")}var h,a,c,l=[],u=this,d=t||"control",g={block:function(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e},variableBlock:function(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e},watcherToggle:function(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){u.toggleWatcher(t,localize(e.spec),u.blockColor[e.category])},null,function(){return u.showingWatcher(t)},null)},variableWatcherToggle:function(t){return new ToggleMorph("checkbox",this,function(){u.toggleVariableWatcher(t)},null,function(){return u.showingVariableWatcher(t)},null)}};if(codemao.preloadConfig&&codemao.preloadConfig.blocks){var y=codemao.preloadConfig.blocks[d];return y&&y.forEach(p),l}return"motion"===d?(l.push(e("gotoXY")),l.push(e("forward")),l.push(e("turn")),l.push(e("doGotoObject")),l.push(e("doGlide")),l.push("-"),l.push(e("setHeading")),l.push(e("doFaceTowards")),l.push("-"),l.push(e("changeXPosition")),l.push(e("setXPosition")),l.push(e("changeYPosition")),l.push(e("setYPosition")),l.push(e("bounceOffEdge")),l.push(e("setDraggable")),l.push("-"),l.push(r("xPosition")),l.push(e("xPosition")),l.push(r("yPosition")),l.push(e("yPosition")),l.push(r("direction")),l.push(e("direction"))):"looks"===d?(l.push(e("show")),l.push(e("hide")),l.push("-"),l.push(e("doSwitchToCostume")),l.push(e("doWearNextCostume")),l.push("-"),l.push(e("doSayFor")),l.push(e("bubble")),l.push("-"),l.push(e("changeEffect")),l.push(e("setEffect")),l.push(e("clearEffects")),l.push("-"),l.push(e("changeScale")),l.push(e("setScale")),l.push("-"),l.push(e("comeToFront")),l.push(e("goBack")),l.push("-"),l.push("-"),l.push(r("getCostumeIdx")),l.push(e("getCostumeIdx")),l.push(r("getScale")),l.push(e("getScale")),this.world().isDevMode&&(l.push("-"),c=new TextMorph(localize("development mode \ndebugging primitives:")),c.fontSize=9,c.setColor(this.paletteTextColor),l.push(c),l.push("-"),l.push(e("reportCostumes")),l.push("-"),l.push(e("log")),l.push(e("alert")),l.push("-"),l.push(e("doScreenshot")))):"sound"===d?(l.push(e("playSound")),l.push(e("doPlaySoundUntilDone")),l.push(e("doStopAllSounds")),l.push("-"),l.push(e("doRest")),this.world().isDevMode&&(l.push("-"),c=new TextMorph(localize("development mode \ndebugging primitives:")),c.fontSize=9,c.setColor(this.paletteTextColor),l.push(c),l.push("-"),l.push(e("reportSounds")))):"pen"===d?(l.push(e("clear")),l.push("-"),l.push(e("down")),l.push(e("up")),l.push("-"),l.push(e("setColor")),l.push(e("changeHue")),l.push(e("setHue")),l.push("-"),l.push(e("changeBrightness")),l.push(e("setBrightness")),l.push("-"),l.push(e("changeSize")),l.push(e("setSize")),l.push("-"),l.push(e("doStamp"))):"control"===d?(l.push(e("receiveGo")),l.push(e("receiveInteraction")),l.push(e("receiveMessage")),l.push(e("doWait")),l.push(e("doBroadcast")),l.push("-"),l.push(e("doForever")),l.push(e("doRepeat")),l.push(e("doUntil")),l.push("-"),l.push(e("doIf")),l.push(e("doIfElse")),l.push("-"),l.push(e("receiveKey")),l.push("-"),l.push(e("doWaitUntil")),l.push(e("doBroadcastAndWait")),l.push("-"),l.push(e("doStopThis")),l.push(e("doStopOthers")),l.push("-"),l.push(e("receiveOnClone")),l.push(e("createClone")),l.push(e("removeClone")),l.push("-")):"sensing"===d?(l.push(e("reportAttributeOf")),l.push("-"),l.push(e("reportTouchingObject")),l.push("-"),l.push(e("doAsk")),l.push(r("getLastAnswer")),l.push(e("getLastAnswer")),l.push("-"),l.push(r("reportMouseX")),l.push(e("reportMouseX")),l.push(r("reportMouseY")),l.push(e("reportMouseY")),l.push(e("reportMouseDown")),l.push("-"),l.push(e("reportDistanceTo")),l.push("-"),l.push(e("doResetTimer")),l.push(r("getTimer")),l.push(e("getTimer")),l.push("-"),l.push(e("reportKeyPressed")),l.push("-"),l.push(e("reportTouchingColor")),l.push(e("reportColorIsTouchingColor")),l.push("-"),this.world().isDevMode&&(l.push("-"),c=new TextMorph(localize("development mode \ndebugging primitives:")),c.fontSize=9,c.setColor(this.paletteTextColor),l.push(c),l.push("-"),l.push(r("reportThreadCount")),l.push(e("reportThreadCount")),l.push(e("colorFiltered")),l.push(e("reportStackSize")),l.push(e("reportFrameCount")))):"operators"===d?(l.push(e("reportEquals")),l.push(e("reportRandom")),l.push(e("reportJoinWords")),l.push(e("reportContains")),l.push("-"),l.push(e("reportSum")),l.push(e("reportDifference")),l.push(e("reportProduct")),l.push(e("reportQuotient")),l.push("-"),l.push(e("reportModulus")),l.push(e("reportRound")),l.push(e("reportMonadic")),l.push("-"),l.push(e("reportLessThan")),l.push(e("reportGreaterThan")),l.push("-"),l.push(e("reportAnd")),l.push(e("reportOr")),l.push(e("reportNot")),l.push("-"),l.push(e("reportTrue")),l.push(e("reportFalse")),l.push("-"),this.world().isDevMode&&(l.push("-"),c=new TextMorph("development mode \ndebugging primitives:"),c.fontSize=9,c.setColor(this.paletteTextColor),l.push(c),l.push("-"),l.push(e("reportTypeOf")),l.push(e("reportTextFunction")))):"variables"===d&&(a=new PushButtonMorph(null,function(){new VariableDialogMorph(null,n,u).prompt("给变量起个名字吧",null,u.world())},"添加一个新的变量"),a.userMenu=s,a.selector="addVariable",a.showHelp=BlockMorph.prototype.showHelp,l.push(a),this.variables.allNames().length>0&&(a=new PushButtonMorph(null,function(){var t=new MenuMorph(u.deleteVariable,null,u);u.variables.allNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(u.world())},"删除一个变量"),a.userMenu=s,a.selector="deleteVariable",a.showHelp=BlockMorph.prototype.showHelp,l.push(a)),l.push("-"),h=this.variables.allNames(),h.length>0&&(h.forEach(function(t){l.push(i(t)),l.push(o(t))}),l.push("-")),l.push(e("doSetVar")),l.push(e("doChangeVar")),l.push(e("doShowVar")),l.push(e("doHideVar")),l.push("="),l.push(e("reportNewList")),l.push("-"),l.push(e("reportCONS")),l.push(e("reportListItem")),l.push(e("reportCDR")),l.push("-"),l.push(e("reportListLength")),l.push(e("reportListContainsItem")),l.push("-"),l.push(e("doAddToList")),l.push(e("doDeleteFromList")),l.push(e("doInsertInList")),l.push(e("doReplaceInList")),this.world().isDevMode&&(l.push("-"),c=new TextMorph(localize("development mode \ndebugging primitives:")),c.fontSize=9,c.setColor(this.paletteTextColor),l.push(c),l.push("-"),l.push(e("reportMap")),l.push("-"),l.push(e("doForEach"))),l.push("="),StageMorph.prototype.enableCodeMapping&&(l.push(e("doMapCodeOrHeader")),l.push(e("doMapStringCode")),l.push(e("doMapListCode")),l.push("-"),l.push(e("reportMappedCode")),l.push("=")),a=new PushButtonMorph(null,function(){var t=u.parentThatIsA(IDE_Morph),e=u.parentThatIsA(StageMorph);new BlockDialogMorph(null,function(o){""!==o.spec&&(o.isGlobal?e.globalBlocks.push(o):u.customBlocks.push(o),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(o,u).popUp())},u).prompt("添加一个程序块",null,u.world())},"添加一个程序块"),a.userMenu=s,a.selector="addCustomBlock",a.showHelp=BlockMorph.prototype.showHelp,l.push(a)),l},SpriteMorph.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t];
},SpriteMorph.prototype.freshPalette=function(t){var e,o=new ScrollFrameMorph(null,null,this.sliderColor),r=SyntaxElementMorph.prototype.fontSize,i=0,s=5,n=0,p=!1,h=this,a=this.parentThatIsA(StageMorph),c=Morph.prototype.trackChanges;return Morph.prototype.trackChanges=!1,o.owner=this,o.padding=r/2,o.color=SpriteMorph.prototype.paletteColor,o.growth=new Point(0,MorphicPreferences.scrollBarSize),o.userMenu=function(){function e(){var e=SpriteMorph.prototype.blocks,o=StageMorph.prototype.hiddenPrimitives;return Object.keys(o).some(function(o){return!isNil(e[o])&&(e[o].category===t||contains(i[t]||[],o))})}var o=new MenuMorph,r=this.parentThatIsA(IDE_Morph),i={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return e()&&o.addItem("show primitives",function(){var e=StageMorph.prototype.hiddenPrimitives,o=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(e){o[e]&&o[e].category===t&&delete StageMorph.prototype.hiddenPrimitives[e]}),(i[t]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),r.flushBlocksCache(t),r.refreshPalette()}),o},e=this.blocksCache[t],e||(e=h.blockTemplates(t),this.isCachingPrimitives&&(h.blocksCache[t]=e)),e.forEach(function(t){if(null!==t)if("-"===t){if(p)return;s+=.8*r,p=!0}else if("="===t){if(p)return;s+=1.6*r,p=!0}else"#"===t?(i=0,s=n):(p=!1,0===i&&(s+=.3*r),t.setPosition(new Point(i,s)),o.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(i=t.right()+r/2,n=t.bottom()):(t.fixLayout&&t.fixLayout(),i=0,s+=t.height()))}),a&&(s+=1.6*r,a.globalBlocks.forEach(function(e){var n;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(n=e.templateInstance(),s+=.3*r,n.setPosition(new Point(i,s)),o.addContents(n),i=0,s+=n.height())})),s+=1.6*r,this.customBlocks.forEach(function(e){var n;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(n=e.templateInstance(),s+=.3*r,n.setPosition(new Point(i,s)),o.addContents(n),i=0,s+=n.height())}),o.scrollX(o.padding),o.scrollY(o.padding),Morph.prototype.trackChanges=c,o},SpriteMorph.prototype.blocksMatching=function(t,e){function o(t){var e=BlockMorph.prototype.parseSpec(t),o=e.filter(function(t){return 0!==t.indexOf("%")});return o.join(" ")}function r(t,e,o){for(var r=String(t);r.length<e;)r=o+r;return r}function i(t,o){var i,s=" "+t,n=s.indexOf(o);return-1===n?-1:(i=" "===s.charAt(n-1),e&&!i?-1:(i?"1":"2")+r(n,4,"0"))}function s(t){var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}var n,p=[],h=this,a=t.toLowerCase(),c=this.parentThatIsA(StageMorph);return[this.customBlocks,c.globalBlocks].forEach(function(t){t.forEach(function(t){var e=localize(t.blockSpec()).toLowerCase(),r=i(o(e),a);-1!==r&&p.push([t.templateInstance(),r+"1"])})}),n=SpriteMorph.prototype.blocks,Object.keys(n).forEach(function(t){if(!StageMorph.prototype.hiddenPrimitives[t]){var e=n[t],r=localize(e.spec).toLowerCase(),c=i(o(r),a);-1===c||e.dev||e.only&&e.only!==h.constructor||p.push([s(t),c+"2"])}}),p.sort(function(t,e){return t[1]<e[1]?-1:1}),p.map(function(t){return t[0]})},SpriteMorph.prototype.searchBlocks=function(){function t(t){var e=Morph.prototype.trackChanges,r=n.contents.left()+5,i=s.bottom()+o;Morph.prototype.trackChanges=!1,n.contents.children=[n.contents.children[0]],t.forEach(function(t){t.setPosition(new Point(r,i)),n.addContents(t),i+=t.height(),i+=.3*o}),Morph.prototype.trackChanges=e,n.changed()}var e=this,o=SyntaxElementMorph.prototype.fontSize,r=this.parentThatIsA(IDE_Morph),i="",s=new InputFieldMorph(""),n=r.createPalette("forSearch");n.owner=this,n.color=e.paletteColor,n.contents.color=e.paletteColor,n.addContents(s),s.drawNew(),s.setWidth(r.logo.width()-30),s.contrast=90,s.setPosition(n.contents.topLeft().add(new Point(10,10))),s.drawNew(),n.accept=function(){var o=s.getValue();o.length>0&&t(e.blocksMatching(o))},n.reactToKeystroke=function(){var o=s.getValue();o!==i&&(i=o,t(e.blocksMatching(o,o.length<2)))},s.cancel=function(){r.refreshPalette(),r.palette.adjustScrollBars()},r.fixLayout("refreshPalette"),s.edit()},SpriteMorph.prototype.addVariable=function(t,e){var o=this.parentThatIsA(IDE_Morph);e?(this.variables.parentFrame.addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(t){var e=this.parentThatIsA(IDE_Morph);this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.addCostume=function(t){t.name||(t.name="造型",++this.costumeNum),this.costumes.add(t)},SpriteMorph.prototype.wearCostume=function(t){var e=this.xPosition?this.xPosition():null,o=this.yPosition?this.yPosition():null,r=this.isWarped;r&&this.endWarp(),this.changed(),this.costume=t,this.drawNew(),this.changed(),r&&this.startWarp(),null!==e&&this.silentGotoXY(e,o,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now(),IDEMorph&&IDEMorph.corralHtml&&IDEMorph.corralHtml.el&&IDEMorph.corralHtml.el.dispatchEvent(new CustomEvent("wearcostume"))},SpriteMorph.prototype.getCostumeIdx=function(){return this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume),t>-1&&(t+=1,t>e.length-1&&(t=0),this.wearCostume(e[t])))},SpriteMorph.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume),t>-1&&(t-=1,0>t&&(t=e.length-1),this.wearCostume(e[t])))},SpriteMorph.prototype.doSwitchToCostume=function(t){if(t instanceof Costume)return void this.wearCostume(t);var e,o,r=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],t instanceof Array?t[0]:null))o=null;else{if(-1===t)return void this.doWearPreviousCostume();o=detect(r,function(e){return e.name===t}),null===o&&(e=parseFloat(t),o=0===e?null:r[e-1]||null)}this.wearCostume(o)},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(t,e){this.sounds.add(new Sound(t,e))},SpriteMorph.prototype.playSound=function(t){var e,o,r=this.parentThatIsA(StageMorph);return isNaN(t)?e=detect(this.sounds.asArray(),function(e){return e.name===t}):t<this.sounds.contents.length&&(e=this.sounds.contents[t]),e?(o=e.play(),r&&(r.activeSounds.push(o),r.activeSounds=r.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),o):void 0},SpriteMorph.prototype.reportSounds=function(){return this.sounds},SpriteMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this);return t&&t.isAppMode?e:(e.addItem("duplicate","duplicate"),e.addItem("delete","remove"),e.addLine(),this.anchor&&e.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor"),this.parts.length&&e.addItem("detach all parts","detachAllParts"),e)},SpriteMorph.prototype.exportSprite=function(){if(!this.isClone){var t=this.parentThatIsA(IDE_Morph);t&&t.exportSprite(this)}},SpriteMorph.prototype.addTeamSprite=function(){function t(t){var o=new CDNUpload;o.getToken(r.costume.src,e,{src:t.src,name:t.name,thumbnail:o.url,img:t.src})}function e(e){e.thumbnail&&e.thumbnail.length>100?t(e):(e.thumbnail||(e.thumbnail=e.src,e.src=e.img),Backpack.addItem({name:e.name,url:e.src,thumbnail:e.thumbnail}))}if(!this.isClone){var o=this.parentThatIsA(IDE_Morph),r=this;if(o){var i=o.serializer.serialize(this.allParts()),s=new Blob(['<sprites app="'+o.serializer.app+'" version="'+o.serializer.version+'">'+i+"</sprites>"]),n=(URL.createObjectURL(s),new CDNUpload);n.getToken(s,e,{src:n.url,name:this.name,thumbnail:this.costume.src},"fileType")}}},SpriteMorph.prototype.edit=function(){var t=this.parentThatIsA(IDE_Morph);t&&!t.isAppMode&&t.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var t=this.parentThatIsA(StageMorph);t&&(this.keepWithin(t),t.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this)},SpriteMorph.prototype.remove=function(){var t=this.parentThatIsA(IDE_Morph),e=this;t&&confirmDialog.build("确认删除",'确认要删除角色"'+e.name+'"吗？',function(o){o&&t.removeSprite(e)},{isHideCancel:!0})},SpriteMorph.prototype.createClone=function(){var t=this.parentThatIsA(StageMorph);t&&t.cloneCount<=300&&this.fullCopy().clonify(t)},SpriteMorph.prototype.clonify=function(t){var e;this.parts.forEach(function(e){e.clonify(t)}),t.cloneCount+=1,this.cloneOriginName=this.isClone?this.cloneOriginName:this.name,this.isClone=!0,this.name="",t.add(this),e=this.allHatBlocksFor("__clone__init__"),e.forEach(function(e){t.threads.startProcess(e,t.isThreadSafe)})},SpriteMorph.prototype.removeClone=function(){this.isClone&&(this.parent.threads.stopAllForReceiver(this),this.destroy(),this.parent.cloneCount-=1)},SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this),this.parts.forEach(function(t){t.hide()});this.parentThatIsA(IDE_Morph)},SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this),this.parts.forEach(function(t){t.show()});this.parentThatIsA(IDE_Morph)},SpriteMorph.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t)||(this.color=t.copy(),this.drawNew(),this.gotoXY(e,o))},SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]},SpriteMorph.prototype.setHue=function(t){var e=this.color.hsv(),o=this.xPosition(),r=this.yPosition();e[0]=Math.max(Math.min(+t||0,100),0)/100,e[1]=1,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,r)},SpriteMorph.prototype.changeHue=function(t){this.setHue(this.getHue()+(+t||0))},SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]},SpriteMorph.prototype.setBrightness=function(t){var e=this.color.hsv(),o=this.xPosition(),r=this.yPosition();e[1]=1,e[2]=Math.max(Math.min(+t||0,100),0)/100,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,r)},SpriteMorph.prototype.changeBrightness=function(t){this.setBrightness(this.getBrightness()+(+t||0))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goBack=function(t){var e,o=+t||0;return this.parent?(e=this.parent.children.indexOf(this),o>e?null:(this.parent.removeChild(this),this.parent.children.splice(e-o,null,this),void this.parent.changed())):null},SpriteMorph.prototype.overlappingImage=function(t){var e=this.bounds.intersect(t.bounds),o=newCanvas(e.extent()),r=o.getContext("2d");return e.width()<1||e.height()<1?newCanvas(new Point(1,1)):(r.drawImage(this.image,this.left()-e.left(),this.top()-e.top()),r.globalCompositeOperation="source-in",r.drawImage(t.image,t.left()-e.left(),t.top()-e.top()),o)},SpriteMorph.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.isWarped;o&&this.endWarp(),e.save(),e.scale(1/t.scale,1/t.scale),e.drawImage(this.image,this.left()-t.left(),this.top()-t.top()),e.restore(),this.changed(),o&&this.startWarp()},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},SpriteMorph.prototype.getScale=function(){return 100*this.scale},SpriteMorph.prototype.setScale=function(t){var e,o,r=this.xPosition(),i=this.yPosition(),s=this.isWarped;s&&this.endWarp(),e=(+t||0)/100,o=e/this.nestingScale,this.nestingScale=e,this.scale=Math.max(e,.01),this.changed(),this.drawNew(),this.changed(),s&&this.startWarp(),this.silentGotoXY(r,i,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var e=t.xPosition()-r,s=t.yPosition()-i;t.setScale(100*t.scale*o),t.silentGotoXY(r+e*o,i+s*o)})},SpriteMorph.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},SpriteMorph.prototype.graphicsChanged=function(){var t=this;return Object.keys(this.graphicsValues).some(function(e){return t.graphicsValues[e]<0||t.graphicsValues[e]>0})},SpriteMorph.prototype.applyGraphicsEffects=function(t){function e(t,e){var o,r,i,s;if(0!==e)for(o=0;o<t.length;o+=4)r=255-t[o],i=255-t[o+1],s=255-t[o+2],t[o]<r?t[o]+=e:t[o]>r&&(t[o]-=e),t[o+1]<i?t[o+1]+=e:t[o+1]>i&&(t[o+1]-=e),t[o+2]<s?t[o+2]+=e:t[o+2]>s&&(t[o+2]-=e);return t}function o(t,e){var o;if(0!==e)for(o=0;o<t.length;o+=4)t[o]+=e,t[o+1]+=e,t[o+2]+=e;return t}function r(t,e){var o;if(0!==e)for(o=0;o<t.length;o+=4)t[o]+=127*Math.sin(o*e)+128,t[o+1]+=127*Math.sin(o*e)+128,t[o+2]+=127*Math.sin(o*e)+128;return t}function i(t,e){var o;if(0!==e)for(o=0;o<t.length;o+=4)t[o]=t[o*e],t[o+1]=t[o*e+1],t[o+2]=t[o*e+2],t[o+3]=t[o*e+3];return t}function s(t,e){var o;if(0!==e)for(o=0;o<t.length;o+=4){var r,i,s;s=Math.max(t[o],Math.max(t[o+1],t[o+2]));var n=s-Math.min(t[o],Math.min(t[o+1],t[o+2]));0==n?r=i=0:(t[o]==s?r=60*((t[o+1]-t[o+2])/n):t[o+1]==s?r=120+60*((t[o+2]-t[o])/n):t[o+2]==s&&(r=240+60*((t[o]-t[o+1])/n)),i=n/s),r=(r+e)%360,0>r&&(r+=360),i=Math.max(0,Math.min(i,1)),s=Math.max(s,1);var p=new Color;p.set_hsv(r,i,s),t[o]=p.r,t[o+1]=p.g,t[o+2]=p.b}return t}function n(e,o){if(0!==o){var r,i=.5,s=.5,n=t.width*i,p=t.height*s,h=t.width>t.height?t.height/2:t.width/2;try{r=new Uint8ClampedArray(e)}catch(a){r=new Uint8Array(e)}for(var c=0;c<e.length;c+=4){var l=c/4%t.width,u=Math.floor(c/4/t.width),d=n-l,g=p-u,y=Math.sqrt(d*d+g*g),f=c;if(h>=y)var M=Math.round(n-d*Math.sin(y/(o+h)*Math.PI/2)),m=Math.round(p-g*Math.sin(y/(o+h)*Math.PI/2)),f=4*(m*t.width+M);e[c]=r[f],e[c+1]=r[f+1],e[c+2]=r[f+2],e[c+3]=r[f+3]}}return e}function p(e,o){if(0!==o){var r,i,s,n,p,h,c,l,u=3.141592653,d=o/180*u,g=.5,y=.5,f=t.width>t.height?t.height/2:t.width/2,M=t.width*g,m=t.height*y,S=f*f;try{r=new Uint8ClampedArray(e)}catch(b){r=new Uint8Array(e)}for(var w=0;w<e.length;w+=4)if(ii=w/4%t.width,jj=Math.floor(w/4/t.width),i=jj-M,s=ii-m,n=i*i+s*s,n>S)p=jj,h=ii;else if(distance=Math.sqrt(n),a=Math.atan2(s,i)+d*(f-distance)/f,p=M+distance*Math.cos(a),h=m+distance*Math.sin(a),!(0>=p||p>=t.width||h>=t.height||0>=h)){c=Math.floor(p),l=Math.floor(h);for(var C=0;4>C;C++)e[C+w]=r[C+4*(c*t.width+l)]}}return e}var h,c,l,u;return this.graphicsChanged()&&(h=t.getContext("2d"),c=h.getImageData(0,0,t.width,t.height),l=c.data,l=p(l,this.graphicsValues.whirl),l=n(l,this.graphicsValues.fisheye),l=e(l,this.graphicsValues.negative),l=o(l,this.graphicsValues.brightness),l=r(l,this.graphicsValues.comic),l=i(l,this.graphicsValues.duplicate),l=s(l,this.graphicsValues.confetti),u=h.createImageData(c),u.data.set(l),h.putImageData(u,0,0)),t},SpriteMorph.prototype.setEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[o]=+e,this.drawNew(),this.changed()},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},SpriteMorph.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},SpriteMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},SpriteMorph.prototype.doThink=function(t){this.bubble(t,!0)},SpriteMorph.prototype.bubble=function(t,e,o){var r,i=this.parentThatIsA(StageMorph);this.stopTalking(),""===t||isNil(t)||(r=new SpriteBubbleMorph(t,i?i.scale:1,e,o),this.add(r),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(StageMorph),e=t?t.scale:1,o=this.talkBubble(),r=this.center().y;if(!o)return null;for(o.show(),o.isPointingRight||(o.isPointingRight=!0,o.drawNew(),o.changed()),o.setLeft(this.right()),o.setBottom(this.top());!this.isTouching(o)&&o.bottom()<r;)o.silentMoveBy(new Point(-1,1).scaleBy(e));return t?(o.right()>t.right()&&(o.isPointingRight=!1,o.drawNew(),o.setRight(this.center().x)),o.keepWithin(t),void o.changed()):null},SpriteMorph.prototype.prepareToBeGrabbed=function(t){this.removeShadow(),this.recordLayers(),this.bounds.containsPoint(t.position())||this.setCenter(t.position()),this.addShadow(),IDEMorph&&IDEMorph.categories&&(IDEMorph.categories.acceptsDrops=!1)},SpriteMorph.prototype.justDropped=function(){this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped"),IDEMorph&&IDEMorph.categories&&(IDEMorph.categories.acceptsDrops=!0)},SpriteMorph.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,r=this.parent.scale,i=this.parent.penTrails().getContext("2d"),s=t.subtract(o).divideBy(r),n=e.subtract(o).divideBy(r),p=s.multiplyBy(r).add(o),h=n.multiplyBy(r).add(o),a=p.rectangle(h).expandBy(Math.max(this.size*r/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(i.lineWidth=this.size,i.strokeStyle=this.color.toString(),this.useFlatLineEnds?(i.lineCap="butt",i.lineJoin="miter"):(i.lineCap="round",i.lineJoin="round"),i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(n.x,n.y),i.stroke(),this.isWarped===!1&&this.world().broken.push(a))},SpriteMorph.prototype.moveBy=function(t,e){var o=this.isDown&&!e&&this.parent?this.rotationCenter():null,r=this.parentThatIsA(IDE_Morph),i=this.parentThatIsA(StageMorph);if(i){var s=Math.min(this.width()*this.scale/2/i.scale,30),n=Math.min(this.height()*this.scale/2/i.scale,30);this.bounds.origin.x+t.x+s*i.scale>i.bounds.corner.x?t.x=i.bounds.corner.x-this.bounds.origin.x-s*i.scale:this.bounds.corner.x-s*i.scale+t.x<i.bounds.origin.x&&(t.x=i.bounds.origin.x-this.bounds.corner.x+s*i.scale),this.bounds.origin.y+n*i.scale+t.y>i.bounds.corner.y?t.y=i.bounds.corner.y-this.bounds.origin.y-n*i.scale:this.bounds.corner.y-n*i.scale+t.y<i.bounds.origin.y&&(t.y=i.bounds.origin.y-this.bounds.corner.y+n*i.scale)}this.changed(),this.bounds=this.bounds.translateBy(t),this.changed(),r&&!playermode&&r.refreshSpriteCoordinate(),this.children.forEach(function(e){e.moveBy(t)}),this.changed(),o&&this.drawLine(o,this.rotationCenter()),e||this.parts.forEach(function(e){e.moveBy(t)}),IDEMorph&&IDEMorph.corralHtml&&IDEMorph.corralHtml.el&&IDEMorph.corralHtml.el.dispatchEvent(new CustomEvent("spritemove"))},SpriteMorph.prototype.slideBackTo=function(t,e){var o=e||5,r=t.origin.position().add(t.position),i=-(this.left()-r.x)/o,s=-(this.top()-r.y)/o,n=0,p=this.step,h=this.fps,a=this;this.fps=0,this.step=function(){a.moveBy(new Point(i,s)),n+=1,n===o&&(t.origin.add(a),t.origin.reactToDropOf&&t.origin.reactToDropOf(a),a.step=p,a.fps=h)}},SpriteMorph.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},SpriteMorph.prototype.nestingBounds=function(){var t=this.bounds;return!this.costume&&this.penBounds&&(t=this.penBounds.translateBy(this.position())),this.parts.forEach(function(e){e.isVisible&&(t=t.merge(e.nestingBounds()))}),t},Morph.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());(0!==o.x||0!==o.y)&&this.moveBy(o,e)},SpriteMorph.prototype.forward=function(t){var e,o=t*this.parent.scale||0;e=o>=0?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.setPosition(e),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(t){var e=this.xPosition(),o=this.yPosition(),r=+t||0,i=r-this.heading;this.changed(),SpriteMorph.uber.setHeading.call(this,r),this.silentGotoXY(e,o,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var r=new Point(t.xPosition(),t.yPosition()),s=r.rotateBy(radians(i),new Point(e,o));t.rotatesWithAnchor&&t.turn(i),t.gotoXY(s.x,s.y)})},SpriteMorph.prototype.setDraggable=function(t){var e;switch(t){case"可拖动":e=!0;break;case"不可拖动":e=!1;break;case 0:e=!1;break;case"0":e=!1;break;case!1:e=!1;break;default:e=!0}this.isDraggable=e,IDEMorph.SpriteBarVM&&IDEMorph.currentSprite==this&&(IDEMorph.SpriteBarVM.draggable=this.isDraggable)},SpriteMorph.prototype.faceToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,r=(e-this.yPosition())*this.parent.scale,i=Math.abs(o)<.001?0>r?90:270:Math.round((o>=0?0:180)-57.2957795131*Math.atan(r/o));this.setHeading(i+90)},SpriteMorph.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},SpriteMorph.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},SpriteMorph.prototype.xPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.heading},SpriteMorph.prototype.penSize=function(){return this.size},SpriteMorph.prototype.gotoXY=function(t,e,o){var r,i,s,n=this.parentThatIsA(StageMorph),p=this.costume?this.rotationOffset:this.extent().divideBy(2);r=n.center().x+(+t||0)*n.scale,i=n.center().y-(+e||0)*n.scale,s=new Point(r,i).subtract(p);var h=this.parentThatIsA(IDE_Morph);h&&!playermode&&h.refreshSpriteCoordinate(),this.setPosition(s,o),this.positionTalkBubble()},SpriteMorph.prototype.silentGotoXY=function(t,e,o){var r=this.isDown;this.isDown=!1,this.gotoXY(t,e,o),this.isDown=r},SpriteMorph.prototype.setXPosition=function(t){this.gotoXY(+t||0,this.yPosition())},SpriteMorph.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},SpriteMorph.prototype.setYPosition=function(t){this.gotoXY(this.xPosition(),+t||0)},SpriteMorph.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},SpriteMorph.prototype.glide=function(t,e,o,r,i){var s,n,p;n=new Point(e,o),s=Math.max(Math.min(r/t,1),0),p=i.add(n.subtract(i).multiplyBy(s)),this.gotoXY(p.x,p.y)},SpriteMorph.prototype.bounceOffEdge=function(){var t,e,o=this.parentThatIsA(StageMorph),r=this.nestingBounds();return o?o.bounds.containsRectangle(r)?null:(t=Math.cos(radians(this.heading-90)),e=-Math.sin(radians(this.heading-90)),r.left()<o.left()&&(t=Math.abs(t)),r.right()>o.right()&&(t=-Math.abs(t)),r.top()<o.top()&&(e=-Math.abs(e)),r.bottom()>o.bottom()&&(e=Math.abs(e)),this.setHeading(degrees(Math.atan2(-e,t))+90),this.setPosition(this.position().add(r.amountToTranslateWithin(o.bounds))),void this.positionTalkBubble()):null},SpriteMorph.prototype.allMessageNames=function(){var t=[];return this.scripts.allChildren().forEach(function(e){var o;e.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],e.selector)&&(o=e.inputs()[0].evaluate(),isString(o)&&""!==o&&(contains(t,o)||t.push(o)))}),t},SpriteMorph.prototype.allHatBlocksFor=function(t){return"number"==typeof t&&(t=t.toString()),this.scripts.children.filter(function(e){var o;if(e.selector){if("receiveMessage"===e.selector)return o=e.inputs()[0].evaluate(),o===t||o instanceof Array;if("receiveGo"===e.selector)return"__shout__go__"===t;if("receiveOnClone"===e.selector)return"__clone__init__"===t}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(t){return this.scripts.children.filter(function(e){return e.selector&&"receiveKey"===e.selector?e.inputs()[0].evaluate()[0]===t:!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(t){return this.scripts.children.filter(function(e){return e.selector&&"receiveInteraction"===e.selector?e.inputs()[0].evaluate()[0]===t:!1})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.receiveUserInteraction=function(t){var e,o=this.parentThatIsA(StageMorph),r=[];if(o)return e=this.allHatBlocksForInteraction(t),e.forEach(function(t){r.push(o.threads.startProcess(t,o.isThreadSafe))}),r},SpriteMorph.prototype.mouseDoubleClick=function(){this.isClone||this.edit()},SpriteMorph.prototype.getTimer=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTimer():0},SpriteMorph.prototype.getTempo=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var t=this.parentThatIsA(StageMorph);return t?t.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var t=this.parentThatIsA(StageMorph);return t?t.threads.processes.length:0},SpriteMorph.prototype.findVariableWatcher=function(t){var e=this.parentThatIsA(StageMorph),o=this;return null===e?null:detect(e.children,function(e){return e instanceof WatcherMorph&&(e.target===o.variables||e.target===o.variables.parentFrame)&&e.getter===t})},SpriteMorph.prototype.toggleVariableWatcher=function(t,e){var o,r,i=this.parentThatIsA(StageMorph);return null===i?null:(o=this.findVariableWatcher(t),null!==o?void(o.isVisible?o.hide():(o.show(),o.fixLayout(),o.keepWithin(i))):(isNil(e)&&(e=contains(this.variables.parentFrame.names(),t)),o=new WatcherMorph(t,this.blockColor.variables,e?this.variables.parentFrame:this.variables,t),o.setPosition(i.position().add(10)),r=i.watchers(o.left()),r.length>0&&o.setTop(r[r.length-1].bottom()),i.add(o),o.fixLayout(),void o.keepWithin(i)))},SpriteMorph.prototype.showingVariableWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null===o?!1:(e=this.findVariableWatcher(t),e?e.isVisible:!1)},SpriteMorph.prototype.deleteVariableWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null===o?null:(e=this.findVariableWatcher(t),void(null!==e&&e.destroy()))},SpriteMorph.prototype.toggleWatcher=function(t,e,o){var r,i,s=this.parentThatIsA(StageMorph);if(s){if(r=this.watcherFor(s,t))return void(r.isVisible?r.hide():(r.show(),r.fixLayout(),r.keepWithin(s)));r=new WatcherMorph(e,o,WatcherMorph.prototype.isGlobal(t)?s:this,t),r.setPosition(s.position().add(10)),i=s.watchers(r.left()),i.length>0&&r.setTop(i[i.length-1].bottom()),s.add(r),r.fixLayout(),r.keepWithin(s)}},SpriteMorph.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null===o?!1:(e=this.watcherFor(o,t),e?e.isVisible:!1)},SpriteMorph.prototype.watcherFor=function(t,e){var o=this;return detect(t.children,function(r){return r instanceof WatcherMorph&&r.getter===e&&r.target===(r.isGlobal(e)?t:o)})},SpriteMorph.prototype.deleteAllBlockInstances=function(t){this.allBlockInstances(t).forEach(function(t){t.deleteBlock()}),this.customBlocks.forEach(function(t){t.body&&t.body.expression.isCorpse&&(t.body=null)})},SpriteMorph.prototype.allBlockInstances=function(t){var e,o,r,i=[];return t.isGlobal?(e=this.parentThatIsA(StageMorph),o=e.children.filter(function(t){return t instanceof SpriteMorph}),o.push(e),o.forEach(function(e){i=i.concat(e.allLocalBlockInstances(t))}),r=[],e.globalBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&r.push(e)})}),i.concat(r)):this.allLocalBlockInstances(t)},SpriteMorph.prototype.allLocalBlockInstances=function(t){var e,o,r,i,s;return e=this.scripts.allChildren().filter(function(e){return e.definition&&e.definition===t}),o=[],this.customBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&o.push(e)})}),r=this.allEditorBlockInstances(t),i=this.paletteBlockInstance(t),s=e.concat(o).concat(r),i&&s.push(i),s},SpriteMorph.prototype.allEditorBlockInstances=function(t){var e=[],o=this.world();return o?(this.world().children.forEach(function(o){o instanceof BlockEditorMorph&&o.body.contents.allChildren().forEach(function(o){o.isPrototype||o instanceof PrototypeHatBlockMorph||o.definition!==t||e.push(o)})}),e):[]},SpriteMorph.prototype.paletteBlockInstance=function(t){var e=this.parentThatIsA(IDE_Morph);return e?detect(e.palette.contents.children,function(e){return e.definition===t}):null},SpriteMorph.prototype.usesBlockInstance=function(t){var e,o=detect(this.scripts.allChildren(),function(e){return e.definition&&e.definition===t});return o?!0:(e=[],this.customBlocks.forEach(function(o){o.body&&o.body.expression.allChildren().forEach(function(o){o.definition&&o.definition===t&&e.push(o)})}),e.length>0)},SpriteMorph.prototype.doubleDefinitionsFor=function(t){var e,o,r,i=t.blockSpec();if(t.isGlobal){if(r=this.parentThatIsA(StageMorph),!r)return[];e=r.globalBlocks}else e=this.customBlocks;return o=e.indexOf(t),-1===o?[]:e.filter(function(t,e){return t.blockSpec()===i&&e!==o})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(t){var e,o,r=this.doubleDefinitionsFor(t),i=this;r.forEach(function(e){i.allBlockInstances(e).forEach(function(e){e.definition=t,e.refresh()})}),t.isGlobal?(e=this.parentThatIsA(StageMorph),e.globalBlocks=e.globalBlocks.filter(function(t){return!contains(r,t)})):this.customBlocks=this.customBlocks.filter(function(t){return!contains(r,t)}),o=this.parentThatIsA(IDE_Morph),o&&(o.flushPaletteCache(),o.refreshPalette())},SpriteMorph.prototype.thumbnail=function(t){var e=this.image,o=Math.min(t.x/e.width,t.y/e.height),r=(t.x-e.width*o)/2,i=(t.y-e.height*o)/2,s=newCanvas(t),n=s.getContext("2d");return n.save(),e.width&&e.height&&(n.scale(o,o),n.drawImage(e,Math.floor(r/o),Math.floor(i/o))),s},SpriteMorph.prototype.fullThumbnail=function(t){var e=this.thumbnail(t),o=e.getContext("2d"),r=t.divideBy(3),i=0;for(o.restore(),this.anchor&&o.drawImage(this.anchor.thumbnail(r),0,0),i=0;3>i;i+=1)this.parts[i]&&o.drawImage(this.parts[i].thumbnail(r),i*r.x,t.y-r.y);return e},SpriteMorph.prototype.booleanMorph=function(t){var e=new ReporterBlockMorph(!0);return e.color=SpriteMorph.prototype.blockColor.operators,e.setSpec(localize(t.toString())),e},SpriteMorph.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,t.anchor=this,this.allParts().forEach(function(t){t.nestingScale=t.scale}),t.version=e},SpriteMorph.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);-1!==o&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},SpriteMorph.prototype.detachAllParts=function(){var t=Date.now();this.parts.forEach(function(e){e.anchor=null,e.version=t}),this.parts=[],this.version=t},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var t=[this];return this.parts.forEach(function(e){t=t.concat(e.allParts())}),t},SpriteMorph.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},SpriteMorph.prototype.recordLayers=function(){var t=this.parentThatIsA(StageMorph);return t?(this.layers=this.allParts(),this.layers.forEach(function(t){var e=t.talkBubble();e&&e.hide()}),void this.layers.sort(function(e,o){return t.children.indexOf(e)<t.children.indexOf(o)?-1:1})):void(this.layerCache=null)},SpriteMorph.prototype.restoreLayers=function(){this.layers&&this.layers.length>1&&this.layers.forEach(function(t){t.comeToFront(),t.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),
o&&this.hide(),e},SpriteMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},SpriteMorph.prototype.highlight=function(t,e){var o,r=new SpriteHighlightMorph,i=this.bounds,s=e;return r.setExtent(i.extent().add(2*s)),r.color=t,r.image=this.highlightImage(t,e),o=r.image.getContext("2d"),o.drawImage(this.highlightImage(new Color(255,255,255),4),e-4,e-4),o.drawImage(this.highlightImage(new Color(50,50,50),2),e-2,e-2),o.drawImage(this.highlightImage(new Color(255,255,255),1),e-1,e-1),r.setPosition(i.origin.subtract(new Point(s,s))),r},SpriteMorph.prototype.highlightImage=function(t,e){var o,r,i,s,n;return o=this.extent(),r=this.image,i=newCanvas(o.add(2*e)),s=i.getContext("2d"),s.drawImage(r,0,0),s.drawImage(r,e,0),s.drawImage(r,2*e,0),s.drawImage(r,2*e,e),s.drawImage(r,2*e,2*e),s.drawImage(r,e,2*e),s.drawImage(r,0,2*e),s.drawImage(r,0,e),s.globalCompositeOperation="destination-out",s.drawImage(r,e,e),n=newCanvas(o.add(2*e)),s=n.getContext("2d"),s.drawImage(i,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=t.toString(),s.fillRect(0,0,n.width,n.height),n},SpriteMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof SpriteHighlightMorph}),0!==t.length?t[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!contains(t.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(t,e){this.removeHighlight(),this.attachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(t,e){for(var o=t.indexOf("("),r=0>o?t:t.substring(0,o),i=1,s=r,n=this.costumes.asArray().filter(function(t){return t!==e}).map(function(t){return t.name});contains(n,s);)i+=1,s=r+"("+i+")";return s},SpriteMorph.prototype.doScreenshot=function(t,e){var o,r,i=this.parentThatIsA(StageMorph);e=this.newCostumeName(e),void 0!==t[0]&&("pen trails"===t[0]?(o=i.trailsCanvas,r=new Costume(o,e).copy()):"stage image"===t[0]&&(o=i.fullImageClassic(),r=new Costume(o,e)),this.addCostume(r))},SpriteHighlightMorph.prototype=new Morph,SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph,SpriteHighlightMorph.uber=Morph.prototype,StageMorph.prototype=new FrameMorph,StageMorph.prototype.constructor=StageMorph,StageMorph.uber=FrameMorph.prototype,StageMorph.prototype.defaultSize=new Point(310,450),StageMorph.prototype.dimensions=new Point(310,450),StageMorph.prototype.frameRate=0,StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives,StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.corner=5,StageMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,StageMorph.prototype.bubbleFontSize=18,StageMorph.prototype.init=function(t,e){this.name="舞台",this.threads=new ThreadManager,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.thumbnailKey=null,this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.costumeNum=1,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.graphicsValues={negative:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,brightness:0,color:0,comic:0,duplicate:0,confetti:0},StageMorph.uber.init.call(this),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(t){var e,o,r=t/this.scale,i=this.position(),s=Morph.prototype.trackChanges,n=this;1!==r&&(Morph.prototype.trackChanges=!1,this.scale=t,this.setExtent(this.dimensions.multiplyBy(t)),this.children.forEach(function(s){e=s.position().subtract(i),s.drawNew(),s.setPosition(e.multiplyBy(r).add(i),!0),s instanceof SpriteMorph?(o=s.talkBubble(),o&&(o.setScale(t),s.positionTalkBubble())):s instanceof StagePrompterMorph&&(n.scale<1?s.setWidth(n.width()-10):s.setWidth(n.dimensions.x-20),s.fixLayout(),s.setCenter(n.center()),s.setBottom(n.bottom()))}),Morph.prototype.trackChanges=s,this.changed())},StageMorph.prototype.drawNew=function(){var t;StageMorph.uber.drawNew.call(this),this.costume&&(t=this.image.getContext("2d"),t.scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image))},StageMorph.prototype.drawOn=function(t,e){var o,r,i,s,n,p,h,a,c,l,u;if(!this.isVisible)return null;if(o=e||this.bounds,r=o.intersect(this.bounds).round(),r.extent().gt(new Point(0,0))){if(i=this.position().neg(),s=r.copy().translateBy(i).round(),n=t.getContext("2d"),n.globalAlpha=this.alpha,a=s.left(),c=s.top(),p=Math.min(s.width(),this.image.width-a),h=Math.min(s.height(),this.image.height-c),1>p||1>h)return null;n.drawImage(this.image,s.left(),s.top(),p,h,r.left(),r.top(),p,h),l=p/this.scale,u=h/this.scale,n.save(),n.scale(this.scale,this.scale);try{n.drawImage(this.penTrails(),s.left()/this.scale,s.top()/this.scale,l,u,r.left()/this.scale,r.top()/this.scale,l,u)}catch(d){n.restore(),n.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}n.restore()}},StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions),this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var t,e=new Morph,o=this.penTrails();return e.bounds=this.bounds.copy(),e.image=newCanvas(this.extent()),t=e.image.getContext("2d"),t.drawImage(o,0,0,o.width,o.height,0,0,this.image.width,this.image.height),e},StageMorph.prototype.colorFiltered=function(t,e){var o,r,i,s,n,p=new Morph,h=new Point(Math.min(e.extent().x,this.extent().x),Math.min(e.extent().y,this.extent().y)),a=this.thumbnail(this.extent(),e);for(p.bounds=this.bounds.intersect(e.bounds),p.image=newCanvas(h),r=a.getContext("2d").getImageData(p.bounds.origin.x,p.bounds.origin.y,h.x,h.y),o=p.image.getContext("2d"),n=o.createImageData(h.x,h.y),s=0;s<h.x*h.y*4;s+=4)i=new Color(r.data[s],r.data[s+1],r.data[s+2]),i.eq(t)&&(n.data[s]=r.data[s],n.data[s+1]=r.data[s+1],n.data[s+2]=r.data[s+2],n.data[s+3]=255);return o.putImageData(n,0,0),p},StageMorph.prototype.watchers=function(t){return this.children.filter(function(e){return e instanceof WatcherMorph?t?e.left()===t:e.isVisible:!1})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){var t=Math.floor((Date.now()-this.timerStart)/100);return t/10},StageMorph.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},StageMorph.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""},StageMorph.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(t){return t instanceof SpriteMorph||t instanceof WatcherMorph||t instanceof ListWatcherMorph||t instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&t.object.anchor.detachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin))},StageMorph.prototype.step=function(){var t,e,o,r=this.world();if(null===r.keyboardReceiver&&(r.keyboardReceiver=this),null===r.currentKey&&(this.keyPressed=null),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped=t.isWarped,t.isWarped||t.startWarp())});Date.now()-this.lastTime<100;)this.threads.step();this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped||t.endWarp())}),this.changed()}else this.threads.step();t=Date.now(),e=t-this.lastWatcherUpdate,o=1e3/this.watcherUpdateFrequency-e,1>o&&(this.watchers().forEach(function(t){t.update()}),this.lastWatcherUpdate=Date.now())},StageMorph.prototype.developersMenu=function(){var t=this,e=StageMorph.uber.developersMenu.call(this);return e.addItem("stop",function(){t.threads.stopAll()},"terminate all running threads"),e},StageMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",(t.ctrlKey||t.metaKey)&&(o="ctrl enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},StageMorph.prototype.fireKeyEvent=function(t){var e=t.toLowerCase(),o=[],r=[],i=this.parentThatIsA(IDE_Morph),s=this;return this.keysPressed[e]=!0,"ctrl enter"===e?this.fireGreenFlagEvent():"ctrl f"===e?void(i.isAppMode||i.currentSprite.searchBlocks()):"ctrl n"===e?void(i.isAppMode||i.createNewProject()):"ctrl o"===e?void(i.isAppMode||i.openProjectsBrowser()):"ctrl s"===e?void(i.isAppMode||i.save()):"ctrl shift s"!==e?"esc"===e?this.fireStopAllEvent():(this.children.concat(this).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(o=o.concat(t.allHatBlocksForKey(e)))}),o.forEach(function(t){r.push(s.threads.startProcess(t,s.isThreadSafe))}),r):i.isAppMode?void 0:i.saveProjectsBrowser()},StageMorph.prototype.removePressedKey=function(t){delete this.keysPressed[t.toLowerCase()]},StageMorph.prototype.processKeyPress=function(t){nop(t)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){var t=[],e=[],o=(this.parentThatIsA(IDE_Morph),this);return world.worldCanvas.focus(),this.children.concat(this).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(e=e.concat(t.allHatBlocksFor("__shout__go__")))}),e.forEach(function(e){t.push(o.threads.startProcess(e,o.isThreadSafe))}),this.isRunning=!0,t},StageMorph.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),this.removeAllClones(),t&&t.nextSteps([nop,function(){}]),this.isRunning=!1},StageMorph.prototype.removeAllClones=function(){var t=this,e=this.children.filter(function(t){return t.isClone});e.forEach(function(e){t.threads.stopAllForReceiver(e),e.destroy()}),this.cloneCount=0},StageMorph.prototype.blockTemplates=function(t){function e(t){if(c.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e}function r(t){if(c.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){c.toggleWatcher(t,localize(e.spec),c.blockColor[e.category])},null,function(){return c.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){c.toggleVariableWatcher(t)},null,function(){return c.showingVariableWatcher(t)},null)}function s(t){t&&(c.variables.silentFind(t[0])?c.inform("that name is already in use"):(c.addVariable(t[0],t[1]),c.toggleVariableWatcher(t[0],t[1]),c.blocksCache[l]=null,c.paletteCache[l]=null,c.parentThatIsA(IDE_Morph).refreshPalette()))}var n,p,h,a=[],c=this,l=t||"motion";return"motion"===l?(h=new TextMorph(localize("Stage selected:\nno motion primitives")),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h)):"looks"===l?(a.push(e("show")),a.push(e("hide")),a.push("-"),a.push(e("doSwitchToCostume")),a.push(e("doWearNextCostume")),a.push("-"),a.push(e("bubble")),a.push(e("doSayFor")),a.push("-"),a.push(e("changeEffect")),a.push(e("setEffect")),a.push(e("clearEffects")),a.push("-"),a.push("-"),a.push(r("getCostumeIdx")),a.push(e("getCostumeIdx")),this.world().isDevMode&&(a.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h),a.push("-"),a.push(e("reportCostumes")),a.push("-"),a.push(e("log")),a.push(e("alert")),a.push("-"),a.push(e("doScreenshot")))):"sound"===l?(a.push(e("playSound")),a.push(e("doPlaySoundUntilDone")),a.push(e("doStopAllSounds")),a.push("-"),a.push(e("doRest")),a.push("-"),a.push(e("doPlayNote")),a.push("-"),a.push(e("doChangeTempo")),a.push(e("doSetTempo")),a.push(r("getTempo")),a.push(e("getTempo")),this.world().isDevMode&&(a.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h),a.push("-"),a.push(e("reportSounds")))):"pen"===l?a.push(e("clear")):"control"===l?(a.push(e("receiveGo")),a.push(e("receiveInteraction")),a.push(e("receiveMessage")),a.push(e("doWait")),a.push(e("doBroadcast")),a.push("-"),a.push(e("doForever")),a.push(e("doRepeat")),a.push(e("doUntil")),a.push("-"),a.push(e("doIf")),a.push(e("doIfElse")),a.push("-"),a.push(e("receiveKey")),a.push("-"),a.push(e("doWaitUntil")),a.push(e("doBroadcastAndWait")),a.push("-"),a.push(r("getLastMessage")),a.push(e("getLastMessage")),a.push("-"),a.push(e("doWarp")),a.push("-"),a.push(e("doReport")),a.push("-"),a.push(e("doStopThis")),a.push(e("doStopOthers")),a.push("-"),a.push(e("doRun")),a.push(e("fork")),a.push(e("evaluate")),a.push("-"),a.push(e("doCallCC")),a.push(e("reportCallCC")),a.push("-"),a.push(e("createClone")),a.push("-"),a.push(e("doPauseAll"))):"sensing"===l?(a.push(e("reportAttributeOf")),a.push("-"),a.push(e("doAsk")),a.push(r("getLastAnswer")),a.push(e("getLastAnswer")),a.push("-"),a.push(r("reportMouseX")),a.push(e("reportMouseX")),a.push(r("reportMouseY")),a.push(e("reportMouseY")),a.push(e("reportMouseDown")),a.push("-"),a.push(e("reportKeyPressed")),a.push("-"),a.push(e("doResetTimer")),a.push(r("getTimer")),a.push(e("getTimer")),a.push("-"),a.push(e("reportURL")),a.push("-"),a.push(e("reportIsFastTracking")),a.push(e("doSetFastTracking")),a.push("-"),a.push(e("reportDate")),this.world().isDevMode&&(a.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h),a.push("-"),a.push(r("reportThreadCount")),a.push(e("reportThreadCount")),a.push(e("colorFiltered")),a.push(e("reportStackSize")),a.push(e("reportFrameCount")))):"operators"===l?(a.push(e("reportEquals")),a.push(e("reportRandom")),a.push(e("reportJoinWords")),a.push(e("reportContains")),a.push("-"),a.push(e("reifyScript")),a.push(e("reifyReporter")),a.push(e("reifyPredicate")),a.push("#"),a.push("-"),a.push(e("reportSum")),a.push(e("reportDifference")),a.push(e("reportProduct")),a.push(e("reportQuotient")),a.push("-"),a.push(e("reportModulus")),a.push(e("reportRound")),a.push(e("reportMonadic")),a.push("-"),a.push(e("reportLessThan")),a.push(e("reportGreaterThan")),a.push("-"),a.push(e("reportAnd")),a.push(e("reportOr")),a.push(e("reportNot")),a.push("-"),a.push(e("reportTrue")),a.push(e("reportFalse")),a.push("-"),a.push(e("reportTextSplit")),a.push(e("reportLetter")),a.push(e("reportStringSize")),a.push("-"),a.push(e("reportUnicode")),a.push(e("reportUnicodeAsLetter")),a.push("-"),a.push(e("reportIsA")),a.push(e("reportIsIdentical")),a.push("-"),a.push(e("reportJSFunction")),this.world().isDevMode&&(a.push("-"),h=new TextMorph("development mode \ndebugging primitives:"),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h),a.push("-"),a.push(e("reportTypeOf")),a.push(e("reportTextFunction")))):"variables"===l&&(p=new PushButtonMorph(null,function(){new VariableDialogMorph(null,s,c).prompt("给变量起个名字吧",null,c.world())},"添加一个新的变量"),a.push(p),this.variables.allNames().length>0&&(p=new PushButtonMorph(null,function(){var t=new MenuMorph(c.deleteVariable,null,c);c.variables.allNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(c.world())},"删除一个变量"),a.push(p)),a.push("-"),n=this.variables.allNames(),n.length>0&&(n.forEach(function(t){a.push(i(t)),a.push(o(t))}),a.push("-")),a.push(e("doSetVar")),a.push(e("doChangeVar")),a.push(e("doShowVar")),a.push(e("doHideVar")),a.push(e("doDeclareVariables")),a.push("="),a.push(e("reportNewList")),a.push("-"),a.push(e("reportCONS")),a.push(e("reportListItem")),a.push(e("reportCDR")),a.push("-"),a.push(e("reportListLength")),a.push(e("reportListContainsItem")),a.push("-"),a.push(e("doAddToList")),a.push(e("doDeleteFromList")),a.push(e("doInsertInList")),a.push(e("doReplaceInList")),this.world().isDevMode&&(a.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),a.push(h),a.push("-"),a.push(e("reportMap")),a.push("-"),a.push(e("doForEach"))),a.push("="),StageMorph.prototype.enableCodeMapping&&(a.push(e("doMapCodeOrHeader")),a.push(e("doMapStringCode")),a.push(e("doMapListCode")),a.push("-"),a.push(e("reportMappedCode")),a.push("=")),p=new PushButtonMorph(null,function(){var t=c.parentThatIsA(IDE_Morph);new BlockDialogMorph(null,function(e){""!==e.spec&&(e.isGlobal?c.globalBlocks.push(e):c.customBlocks.push(e),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(e,c).popUp())},c).prompt("新建程序块",null,c.world())},"新建程序块"),a.push(p)),a},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this),o=16===this.world().currentKey,r=this;return t&&t.isAppMode?e:(e.addItem("编辑","edit"),e.addItem("显示所有","showAll"),o&&(e.addLine(),e.addItem("turn pen trails into new costume...",function(){var e=new Costume(r.trailsCanvas,Date.now().toString()).copy();t.currentSprite.addCostume(e),t.currentSprite.wearCostume(e),t.hasChangedMedia=!0},"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite",new Color(100,0,0))),e)},StageMorph.prototype.showAll=function(){var t=this;this.children.forEach(function(e){e.show(),e.keepWithin(t),e.fixLayout&&e.fixLayout()})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(t,e){var o,r,i=this,s=this.image,n=Math.min(t.x/s.width,t.y/s.height),p=newCanvas(t),h=p.getContext("2d");return h.scale(n,n),h.drawImage(s,0,0),h.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.children.forEach(function(t){t.isVisible&&t!==e&&(o=t.fullBounds(),r=t.fullImage(),r.width&&r.height&&h.drawImage(t.fullImage(),o.origin.x-i.bounds.origin.x,o.origin.y-i.bounds.origin.y))}),p},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.bubble=function(t){var e;this.stopTalking(),""===t||isNil(t)||(e=new StageTalkMorph(t),this.scale<1?e.setWidth(this.width()-10):e.setWidth(this.dimensions.x-20),e.fixLayout(),e.setCenter(this.center()),e.setBottom(this.bottom()-e.border),this.add(e),this.changed())},StageMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},StageMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof StageTalkMorph})},StageMorph.prototype.createClone=nop,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot,StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.playSound=SpriteMorph.prototype.playSound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()}),this.activeSounds=[]},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,SpriteBubbleMorph.prototype=new SpeechBubbleMorph,SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph,SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(t,e,o,r){var i=SpriteMorph.prototype;this.scale=e||1,this.data=t,this.isQuestion=r,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(t),i.bubbleColor,null,null,r?i.blockColor.sensing:i.bubbleBorderColor,null,o)},SpriteBubbleMorph.prototype.dataAsMorph=function(t){var e,o,r,i,s,n=SpriteMorph.prototype;return t instanceof Morph?e=t:isString(t)?(o=!0,e=new TextMorph(t,n.bubbleFontSize*this.scale,null,n.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(r=n.booleanMorph(t).fullImage(),e=new Morph,e.silentSetWidth(r.width),e.silentSetHeight(r.height),e.image=r):t instanceof Costume?(r=t.thumbnail(new Point(40,40)),e=new Morph,e.silentSetWidth(r.width),e.silentSetHeight(r.height),e.image=r):t instanceof HTMLCanvasElement?(e=new Morph,e.silentSetWidth(t.width),e.silentSetHeight(t.height),e.image=t):t instanceof List?(e=new ListWatcherMorph(t),e.isDraggable=!1,e.update(!0),e.step=e.update):t instanceof Context?(r=t.image(),e=new Morph,e.silentSetWidth(r.width),e.silentSetHeight(r.height),e.image=r):e=new TextMorph(t.toString(),n.bubbleFontSize*this.scale,null,n.bubbleFontIsBold,!1,"center"),e instanceof TextMorph?(s=Math.max(e.width(),2*n.bubbleCorner*this.scale),o&&(s=Math.min(s,n.bubbleMaxTextWidth*this.scale)),e.setWidth(s)):t instanceof List||(i=newCanvas(e.extent().multiplyBy(this.scale)),i.getContext("2d").drawImage(e.image,0,0,i.width,i.height),e.image=i,e.bounds=e.bounds.scaleBy(this.scale)),e},SpriteBubbleMorph.prototype.setScale=function(t){this.scale=t,this.changed(),this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(){var t=SpriteMorph.prototype;this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpriteBubbleMorph.prototype.fixLayout=function(){var t=SpriteMorph.prototype;this.changed(),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),o=newCanvas(e),r=o.getContext("2d");r.imageSmoothingEnabled=!1,r.drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=o,this.version=Date.now()},Costume.prototype.boundingBox=function(){function t(t,e){return l.data[e*h*4+4*t+3]}function e(){for(n=0;h>=n;n+=1)for(s=0;a>=s;s+=1)if(t(n,s))return n;return 0}function o(){for(s=0;a>=s;s+=1)for(n=0;h>=n;n+=1)if(t(n,s))return s;return 0}function r(){for(n=h;n>=0;n-=1)for(s=a;s>=0;s-=1)if(t(n,s))return Math.min(n+1,h);return h}function i(){for(s=a;s>=0;s-=1)for(n=h;n>=0;n-=1)if(t(n,s))return Math.min(s+1,a);return a}var s,n,p=this.contents,h=p.width,a=p.height,c=p.getContext("2d"),l=c.getImageData(0,0,h,a);return new Rectangle(e(),o(),r(),i())},Costume.prototype.copy=function(){var t,e,o=newCanvas(this.extent());return e=o.getContext("2d"),e.drawImage(this.contents,0,0),t=new Costume(o,this.name?copy(this.name)+"副本":null),t.rotationCenter=this.rotationCenter.copy(),t.src=this.src||null,t},Costume.prototype.flipped=function(){var t,e=newCanvas(this.extent()),o=e.getContext("2d");return o.translate(this.width(),0),o.scale(-1,1),o.drawImage(this.contents,0,0),t=new Costume(e,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))},Costume.prototype.edit=function(t,e,o,r,i){var s=this;IDEMorph.painter.openIn(o?null:this.contents.toDataURL(),this.name,{width:o?StageMorph.prototype.dimensions.x:this.contents.width,height:o?StageMorph.prototype.dimensions.y:this.contents.height,rotationCenter:o?new Point(StageMorph.prototype.dimensions.x/2,StageMorph.prototype.dimensions.y/2):this.rotationCenter,callback:function(o){s.contents=o.img,s.name=o.name,s.src=o.src,s.rotationCenter=new Point(o.rc.x,o.rc.y),e.currentSprite instanceof SpriteMorph&&s.shrinkWrap(),s.version=Date.now(),t.changed(),(i||nop)(),e&&(e.currentSprite.wearCostume(s),e.hasChangedMedia=!0);var r=s.contents.toDataURL("image/png"),n=new CDNUpload;n.getToken(r,function(t){s.src=t.src},{img:s.contents,src:n.url})}})},Costume.prototype.editRotationPointOnly=function(t){var e,o,r,i=new CostumeEditorMorph(this);e=function(){i.accept()},o=new DialogBoxMorph(this,e),r=new TextMorph(localize("点击或拖动十字准线，设置旋转中心"),o.fontSize,o.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255)),o.labelString="造型编辑器",o.createLabel(),o.setPicture(i),o.addBody(r),o.addButton("ok","确定"),o.addButton("cancel","取消"),o.fixLayout(),o.drawNew(),o.fixLayout(),o.popUp(t)},Costume.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t))},Costume.prototype.thumbnail=function(t){var e=this.contents,o=Math.min(t.x/e.width,t.y/e.height),r=(t.x-e.width*o)/2,i=(t.y-e.height*o)/2,s=newCanvas(t),n=s.getContext("2d");return e&&e.width+e.height!==0?(n.scale(o,o),n.drawImage(e,Math.floor(r/o),Math.floor(i/o)),s):s},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},SVG_Costume.prototype=new Costume,SVG_Costume.prototype.constructor=SVG_Costume,SVG_Costume.uber=Costume.prototype,SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,t=new SVG_Costume(e,this.name?copy(this.name):null),
t.rotationCenter=this.rotationCenter.copy(),t},SVG_Costume.prototype.shrinkToFit=function(t){nop(t)},CostumeEditorMorph.prototype=new Morph,CostumeEditorMorph.prototype.constructor=CostumeEditorMorph,CostumeEditorMorph.uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(t){this.costume=t||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var t,e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),t=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),e=this.image.getContext("2d"),e.drawImage(this.costume.contents,this.margin.x,this.margin.y),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(t.x,t.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,t.y),e.lineTo(this.costume.width()+2*this.margin.x,t.y),e.stroke(),e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x,this.costume.height()+2*this.margin.y),e.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var t=5,e=newCanvas(new Point(2*t,2*t)),o=e.getContext("2d"),r=new Color(230,230,230);return o.fillStyle="white",o.fillRect(0,0,2*t,2*t),o.fillStyle=r.toString(),o.fillRect(0,0,t,t),o.fillRect(t,t,t,t),e},CostumeEditorMorph.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},Sound.prototype.copy=function(){var t,e=document.createElement("audio");return e.src=this.audio.src,t=new Sound(e,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.gainNode=null,Note.prototype.setupContext=function(){if(!this.audioContext){var t=function(){var t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;return t.prototype.hasOwnProperty("createGain")||(t.prototype.createGain=t.prototype.createGainNode),t}();if(!t)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new t,Note.prototype.gainNode=Note.prototype.audioContext.createGain(),Note.prototype.gainNode.gain.value=.25}},Note.prototype.play=function(){this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.oscillator.type=0,this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12),this.oscillator.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.oscillator.start(0)},Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)},CellMorph.prototype=new BoxMorph,CellMorph.prototype.constructor=CellMorph,CellMorph.uber=BoxMorph.prototype,CellMorph.prototype.init=function(t,e,o,r){this.contents=0===t?0:t===!1?!1:t||"",this.isEditable=isNil(o)?!1:!0,this.idx=o||null,this.parentCell=r||null,CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner),this.color=e||new Color(255,140,0),this.isBig=!1,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(t){return this.parentCell?t instanceof List?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents):!1},CellMorph.prototype.fixLayout=function(){var t;this.changed(),this.drawNew(),this.changed(),this.parent&&this.parent.fixLayout?this.parent.fixLayout():(t=this.parentThatIsA(ListWatcherMorph),t&&t.fixLayout())},CellMorph.prototype.drawNew=function(){var t,e,o,r=SyntaxElementMorph.prototype.fontSize,i=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents;return this.isBig&&(r=1.5*r),this.contentsMorph&&!i&&this.contentsMorph.destroy(),i||(this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?(e=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(e,r,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(o=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(o.width),this.contentsMorph.silentSetHeight(o.height),this.contentsMorph.image=o):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(o=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(o.width),this.contentsMorph.silentSetHeight(o.height),this.contentsMorph.image=o):this.contents instanceof Costume?(o=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(o.width),this.contentsMorph.silentSetHeight(o.height),this.contentsMorph.image=o):this.contents instanceof List?this.isCircular()?(this.contentsMorph=new TextMorph("(...)",r,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):(this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),r,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),void(i||this.contentsMorph.setCenter(this.center())))},CellMorph.prototype.drawShadow=function(t,e,o){var r=e+o,i=this.width(),s=this.height();t.beginPath(),t.moveTo(0,s-r),t.lineTo(0,r),t.stroke(),t.beginPath(),t.arc(r,r,e,radians(-180),radians(-90),!1),t.stroke(),t.beginPath(),t.moveTo(r,0),t.lineTo(i-r,0),t.stroke()},CellMorph.prototype.layoutChanged=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this.parentThatIsA(ListWatcherMorph);return this.isBig&&(e=1.5*e),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),void(o&&o.fixLayout()))},CellMorph.prototype.reactToEdit=function(t){var e;isNil(this.idx)||(e=this.parentThatIsA(ListWatcherMorph),e&&e.list.put(t.text,this.idx))},CellMorph.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},WatcherMorph.prototype=new BoxMorph,WatcherMorph.prototype.constructor=WatcherMorph,WatcherMorph.uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(t,e,o,r,i){this.labelText=t||"",this.version=null,this.objName="",WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding),this.color=new Color(220,220,220),this.readoutColor=e,this.style="normal",this.target=o||null,this.getter=r||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),i&&this.hide()},WatcherMorph.prototype.isTemporary=function(){var t=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame?t&&this.target===t.variables.parentFrame?!1:null===this.target.owner:!1},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(t){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},WatcherMorph.prototype.setSliderMin=function(t){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1),this.sliderMorph.setStart(t),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5))},WatcherMorph.prototype.setSliderMax=function(t){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1),this.sliderMorph.setStop(t),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5))},WatcherMorph.prototype.update=function(){var t,e;this.target&&this.getter&&(this.updateLabel(),t=this.target instanceof VariableFrame?this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0:this.target[this.getter](),""===t||isNil(t)||(e=+t,"boolean"==typeof t||isNaN(e)||(t=Math.round(1e9*t)/1e9)),t!==this.currentValue&&(this.changed(),this.cellMorph.contents=t,this.cellMorph.drawNew(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=t)),this.cellMorph.contentsMorph instanceof ListWatcherMorph&&this.cellMorph.contentsMorph.update()},WatcherMorph.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this;return this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,e,null,!0,!1,!1),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){o.target.vars[o.getter].value=Math.round(t)},this.add(this.sliderMorph)),t=this.cellMorph.contents instanceof List,t&&(this.style="normal"),"large"===this.style?(this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),void this.changed())},WatcherMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this),o="●",r="○";return e.addItem(("normal"===this.style?o:r)+" "+localize("normal"),"styleNormal"),e.addItem(("large"===this.style?o:r)+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(e.addItem(("slider"===this.style?o:r)+" "+localize("slider"),"styleSlider"),e.addLine(),e.addItem("slider min...","userSetSliderMin"),e.addItem("slider max...","userSetSliderMax"),e.addLine(),e.addItem("import...",function(){var e=document.createElement("input"),o=t.parentThatIsA(IDE_Morph);o.filePicker&&(document.body.removeChild(o.filePicker),o.filePicker=null),e.type="file",e.style.color="transparent",e.style.backgroundColor="transparent",e.style.border="none",e.style.outline="none",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="0px",e.style.height="0px",e.addEventListener("change",function(){function r(t){o.inform("Unable to import",'Snap! can only import "text" files.\nYou selected a file of type "'+t+'".')}function i(e){var o=new FileReader;o.onloadend=function(e){t.target.setVar(t.getter,e.target.result)},0===e.type.indexOf("text")?o.readAsText(e):r(e.type)}var s;document.body.removeChild(e),o.filePicker=null,e.files.length>0&&(s=e.files[e.files.length-1],i(s))},!1),document.body.appendChild(e),o.filePicker=e,e.click()}),!this.currentValue||!isString(this.currentValue)&&isNaN(+this.currentValue)||e.addItem("导出...",function(){window.open("data:text/plain;charset=utf-8,"+encodeURIComponent(this.currentValue.toString()))})),e},WatcherMorph.prototype.setStyle=function(t){this.style=t,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("滑块的最小值",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("滑块的最大值",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var t,e;return this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),MorphicPreferences.isFlat||0===this.edge&&0===this.border?void BoxMorph.uber.drawNew.call(this):(t.fillStyle=this.color,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),void(this.border>0&&(e=t.createLinearGradient(0,0,0,this.height()),e.addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())))},StagePrompterMorph.prototype=new BoxMorph,StagePrompterMorph.prototype.constructor=StagePrompterMorph,StagePrompterMorph.uber=BoxMorph.prototype,StagePrompterMorph.prototype.init=function(t){var e=this;this.isDone=!1,t?this.label=new TextMorph(t,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left",StageMorph.prototype.dimensions.x-45):this.label=null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){e.accept()},"✓"),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0};