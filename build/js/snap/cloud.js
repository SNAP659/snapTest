function Cloud(e){this.username=null,this.password=null,this.url=e,this.session=null,this.limo=null,this.route=null,this.api={}}modules.cloud="2015-January-12";var Cloud,SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloud");Cloud.prototype.clear=function(){this.username=null,this.password=null,this.session=null,this.limo=null,this.route=null,this.api={}},Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")},Cloud.prototype.setRoute=function(e){var t,o=10,n=0;for(t=0;t<e.length;t+=1)n+=e.charCodeAt(t);n=n%o+1,this.route=".sc1m"+(10>n?"0":"")+n},Cloud.prototype.signup=function(e,t,o,n){var s=new XMLHttpRequest,r=this;try{s.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(e)+"&Email="+encodeURIComponent(t),!0),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.withCredentials=!0,s.onreadystatechange=function(){4===s.readyState&&(s.responseText?0===s.responseText.indexOf("ERROR")?n.call(this,s.responseText,"Signup"):o.call(null,s.responseText,"Signup"):n.call(null,r.url+"SignUp",localize("could not connect to:")))},s.send(null)}catch(i){n.call(this,i.toString(),"Snap!Cloud")}},Cloud.prototype.getPublicProject=function(e,t,o){var n,s=new XMLHttpRequest,r=this;try{s.open("GET",(this.hasProtocol()?"":"http://")+this.url+"Public?"+e,!0),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.withCredentials=!0,s.onreadystatechange=function(){4===s.readyState&&(s.responseText?0===s.responseText.indexOf("ERROR")?o.call(this,s.responseText):(n=r.parseResponse(s.responseText),t.call(null,n[0].SourceCode)):o.call(null,r.url+"Public",localize("could not connect to:")))},s.send(null)}catch(i){o.call(this,i.toString(),"Snap!Cloud")}},Cloud.prototype.resetPassword=function(e,t,o){var n=new XMLHttpRequest,s=this;try{n.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(e),!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.withCredentials=!0,n.onreadystatechange=function(){4===n.readyState&&(n.responseText?0===n.responseText.indexOf("ERROR")?o.call(this,n.responseText,"Reset Password"):t.call(null,n.responseText,"Reset Password"):o.call(null,s.url+"ResetPW",localize("could not connect to:")))},n.send(null)}catch(r){o.call(this,r.toString(),"Snap!Cloud")}},Cloud.prototype.login=function(e,t,o,n){var s=new XMLHttpRequest,r=JSON.stringify({__h:t,__u:e}),i=this;this.setRoute(e);try{s.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),s.setRequestHeader("Content-Type","application/json; charset=utf-8"),s.setRequestHeader("SESSIONGLUE",this.route),s.withCredentials=!0,s.onreadystatechange=function(){4===s.readyState&&(s.responseText?(i.api=i.parseAPI(s.responseText),i.session=s.getResponseHeader("MioCracker").split(";")[0],i.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),i.api.logout?(i.username=e,i.password=t,o.call(null,i.api,"Snap!Cloud")):n.call(null,s.responseText,"connection failed")):n.call(null,i.url,localize("could not connect to:")))},s.send(r)}catch(l){n.call(this,l.toString(),"Snap!Cloud")}},Cloud.prototype.reconnect=function(e,t){return this.username&&this.password?void this.login(this.username,this.password,e,t):void this.message("You are not logged in")},Cloud.prototype.saveProject=function(e,t,o){var n,s,r=this;e.serializer.isCollectingMedia=!0,n=e.serializer.serialize(e.stage),s=e.hasChangedMedia?e.serializer.mediaXML(e.projectName):null,e.serializer.isCollectingMedia=!1,e.serializer.flushMedia();try{e.serializer.parse(n)}catch(i){throw e.showMessage("Serialization of program data failed:\n"+i),new Error("Serialization of program data failed:\n"+i)}if(null!==s)try{e.serializer.parse(s)}catch(i){throw e.showMessage("Serialization of media failed:\n"+i),new Error("Serialization of media failed:\n"+i)}e.serializer.isCollectingMedia=!1,e.serializer.flushMedia(),r.reconnect(function(){r.callService("saveProject",function(o,n){t.call(null,o,n),r.disconnect(),e.hasChangedMedia=!1},o,[e.projectName,n,s,n.length,s?s.length:0])},o)},Cloud.prototype.getProjectList=function(e,t){var o=this;this.reconnect(function(){o.callService("getProjectList",function(t,n){e.call(null,t,n),o.disconnect()},t)},t)},Cloud.prototype.changePassword=function(e,t,o,n){var s=this;this.reconnect(function(){s.callService("changePassword",function(e,t){o.call(null,e,t),s.disconnect()},n,[hex_sha512(e),hex_sha512(t)])},n)},Cloud.prototype.logout=function(e,t){this.clear(),this.callService("logout",e,t)},Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)},Cloud.prototype.callURL=function(e,t,o){var n,s=new XMLHttpRequest,r=this;try{n=e+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,s.open("GET",n,!0),s.withCredentials=!0,s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("MioCracker",this.session),s.setRequestHeader("SESSIONGLUE",this.route),s.onreadystatechange=function(){if(4===s.readyState)if(s.responseText){var n=r.parseResponse(s.responseText);t.call(null,n,e)}else o.call(null,e,"no response from:")},s.send(null)}catch(i){o.call(this,i.toString(),e)}},Cloud.prototype.callService=function(e,t,o,n){var s,r,i=new XMLHttpRequest,l=this.api[e],a=this;if(!this.session)return void o.call(null,"You are not connected","Cloud");if(!l)return void o.call(null,"service "+e+" is not available","API");n&&n.length>0&&(r={},l.parameters.forEach(function(e,t){r[e]=n[t]}));try{s=this.url+"/"+l.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,i.open(l.method,s,!0),i.withCredentials=!0,i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("MioCracker",this.session),i.setRequestHeader("SESSIONGLUE",this.route),i.onreadystatechange=function(){if(4===i.readyState){var n=[];if(i.responseText&&0===i.responseText.indexOf("ERROR"))return void o.call(this,i.responseText,localize("Service:")+" "+localize(e));"login"===e&&(a.api=a.parseAPI(i.responseText)),n=a.parseResponse(i.responseText),t.call(null,n,l.url)}},i.send(this.encodeDict(r))}catch(c){o.call(this,c.toString(),l.url)}},Cloud.prototype.parseAPI=function(e){var t,o={};return t=e.split(" "),t.forEach(function(e){var t,n=e.split("&"),s={};n.forEach(function(e){var n=e.split("="),r=decodeURIComponent(n[0]).toLowerCase(),i=decodeURIComponent(n[1]);"service"===r?o[i]=s:"parameters"===r?(t=i.split(","),(1!==t.length||t[0])&&(s.parameters=t)):s[r]=i})}),o},Cloud.prototype.parseResponse=function(e){var t,o=[];return e?(t=e.split(" "),t.forEach(function(e){var t=e.split("&"),n={};t.forEach(function(e){var t=e.split("="),o=decodeURIComponent(t[0]),s=decodeURIComponent(t[1]);n[o]=s}),o.push(n)}),o):o},Cloud.prototype.parseDict=function(e){var t={};return e?(e.split("&").forEach(function(e){var o=e.split("="),n=decodeURIComponent(o[0]),s=decodeURIComponent(o[1]);t[n]=s}),t):t},Cloud.prototype.encodeDict=function(e){var t,o,n="";if(!e)return null;for(o in e)e.hasOwnProperty(o)&&(t=encodeURIComponent(o)+"="+encodeURIComponent(e[o]),n.length>0&&(n+="&"),n+=t);return n},Cloud.prototype.message=function(e){alert(e)};