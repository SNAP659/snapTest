function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(t,o){this.init(t,o)}function PaintCanvasMorph(t){this.init(t)}modules.paint="2014-September-29";var PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph;PaintEditorMorph.prototype=new DialogBoxMorph,PaintEditorMorph.prototype.constructor=PaintEditorMorph,PaintEditorMorph.uber=DialogBoxMorph.prototype,PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="编程猫画板",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var t=this;this.paper=new PaintCanvasMorph(function(){return t.shift}),this.paper.setExtent(new Point(310,450)),this.addBody(new AlignmentMorph("row",this.padding+10)),this.controls=new AlignmentMorph("row",this.padding/2),this.controlss=new AlignmentMorph("column",this.padding/2),this.body.color=this.color,this.body.add(this.paper),this.body.add(this.controlss),this.controlss.add(this.controls),this.brushsizebox=new BoxMorph,this.brushsizebox.color=new Color(51,51,51),this.brushsizebox.borderColor=this.brushsizebox.color.lighter(40),this.brushsizebox.edge=5,this.toolbox=new BoxMorph,this.toolbox.color=new Color(51,51,51),this.toolbox.borderColor=this.toolbox.color.lighter(40),this.toolbox.edge=5,this.colorpickerbox=new BoxMorph,this.colorpickerbox.color=new Color(51,51,51),this.colorpickerbox.borderColor=this.toolbox.color.lighter(40),this.colorpickerbox.edge=5,this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.buildToolbox(),this.controls.add(this.toolbox),this.buildcolorpickerbox(),this.controls.add(this.colorpickerbox),this.controlss.add(this.brushsizebox),this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var t={pencil:"Pencil",line:"Line tool\n(shift: vertical/horizontal)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",pipette:"Pipette tool\n(pick a color anywhere)",zoomin:"放大",zoomout:"缩小",sflip:"水平翻转",cflip:"垂直翻转",rotate:"旋转",undo:"撤销",crosshairs:"设置旋转中心",inputText:"输入文字"},o=this,e=this.toolbox.left(),i=this.toolbox.top(),r=5,s=5,n=0,a=0;Object.keys(t).forEach(function(s){var h=o.toolButton(s,t[s]);h.setPosition(new Point(e+n,i+a)),n+=h.width()+r,"line"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),"circle"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),"pipette"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),"zoomout"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),"cflip"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),"undo"===s&&(n=0,a+=h.height()+10,o.paper.drawcrosshair()),o.toolbox[s]=h,o.toolbox.add(h)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(2*s+2),this.toolbox.setHeight(400),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildcolorpickerbox=function(){var t=this.colorpickerbox,o=this,e=this.propertiesControls;e.primaryColorViewer=new Morph,e.primaryColorViewer.setExtent(new Point(115,40)),e.primaryColorViewer.color=new Color(0,0,0),e.colorpicker=new PaintColorPickerMorph(new Point(115,275),function(t){var i,r,s=newCanvas(e.primaryColorViewer.extent()),n=s.getContext("2d");if(o.paper.settings.primarycolor=t,"transparent"===t)for(i=0;180>i;i+=5)for(r=0;15>r;r+=5)n.fillStyle=(r+i)/5%2===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",n.fillRect(i,r,5,5);else n.fillStyle=t.toString(),n.fillRect(0,0,115,40);e.primaryColorViewer.image=s,e.primaryColorViewer.changed()}),e.colorpicker.action(new Color(0,0,0)),t.add(e.colorpicker),e.primaryColorViewer.setPosition(new Point(0,281)),t.add(e.primaryColorViewer),this.colorpickerbox.bounds=this.colorpickerbox.fullBounds().expandBy(10),this.colorpickerbox.setHeight(400),this.colorpickerbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var t=this.paper;this.edits.add(this.pushButton("撤销",function(){t.undo()})),this.edits.add(this.pushButton("clear",function(){t.clearCanvas()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton("放大",function(){t.scale(.05,.05)})),this.scaleBox.add(this.pushButton("缩小",function(){t.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("水平翻转",function(){t.scale(-2,0)})),this.scaleBox.add(this.pushButton("垂直翻转",function(){t.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(t,o,e,i){this.oldim=o,this.oldrc=e.copy(),this.callback=i||nop,this.processKeyUp=function(){this.shift=!1},this.processKeyDown=function(){this.shift=16===this.world().currentKey},this.oldim&&(this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=this.oldrc.add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t),IDEMorph.paintEditor=this,t.height()>590&&t.width()>1330?(this.setLeft(IDEMorph.spriteEditor.left()+300),this.setTop(IDEMorph.spriteEditor.top()),this.isDraggable=!1):(this.isDraggable=!0,CostumeEditor&&CostumeEditor.hide())},PaintEditorMorph.prototype.fixLayout=function(){var t=Morph.prototype.trackChanges;this.changed(),t=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.controlss&&this.controlss.fixLayout(),this.body&&this.body.fixLayout(),world.height()>590&&world.width()>1330?(this.silentSetWidth(IDEMorph.spriteEditor.width()-300),IDEMorph.isSmallStage?this.silentSetHeight(IDEMorph.spriteEditor.height()+IDEMorph.corralHeight):this.silentSetHeight(IDEMorph.spriteEditor.height())):(this.silentSetWidth(600),this.silentSetHeight(560));var o,e=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&this.head.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.body&&(this.head?(this.body.setCenter(this.center()),o=this.width(),this.head.setLeft(this.left()+Math.round((o-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((o-this.body.width())/2))):this.body.setCenter(this.center())),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setTop(this.body.bottom()+this.padding)),Morph.prototype.trackChanges=t,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(t){t.refresh()})},PaintEditorMorph.prototype.ok=function(){"inputText"===this.paper.currentTool&&this.paper.input&&(this.paper.input.blur(),document.body.removeChild(this.paper.input),document.body.removeChild(this.paper.count),this.paper.input=null,this.paper.count=null),this.callback({img:this.paper.paper,rc:this.paper.rotationCenter,src:null}),world.height()>590&&world.width()>1330||this.destroy()},PaintEditorMorph.prototype.destroy=function(){DialogBoxMorph.prototype.destroy.call(this),IDEMorph.paintEditor=null},PaintEditorMorph.prototype.cancel=function(){"inputText"===this.paper.currentTool&&this.paper.input&&(document.body.removeChild(this.paper.input),document.body.removeChild(this.paper.count),this.paper.input=null,this.paper.count=null),this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.brushsizebox,o=this,e=this.propertiesControls,i=new AlignmentMorph("row",this.padding);e.penSizeSlider=new SliderMorph(0,20,5,5),e.penSizeSlider.orientation="horizontal",e.penSizeSlider.setHeight(20),e.penSizeSlider.setWidth(197),e.penSizeSlider.action=function(t){e.penSizeField&&e.penSizeField.setContents(t),o.paper.settings.linewidth=t},e.penSizeField=new InputFieldMorph("5",!0,null,!1),e.penSizeField.color=new Color(51,51,51),e.penSizeField.contents().minWidth=20,e.penSizeField.setWidth(25),e.penSizeField.accept=function(){var t=parseFloat(e.penSizeField.getValue());e.penSizeSlider.value=t,e.penSizeSlider.drawNew(),e.penSizeSlider.updateValue(),this.setContents(t),o.paper.settings.linewidth=t,this.world().keyboardReceiver=o},i.add(e.penSizeSlider),i.add(e.penSizeField),i.color=o.color,i.fixLayout(),e.penSizeField.drawNew(),t.add(i),this.brushsizebox.bounds=this.brushsizebox.fullBounds().expandBy(3.5),this.brushsizebox.drawNew()},PaintEditorMorph.prototype.toolButton=function(t,o){var e,i=this;return e=new ToggleButtonMorph(null,this,function(){"pipette"===t?i.getUserColor():"zoomin"===t?i.paper.scale(.05,.05):"zoomout"===t?i.paper.scale(-.05,-.05):"sflip"===t?i.paper.scale(-2,0):"cflip"===t?i.paper.scale(0,-2):"rotate"===t?i.paper.rotate():"undo"===t&&i.paper.undo(),i.paper.currentTool=t,i.paper.toolChanged(t),i.refreshToolButtons()},new SymbolMorph(t,35),function(){return i.paper.currentTool===t}),e.color=new Color(40,40,40),e.highlightColor=new Color(128,214,222),e.pressColor=new Color(128,214,222),e.hint=o,e.drawNew(),e.fixLayout(),e},PaintEditorMorph.prototype.pushButton=function(t,o,e){return new PushButtonMorph(this,o,t,null,e)},PaintEditorMorph.prototype.getUserColor=function(){var t=this,o=this.world(),e=o.hand,i=getDocumentPositionOf(o.worldCanvas),r=e.processMouseMove,s=e.processMouseDown,n=e.processMouseUp;e.processMouseMove=function(r){var s;e.setPosition(new Point(r.pageX-i.x,r.pageY-i.y)),s=o.getGlobalPixelColor(e.position()),s.a=255,t.propertiesControls.colorpicker.action(s)},e.processMouseDown=nop,e.processMouseUp=function(){t.paper.currentTool="pencil",t.paper.toolChanged("pencil"),t.refreshToolButtons(),e.processMouseMove=r,e.processMouseDown=s,e.processMouseUp=n}},PaintColorPickerMorph.prototype=new Morph,PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph,PaintColorPickerMorph.uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(t,o){this.setExtent(t||new Point(200,100)),this.action=o||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){for(var t=0,o=0,e=0,i=5,r=5,s=35,n=35,a=newCanvas(this.extent()),h=a.getContext("2d"),p=new Array("rgb(255,255,255)","rgb(188,188,188)","rgb(0,0,0)","rgb(63,115,163)","rgb(131,97,59)","rgb(94,59,27)","rgb(233,24,43)","rgb(254,140,1)","rgb(255,255,51)","rgb(66,176,77)","rgb(51,255,51)","rgb(79,198,255)","rgb(192,51,104)","rgb(255,191,197)","rgb(249,98,117)","rgb(181,255,255)","rgb(153,255,153)","rgb(251,254,141)","rgb(255,198,102)","rgb(9,234,138)","rgb(154,215,40)"),l=0;7>l;l++){for(var d=0;3>d;d++)h.fillStyle=p[e],h.beginPath(),h.arc(t+i,o+i,r,radians(-180),radians(-90),!1),h.arc(t+s-i,o+i,r,radians(-90),radians(-0),!1),h.arc(t+s-i,o+n-i,r,radians(0),radians(90),!1),h.arc(t+i,o+n-i,r,radians(90),radians(180),!1),h.closePath(),h.fill(),t+=40,e+=1;t=0,o+=40}this.image=a},PaintColorPickerMorph.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,PaintCanvasMorph.prototype.constructor=PaintCanvasMorph,PaintCanvasMorph.uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(t){this.rotationCenter=new Point(155,225),this.dragRect=null,this.previousDragPoint=null,this.currentTool="pencil",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent()),this.paper=newCanvas(this.extent()),this.erasermask=newCanvas(this.extent()),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){var t=this.world().currentKey;return 16===t},this.buildContents()},PaintCanvasMorph.prototype.scale=function(t,o){this.mask=newCanvas(this.extent());var e=newCanvas(this.extent()),i=e.getContext("2d");i.imageSmoothingEnabled=!1,i.save(),i.translate(this.rotationCenter.x,this.rotationCenter.y),i.scale(1+t,1+o),i.drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),i.restore(),this.paper=e,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.rotate=function(){this.mask=newCanvas(this.extent());var t=newCanvas(this.extent());t.getContext("2d").save(),t.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),t.getContext("2d").rotate(90*Math.PI/180),t.getContext("2d").translate(-this.rotationCenter.x,-this.rotationCenter.y),t.imageSmoothingEnabled=!1,t.getContext("2d").drawImage(this.paper,0,0),t.getContext("2d").restore(),this.paper=t,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var t=newCanvas(this.extent());this.merge(this.paper,t),this.undoBuffer.push(t)},PaintCanvasMorph.prototype.undo=function(){this.undoBuffer.length>0&&(this.paper=newCanvas(this.extent()),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(t,o){var e=o.getContext("2d");e.imageSmoothingEnabled=!1,e.drawImage(t,0,0)},PaintCanvasMorph.prototype.centermerge=function(t,o){var e=o.getContext("2d");e.imageSmoothingEnabled=!1,e.drawImage(t,(o.width-t.width)/2,(o.height-t.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(t){this.mask=newCanvas(this.extent()),"crosshairs"===t&&this.drawcrosshair(),this.input&&(document.body.removeChild(this.input),document.body.removeChild(this.count),this.input=null,this.count=null),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(t){var o=t||this.mask.getContext("2d"),e=this.rotationCenter;o.lineWidth=1,o.strokeStyle="black",o.clearRect(0,0,this.mask.width,this.mask.height),o.globalAlpha=.5,o.fillStyle="white",o.beginPath(),o.arc(e.x,e.y,20,radians(0),radians(360),!1),o.closePath(),o.fill(),o.stroke(),o.beginPath(),o.arc(e.x,e.y,10,radians(0),radians(360),!1),o.stroke(),o.beginPath(),o.moveTo(0,e.y),o.lineTo(this.mask.width,e.y),o.stroke(),o.beginPath(),o.moveTo(e.x,0),o.lineTo(e.x,this.mask.height),o.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.paintInput=function(t){var o=document.createElement("input"),e=document.createElement("span"),i=this.mask.getContext("2d"),r=this;return t.size+=12,o.type="text",o.style.top=t.y+50+"px",o.style.left=t.x+"px",o.style.width="100px",o.style.fontSize=t.size+"px",o.style.fontFamily="微软雅黑",o.style.backgroundColor="transparent",o.style.outline="none",o.style.zIndex="1000",o.style.position="absolute",o.style.borderStyle="dotted",o.style.borderColor="black",o.style.color=t.color+"",e.style.color="transparent",e.style.fontSize=t.size+"px",e.style.fontFamily="微软雅黑",o.addEventListener("keyup",function(){i.clearRect(0,0,r.mask.width,r.mask.height),e.innerHTML=o.value,o.style.width=e.offsetWidth+4+"px"}),o.addEventListener("blur",function(){i.fillText(o.value+"",t.x-r.left()+2,t.y-r.top()+e.offsetHeight),r.drawNew(),r.changed(),r.merge(r.mask,r.paper)}),i.font=t.size+"px 微软雅黑",i.fillStyle=t.color+"",document.body.appendChild(o),document.body.appendChild(e),o.focus(),this.input=o,this.count=e,o},PaintCanvasMorph.prototype.floodfill=function(t){var o,e,i,r,s=this.paper.width,n=this.paper.height,a=this.paper.getContext("2d"),h=a.getImageData(0,0,s,n),p=h.data,l=[Math.round(t.y)*s+t.x];if(e=function(t){var o=4*t;return[p[o],p[o+1],p[o+2],p[o+3]]},i=e(l[0]),r=function(t){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]},(0!==i[3]||"transparent"!==this.settings.primarycolor)&&!(i[0]===this.settings.primarycolor.r&&i[1]===this.settings.primarycolor.g&&i[2]===this.settings.primarycolor.b&&i[3]===this.settings.primarycolor.a||0===i[3]&&0===this.settings.primarycolor.a)){for(;l.length>0;)o=l.pop(),r(e(o))&&(o%s>1&&(l.push(o+1),l.push(o-1)),o>0&&n*s>o&&(l.push(o+s),l.push(o-s))),"transparent"===this.settings.primarycolor?p[4*o+3]=0:(p[4*o]=this.settings.primarycolor.r,p[4*o+1]=this.settings.primarycolor.g,p[4*o+2]=this.settings.primarycolor.b,p[4*o+3]=255*this.settings.primarycolor.a);a.putImageData(h,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent()),this.merge(this.paper,this.erasermask)),void("inputText"===this.currentTool&&(this.input?(document.body.removeChild(this.input),this.input=null,this.count=null):this.paintInput({x:t.x,y:t.y,size:this.settings.linewidth,color:this.settings.primarycolor.toString()}))))},PaintCanvasMorph.prototype.mouseMove=function(t){function o(){return Math.max(Math.abs(d),Math.abs(c))*(d/Math.abs(d))}function e(){return Math.max(Math.abs(d),Math.abs(c))*(c/Math.abs(c))}if("paintbucket"!==this.currentTool){var i,r=t.subtract(this.bounds.origin),s=this.mask.getContext("2d"),n=this.paper.getContext("2d"),a=this.dragRect.origin.x,h=this.dragRect.origin.y,p=r.x,l=r.y,d=(p-a)/2,c=(l-h)/2,u=this.paper.width;switch(s.save(),this.brushBuffer.push([p,l]),s.lineWidth=this.settings.linewidth,s.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=r.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),n.clearRect(0,0,this.bounds.width(),this.bounds.height()),s.globalCompositeOperation="destination-out"):(s.fillStyle=this.settings.primarycolor.toString(),s.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?s.strokeRect(a,h,2*o(),2*e()):s.strokeRect(a,h,2*d,2*c);break;case"rectangleSolid":this.isShiftPressed()?s.fillRect(a,h,2*o(),2*e()):s.fillRect(a,h,2*d,2*c);break;case"pencil":for(s.lineCap="round",s.lineJoin="round",s.beginPath(),s.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)s.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);s.stroke();break;case"line":s.beginPath(),s.moveTo(a,h),this.isShiftPressed()?Math.abs(c)>Math.abs(d)?s.lineTo(a,l):s.lineTo(p,h):s.lineTo(p,l),s.stroke();break;case"circle":case"circleSolid":if(s.beginPath(),this.isShiftPressed())s.arc(a,h,new Point(a,h).distanceTo(new Point(p,l)),0,2*Math.PI,!1);else{for(i=0;u>i;i+=1)s.lineTo(i,2*c*Math.sqrt(2-Math.pow((i-a)/(2*d),2))+h);for(i=u;i>0;i-=1)s.lineTo(i,-1*(2*c)*Math.sqrt(2-Math.pow((i-a)/(2*d),2))+h)}s.closePath(),"circleSolid"===this.currentTool?s.fill():"circle"===this.currentTool&&s.stroke();break;case"crosshairs":this.rotationCenter=r.copy(),this.drawcrosshair(s);break;case"eraser":for(this.merge(this.paper,this.mask),s.save(),s.globalCompositeOperation="destination-out",s.beginPath(),s.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)s.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);s.stroke(),s.restore(),this.paper=newCanvas(this.extent()),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=r,this.drawNew(),this.changed(),s.restore()}},PaintCanvasMorph.prototype.mouseUpLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseUpLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent()),this.mask=newCanvas(this.extent()),this.erasermask=newCanvas(this.extent());var t,o,e=this.background.getContext("2d");for(t=0;t<this.background.width;t+=5)for(o=0;o<this.background.height;o+=5)(t+o)/5%2===1?e.fillStyle="rgba(255, 255, 255, 1)":e.fillStyle="rgba(200, 200, 200, 0.8)",e.fillRect(t,o,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var t=newCanvas(this.extent());this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.image=t,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var t,o;t=this.image.getContext("2d"),this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),o=this.parent.color):o=new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=o.toString(),this.cachedClrBright=o.lighter(this.contrast).toString(),this.cachedClrDark=o.darker(this.contrast).toString(),this.drawRectBorder(t)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;