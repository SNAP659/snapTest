function IDE_Morph(t){this.init(t)}function ProjectDialogMorph(t,e,o,i){this.init(t,e,o,i)}function SpriteIconMorph(t,e,o){this.init(t,e,o)}function CostumeIconMorph(t,e){this.init(t,e)}function TurtleIconMorph(t,e){this.init(t,e)}function WardrobeMorph(t,e){this.init(t,e)}function SoundIconMorph(t,e){this.init(t,e)}function JukeboxMorph(t,e){this.init(t,e)}modules.gui="2015-May-18";var IDE_Morph,ProjectDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph;IDE_Morph.prototype=new Morph,IDE_Morph.prototype.constructor=IDE_Morph,IDE_Morph.uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,IDE_Morph.prototype.headerHeight=40,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(255,255,255),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.inputfieldColor=new Color(214,214,214),IDE_Morph.prototype.normalButtonColor=new Color(122,122,122),IDE_Morph.prototype.stageDecorateHeight=10,IDE_Morph.prototype.stageDecorateBorder=1,IDE_Morph.prototype.titleBarBoxColor=new Color(60,60,60),DialogBoxMorph.prototype.dialogboxColor=new Color(80,80,80),IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.categoryBackgroundColor="transparent",IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=2,IDE_Morph.prototype.categoryWidth=107,IDE_Morph.prototype.categoryButtonWidth=90,SpriteIconMorph.prototype.labelColor=new Color(65,61,52),SpriteIconMorph.prototype.labelColorHighlight=new Color(255,255,255),CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,Morph.prototype.titleBarBoxColor=IDE_Morph.prototype.titleBarBoxColor,BoxMorph.prototype.normalButtonColor=IDE_Morph.prototype.normalButtonColor,IDE_Morph.prototype.spriteBarColor=new Color(82,83,86),IDE_Morph.prototype.spriteBarTextColor=new Color(134,134,134),IDE_Morph.prototype.spriteBarHeight=30,IDE_Morph.prototype.corralBarColor=new Color(120,120,120),IDE_Morph.prototype.corralBarButtonColor=new Color(86,163,255),IDE_Morph.prototype.corralBarHeight=34,IDE_Morph.prototype.corralColor=new Color(255,251,241),IDE_Morph.prototype.corralBorderColor=new Color(237,225,194),IDE_Morph.prototype.corralHeight=116,IDE_Morph.prototype.corralHtmlSize=32,IDE_Morph.prototype.corralHtmlHeight=IDE_Morph.prototype.corralHeight-3,IDE_Morph.prototype.corralHtmlWidth=135,IDE_Morph.prototype.corralButtonWidth=260,IDE_Morph.prototype.corralButtonOpenWidth=380,IDE_Morph.prototype.corralButtonHeight=IDE_Morph.prototype.corralHeight-3,IDE_Morph.prototype.spriteIconSize=90,IDE_Morph.prototype.spriteIconSizeSmall=90,IDE_Morph.prototype.stageIconWidth=70,IDE_Morph.prototype.stageIconHeight=100,SpriteIconMorph.prototype.Color=new Color(254,240,198),SpriteIconMorph.prototype.highlightColor=new Color(129,212,250).lighter(20),SpriteIconMorph.prototype.pressColor=new Color(79,173,255),SpriteIconMorph.prototype.spriteIconOutlineColor="#3F8ACC",SpriteIconMorph.prototype.spriteIconOutlineWidth=2,SpriteMorph.prototype.paletteBoxColor=new Color(180,180,180),SpriteMorph.prototype.paletteColor=new Color(242,239,230),SpriteMorph.prototype.paletteTextColor=new Color(134,134,134),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.spriteEditorColor=new Color(255,251,241),Morph.prototype.titleBarBackgroundColor=new Color(82,83,86),SpriteMorph.prototype.sliderColor=new Color(222,222,222).darker(10),IDE_Morph.prototype.tabColors=[new Color(120,120,120),new Color(255,164,0),new Color(255,164,0)]},IDE_Morph.prototype.setDefaultDesign(),IDE_Morph.prototype.init=function(t){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage="zh",this.projectsInURLs=!1,this.applySavedSettings(),this.cloudMsg=null,this.source="local",this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.currentSprite.name="编程猫",this.sprites=new List([this.currentSprite]),this.currentCategory="",this.currentTab="scripts",this.projectName="",this.projectNotes="",this.isProjectNew=!1,this.parentId=null,this.logo=null,this.categories=null,this.palette=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.corralBar=null,this.corral=null,this.isAutoFill=t||!0,this.isAppMode=!1,this.isSmallStage=!0,this.filePicker=null,this.hasChangedMedia=!1,this.isUploadStage=!1,this.isAnimating=!0,this.stageRatio=1,this.loadNewProject=!0,this.shield=null,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor,this.soundEffect=document.getElementById("soundEffect");var e,o=this,i=new Costume(null,"编程猫");this.currentSprite.addCostume(i);var r=new Image;r.crossOrigin="Anonymous",r.onload=function(){e=newCanvas(new Point(r.width,r.height)),e.getContext("2d").drawImage(r,0,0),i.contents=e,i.shrinkToFit(i.maxExtent()),i.rotationCenter=i.center(),i.version=Date.now(),i.src="http://7xpmmk.com2.z0.glb.qiniucdn.com/runningcat.png",o.currentSprite.wearCostume(i)},r.src="http://7xpmmk.com2.z0.glb.qiniucdn.com/runningcat.png"},IDE_Morph.prototype.openIn=function(t){function e(t){try{var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;console.log("无法获取(Unable to retrieve) "+t)}catch(o){console.log(o)}}function o(){var t;"#open:"===location.hash.substr(0,6)?(i=location.hash.substr(6),("%"===i.charAt(0)||i.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(i=decodeURIComponent(i)),contains(["project","blocks","sprites","snapdata"].map(function(t){return i.substr(0,8).indexOf(t)}),1)?this.droppedText(i):this.droppedText(e(i))):"#run:"===location.hash.substr(0,5)?(i=location.hash.substr(5),("%"===i.charAt(0)||i.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(i=decodeURIComponent(i)),"<project>"===i.substr(0,8)?this.rawOpenProjectString(i):this.rawOpenProjectString(e(i)),this.toggleAppMode(!1),this.runScripts()):"#present:"===location.hash.substr(0,9)?(this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),r.showMessage("Fetching project\nfrom the cloud..."),t=SnapCloud.parseDict(location.hash.substr(9)),t.Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(e){var o;r.nextSteps([function(){o=r.showMessage("打开中...")},function(){nop()},function(){0===e.indexOf("<snapdata")?r.rawOpenCloudDataString(e):0===e.indexOf("<project")&&r.rawOpenProjectString(e),r.hasChangedMedia=!0},function(){r.shield.destroy(),r.shield=null,o.destroy(),t.editMode?r.toggleAppMode(!1):r.toggleAppMode(!0),t.noRun||r.runScripts(),t.hideControls&&(window.onbeforeunload=function(){nop()})}])},this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),r.showMessage("Fetching project\nfrom the cloud..."),t=SnapCloud.parseDict(location.hash.substr(7)),t.Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(t){var e;r.nextSteps([function(){e=r.showMessage("打开中...")},function(){nop()},function(){0===t.indexOf("<snapdata")?r.rawOpenCloudDataString(t):0===t.indexOf("<project")&&r.rawOpenProjectString(t),r.hasChangedMedia=!0},function(){r.shield.destroy(),r.shield=null,e.destroy(),r.toggleAppMode(!1)}])},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(s=location.hash.substr(6),this.setLanguage(s),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount()}var i,r=this,s="zh";this.buildPanes(),t.add(this),t.userMenu=this.userMenu,t.reactToDropOf=function(e){e instanceof DialogBoxMorph||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.reactToWorldResize(t.bounds),this.userLanguage?this.setLanguage(this.userLanguage,o):o.call(this)},IDE_Morph.prototype.buildPanes=function(){this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralButton(),this.createCorralBar(),this.createCorral(),CostumeEditor?CostumeEditor.build():(console.log("CostumeEditor is Empty"),CostumeEditor={build:function(){},show:function(){},hide:function(){},refresh:function(){}}),SoundEditor?SoundEditor.build():(console.log("Sound Editor is Empty"),SoundEditor={build:function(){},show:function(){},hide:function(){},refresh:function(){}}),window.SpritePropertiesEditor?SpritePropertiesEditor.build():(console.log("Property Editor is Empty"),window.SpritePropertiesEditor={build:function(){},show:function(){},hide:function(){},refresh:function(){}}),OpenProjectDialog?OpenProjectDialog.build():console.log("Open Project Dialog is Empty"),SaveProjectDialog?SaveProjectDialog.build():console.log("Save Project Dialog is Empty"),this.bindEvents()},IDE_Morph.prototype.createLogo=function(){this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture="icon/logo.png",this.logo.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d");t.fillStyle="rgb(82,83,86)",t.fillRect(0,0,this.width(),this.height()),t.fillStyle="rgb(86,163,255)",t.fillRect(0,this.height()/2-15,this.width(),30),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){var t=this.image.getContext("2d");t.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){},this.logo.color=new Color,this.logo.setExtent(new Point(280,50)),this.add(this.logo)},IDE_Morph.prototype.bindEvents=function(){var t,e,o,r,s=IDEMorph;for(t=document.getElementById("ide-corral"),this.corralHtml=t,e=document.getElementById("ide-corral-bar"),o=document.getElementById("SpriteBar"),e.addEventListener("click",SpritePropertiesEditor.hide),t.addEventListener("click",SpritePropertiesEditor.hide),o.addEventListener("click",SpritePropertiesEditor.hide),r=e.getElementsByClassName("stage-start"),i=0;i<r.length;++i)r[i].addEventListener("click",function(){s.pressStart(),this.style.display="none";for(var t=e.getElementsByClassName("stage-stop"),o=0;o<t.length;++o)t[o].style.display=""});for(r=e.getElementsByClassName("stage-stop"),i=0;i<r.length;++i)r[i].addEventListener("click",function(){s.stopAllScripts(),this.style.display="none";for(var t=e.getElementsByClassName("stage-start"),o=0;o<t.length;++o)t[o].style.display=""});for(r=e.getElementsByClassName("stage-size"),i=0;i<r.length;++i)r[i].addEventListener("click",function(){s.toggleStageSize()})},IDE_Morph.prototype.createControlBar=function(){var t,e,o=IDEMorph;for(t=document.getElementById("ide-header"),e=t.getElementsByClassName("ide-save"),i=0;i<e.length;++i)e[i].addEventListener("click",function(){""!=codemao.userId?(1==codemao.isLesson?world.children[0].savePerStep(0,function(){savingMessage.saving(),setTimeout(function(){savingMessage.saved()},1e3)}):o.save(),"1"!=localStorage.getItem("isFirstSaveToLocal")&&(localStorage.setItem("isFirstSaveToLocal","1"),setTimeout(function(){var t=document.createElement("div");t.className="save-to-local-prompt-bg",t.style.cssText="position:absolute;left:0;right:0;top:0;bottom:0;background-color:hsla(0, 0%, 0%, 0.84);",document.querySelector("#save-project-dialog").appendChild(t),t.addEventListener("click",function(){document.querySelector("#save-project-dialog").removeChild(t),e.removeChild(o)});var e=document.querySelector(".save-to-local-btn");e.style.zIndex="100",e.style.position="relative";var o=document.createElement("img");o.className="save-to-local-prompt-img",o.src="http://7xli7a.com2.z0.glb.qiniucdn.com/images%2Fsave-to-local-prompt.png",o.style.cssText="position:absolute;bottom:120%;right:40px;",e.appendChild(o)},0))):handleSignUp()});for(e=t.getElementsByClassName("ide-save-local"),i=0;i<e.length;++i)e[i].addEventListener("click",function(){});e=document.querySelector("#ide-header .ide-submit"),"0"!=parseHash().lesson&&"-1"!=parseHash().lesson&&"?type=modify"!=location.search&&"?type=fork"!=location.search&&(e.style.display="",e.addEventListener("click",function(){if("1"===codemao.isLesson){var t=document.createElement("script");t.type="text/javascript",t.onload=function(){IDEMorph.stage.thumbnailIsUploadCdn=!1,IDEMorph.stage.isProductThumbnail=!1,o.rawSaveProject({callback:getAward,name:o.projectName,id:null})},t.src="build/js/codemao/reward.js",document.body.appendChild(t)}else confirmDialog.build("亲爱的学员","提交后猫老祖将根据你的脚本和完成度给出评分。<br/>快信心满满地提交吧！<br/>（提交后将自动保存当前的作品）",function(){var t=document.createElement("script");t.type="text/javascript",t.onload=function(){IDEMorph.save({callback:getAward,callbackTarget:window})},t.src="build/js/codemao/reward.js",document.body.appendChild(t)},{isHideNo:!0,textYes:"马上提交",textCancel:"再改一下"})}));document.body.querySelector(".user-img");this.controlBar||(this.controlBar={},this.controlBar.vm=new Vue({el:"#ide-header",data:{projectName:o.projectName,spanDisplay:"inline-block",inputDisplay:"none",isUserMenuShow:!1,isCreationListShow:!1},computed:{userAvatarURL:function(){return codemao&&codemao.userAvatar?codemao.userAvatar:"https://dn-codemaousercenter.qbox.me/user_0009.png"},userName:function(){return codemao&&codemao.userName?codemao.userName:"未登录"}},watch:{projectName:function(t){o.setProjectName(t)}},methods:{edit:function(){this.spanDisplay="none",this.inputDisplay="inline-block",setTimeout(function(){t.getElementsByTagName("input")[0].focus()},1)},finish:function(){this.inputDisplay="none",this.spanDisplay="inline-block"},toggleUserMenu:function(){""!=codemao.userId?this.isUserMenuShow=!this.isUserMenuShow:handleSignUp()},hideUserMenu:function(){this.isUserMenuShow=!1},showCreationList:function(){this.isCreationListShow=!0},hideCreationList:function(){this.isCreationListShow=!1},openProject:function(){""!=codemao.userId?OpenProjectDialog&&OpenProjectDialog.show():handleSignUp()},saveProjectAs:function(){""!=codemao.userId?SaveProjectDialog.show():handleSignUp()},saveProjectLocal:function(){o.saveProjectToDisk()},newProject:function(){""!=codemao.userId?o.createNewProject():handleSignUp()},openBackpack:function(){""!=codemao.userId?Backpack.open():handleSignUp()},popUnloadMessage:function(t){confirmDialog.build("提示","确认要离开编程平台吗?",function(e){e&&(location.href=t)},{isHideCancel:!0})},openLessonPage:function(){this.popUnloadMessage("https://www.codemao.cn")},openCreationPage:function(){""!=codemao.userId?this.popUnloadMessage("https://www.codemao.cn/my"):handleSignUp()},publish:function(){""!=codemao.userId?confirmDialog.build("发布作品","确定要保存并发布作品吗?",function(t){t&&o.save({callback:function(){window.location.href="https://www.codemao.cn/my#"+IDEMorph.id},callbackTarget:o})},{isHideCancel:!0}):handleSignUp()}}}))},IDE_Morph.prototype.createCategories=function(){var t=this;SpriteMorph.prototype.cateName;this.categories&&this.categories.destroy(),this.categories=new BoxMorph(0,1,this.categoryBackgroundColor),this.categories.color=this.backgroundColor,this.categories.silentSetWidth(this.categoryWidth),this.categories.acceptsDrops=!0,this.categories.reactToDropOf=function(e){e instanceof DialogBoxMorph?t.world().add(e):e instanceof SpriteIconMorph?(e.destroy(),t.removeSprite(e.object)):e instanceof CostumeIconMorph?(t.currentSprite.wearCostume(null),e.destroy()):e instanceof SpriteMorph?(t.soundEffect&&(t.soundEffect.src="https://dn-codemao.qbox.me/se/delete.wav",t.soundEffect.play()),t.removeSprite(e),e.destroy()):(t.soundEffect&&(t.soundEffect.src="https://dn-codemao.qbox.me/se/delete.wav",t.soundEffect.play()),e.destroy())},this.categoriesHtml||this.createCategoriesHtml(),this.add(this.categories)},IDE_Morph.prototype.createCategoriesHtml=function(){"use strict";var t=this;this.categoriesHtml={},this.categoriesHtml.$el=$("#ide-categories"),this.categoriesHtml.el=document.querySelector("#ide-categories"),this.categoriesHtml.el.style.width=this.categoryWidth+"px",this.categoriesHtml.vm=new Vue({el:"#ide-categories",data:{currentCategory:null,categories:SpriteMorph.prototype.cate,colors:SpriteMorph.prototype.blockColor},computed:{sideStyle:function(){var t="";return this.currentCategory&&(t=this.colors[this.currentCategory]),{"background-color":t.toString()}}},methods:{switchCategory:function(e){this.currentCategory!==e?(t.currentCategory=e,this.currentCategory=e,t.showPalette(),"motion"==e?t.palette.setWidth(350):t.palette.setWidth(280)):(t.hidePalette(),this.currentCategory=null)},getButtonStyle:function(t){var e;return e=this.currentCategory===t?this.colors[t]:"",{"background-color":e.toString()}},getButtonClass:function(t){var e=this.currentCategory===t;return{active:e}},getColorStyle:function(t){var e;return e=this.colors[t],{"background-color":e.toString()}},getIconClass:function(t){return[t]},getName:function(t){return SpriteMorph.prototype.cateName[t]},onMouseDown:function(){editorVM&&(editorVM.showEditor=!1)}}}),this.categoriesHtml.el.style.visibility=""},IDE_Morph.prototype.createPalette=function(t){var e=this;return this.palette&&this.palette.destroy(),t?this.palette=new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.palette=this.currentSprite.palette(this.currentCategory),this.palette.reactToDropOf=function(t){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteIconMorph?(t.destroy(),e.removeSprite(t.object)):t instanceof CostumeIconMorph?(e.currentSprite.wearCostume(null),t.destroy()):t instanceof SpriteMorph?(e.soundEffect&&(e.soundEffect.src="https://dn-codemao.qbox.me/se/delete.wav",e.soundEffect.play()),e.removeSprite(t),t.destroy()):(e.soundEffect&&(e.soundEffect.src="https://dn-codemao.qbox.me/se/delete.wav",e.soundEffect.play()),t.destroy())},this.palette.contents.color=IDE_Morph.prototype.frameColor,this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.contents.acceptsDrops=!1,this.palette.zIndex=1,this.palette.setWidth(280),this.add(this.palette),this.palette},IDE_Morph.prototype.createTrashBox=function(){this.categories.trashBox&&this.categories.trashBox.destroy(),this.categories.trashBox=new Morph,this.categories.trashBox.setExtent(this.categories.extent()),this.categories.trashBox.setPosition(this.categories.position()),this.categories.trashBox.setColor(new Color(102,102,102,.9)),this.categories.trashBox.setTexture("Backgrounds/trash_box.png"),this.categories.trashBox.drawNew(),this.categories.add(this.categories.trashBox)},IDE_Morph.prototype.showPalette=function(){this.palette.show(),this.categories.children.forEach(function(t){t.refresh()}),this.refreshPalette(!0)},IDE_Morph.prototype.hidePalette=function(){this.palette.hide(),this.refreshPalette(!0),this.categoriesHtml.vm.currentCategory=null},IDE_Morph.prototype.showTrashBox=function(){IDEMorph.createTrashBox(),this.categoriesHtml.el.visibility="hidden"},IDE_Morph.prototype.hideTrashBox=function(){this.categoriesHtml.el.visibility="",this.categories.trashBox.destroy()},IDE_Morph.prototype.createStage=function(){var t;this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables,t),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createSpriteBar=function(){var t=this,e=["none","full","lr"];this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color="transparent",this.add(this.spriteBar),this.spriteBar.fixLayout=function(){},!this.SpriteBarVM&&t.currentSprite.name&&(document.querySelector("#SpriteBar").style.visibility="visible",this.SpriteBarVM=new Vue({el:"#SpriteBarLeft",data:{name:t.currentSprite.name,x:t.currentSprite.xPosition(),y:t.currentSprite.yPosition(),heading:Math.round(this.currentSprite.heading),scale:Math.round(this.currentSprite.getScale()),hidden:!t.currentSprite.isVisible,draggable:t.currentSprite.isDraggable,rs:t.currentSprite.rotationStyle,showRotationList:!1},computed:{rotationStyle:{get:function(){return this.rs=t.currentSprite.rotationStyle,t.currentSprite.rotationStyle},set:function(e){t.currentSprite.rotationStyle=parseInt(e),this.rs=e}}},watch:{draggable:function(){this.toggleDraggable()}},methods:{setName:function(e){var o=e.target.value;o?t.currentSprite.setName(t.newSpriteName(o,t.currentSprite)):e.target.value=t.currentSprite.name},setX:function(e){var o=e.target.value;o&&t.currentSprite.setXPosition(Math.round(o))},setY:function(e){var o=e.target.value;o&&t.currentSprite.setYPosition(Math.round(o))},toggleVisible:function(){this.hidden=!this.hidden,t.currentSprite.isVisible?t.currentSprite.hide():t.currentSprite.show()},setHeading:function(e){var o=e.target.value;o&&t.currentSprite.setHeading(Math.round(o))},setScale:function(e){var o=e.target.value;o&&t.currentSprite.setScale(o)},toggleDraggable:function(){IDEMorph.currentSprite instanceof SpriteMorph&&IDEMorph.currentSprite.setDraggable(this.draggable)},getRotationClass:function(){"use strict";return["rotation-"+e[this.rs]+"-icon"]},getRotationListClass:function(t){"use strict";return{checked:t==this.rs}},setRotationStyle:function(t){this.rotationStyle=t,this.showRotationList=!1},showList:function(){this.showRotationList=!0}}}))},IDE_Morph.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts;[this.normalButtonColor,this.normalButtonColor.lighter(20),this.normalButtonColor.lighter(20)];if(this.spriteEditor&&this.spriteEditor.destroy(),t.isDraggable=!1,t.color=this.spriteEditorColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(t,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding),!this.SpriteEditorVM){SyntaxElementMorph.prototype.scale;this.SpriteEditorVM=new Vue({el:"#SpriteEditor",methods:{cleanUp:function(){IDEMorph.spriteEditor.contents.cleanUp()},askQuestion:function(){document.querySelector("#zhichiBtn").click()}}})}},IDE_Morph.prototype.createCorralButton=function(t){var e,o;o=this,(!this.corralButton||t)&&(e=document.getElementById("ide-corral-button"),e&&(e.style.bottom=this.padding+3+"px",e.style.right=this.padding+"px",e.style.height=this.corralButtonHeight+"px",e.style.display="",this.corralButton||(document.body.querySelector(".sprite-draw").addEventListener("click",function(){IDEMorph.paintNewSprite()}),e.vm=new Vue({el:"#ide-corral-button",data:{magicWord:"",showBubble:!1,magicHint:"口令错误",showLabel:!1,masterLabelClass:{"master-label-error":function(){"use strict";return"口令错误"===this.magicHint}},isShining:!1,showNotice:!localStorage.getItem("isUsedVersion160509"),isBoxOpened:!localStorage.getItem("isUsedVersion160509")},methods:{openMagicBox:function(){o.corral.setWidth(o.right()-o.corral.left()-o.corralButtonOpenWidth-o.padding),o.corral.fixLayout(),this.isBoxOpened=!0},closeMagicBox:function(){o.corral.setWidth(o.right()-o.corral.left()-o.corralButtonWidth-o.padding),o.corral.fixLayout(),this.isBoxOpened=!1},toggleMagicBox:function(){"use strict";this.isBoxOpened?this.closeMagicBox():this.openMagicBox()},sendMagic:function(){"use strict";var t=this,e=new RegExp("[^(0-9)]");return e.test(this.magicWord)||!this.magicWord?void t.showMagicError():void $.ajax({type:"POST",url:window.codemao.apiServer+"/lesson/material",async:!0,dataType:"json",data:{token:this.magicWord},xhrFields:{withCredentials:!0},success:function(e){200===e.code?t.showMagicResult():t.showMagicError()},error:function(e){t.showMagicNetError()}})},showMagicResult:function(t){"use strict";var e=this;this.closeMagicBox(),this.showBubble=!0,this.isShining=!0,Backpack.fetchAiData(),setTimeout(function(){e.showBubble=!1},3e3)},showMagicInfo:function(t){"use strict";this.showLabel=!0,this.magicHint=t},hideMagicInfo:function(){"use strict";this.showLabel=!1},showMagicError:function(){"use strict";var t=this;t.showLabel=!0,this.magicHint="口令错误",setTimeout(function(){t.showLabel=!1},2e3)},showMagicNetError:function(){"use strict";var t=this;t.showLabel=!0,this.magicHint="网络错误",setTimeout(function(){t.showLabel=!1},2e3)},addSprite:function(){openLibrary(),this.isShining=!1,editorVM.closeEditor()},closeNotice:function(){this.showNotice&&(this.showNotice=!1,localStorage&&(localStorage.setItem("isUsedVersion160509",!0),void 0!==localStorage.getItem("isUsedVersion160422")&&localStorage.removeItem("isUsedVersion160422")))}}}),this.corralButton=e)))},IDE_Morph.prototype.createCorralBar=function(t){var e;IDEMorph;e=document.getElementById("ide-corral-bar"),this.corralBar=e,e.style.top=this.stage.bottom()+"px",e.style.left=this.stage.left()-1+"px",e.style.width=this.stage.width()+2+"px",e.style.display=""},IDE_Morph.prototype.createCorral=function(){var t,e,o=this;this.corral&&this.corral.destroy(),this.corral=new BoxMorph(6,4,this.corralBorderColor),this.corral.color=this.corralColor,this.add(this.corral),t=new ScrollFrameMorph(null,9,this.sliderColor),t.acceptsDrops=!1,t.contents.acceptsDrops=!1,t.contents.wantsDropOf=function(t){return t instanceof SpriteIconMorph},t.contents.reactToDropOf=function(t){o.corral.reactToDropOf(t)},t.alpha=0,this.sprites.asArray().forEach(function(o){e=new SpriteIconMorph(o,e),t.contents.add(e)}),this.corral.frame=t,this.corral.add(t),this.corral.fixLayout=function(){var t=8;this.frame.setTop(this.top()+1.5*t),this.frame.setLeft(this.left()+3*t),this.frame.setExtent(new Point(this.right()-this.frame.left()-t,this.height()-t)),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var t=this.frame.left(),e=this.frame.top(),i=this.frame.right(),r=this.frame.left(),s=5;o.isSmallStage?this.frame.contents.children.forEach(function(o){var i=o.width();o.setPosition(new Point(t,e)),t+=i+s}):this.frame.contents.children.forEach(function(o){var s=o.width();t+s>i&&(t=r,e+=o.height()+5),o.setPosition(new Point(t,e)),t+=s+10}),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new SpriteIconMorph(t)),this.fixLayout()},this.corral.refresh=function(){this.frame.contents.children.forEach(function(t){t instanceof SpriteIconMorph&&t.refresh()})},this.corral.wantsDropOf=function(t){return t instanceof SpriteIconMorph},this.corral.reactToDropOf=function(t){var e=1,i=t.position();t.destroy(),this.frame.contents.children.forEach(function(t){(i.gt(t.position())||i.y>t.bottom())&&(e+=1)}),o.sprites.add(t.object,e),o.createCorral(),o.fixLayout()}},IDE_Morph.prototype.fixLayout=function(t){var e,o=this.padding;Morph.prototype.trackChanges=!1,e=document.body.querySelector(".stage-decorate"),"refreshPalette"!==t&&(document.querySelector("#SpriteBar").style.visibility="visible",this.stage.setScale(this.isSmallStage?(world.height()-this.corralBarHeight-this.corralHtmlHeight-this.stageDecorateHeight-3*o)/this.stage.dimensions.y:1),this.stage.setTop(this.top()+this.stageDecorateHeight+o),this.stage.setLeft(this.left()+o),e.style.top=this.top()+o+"px",e.style.left=this.stage.left()-this.stageDecorateBorder+"px",e.style.width=this.stage.width()+2*this.stageDecorateBorder+"px",this.createCorralBar(this.isSmallStage),this.createCategories(),this.categories.setLeft(this.stage.right()+o+1),this.categories.setTop(this.top()+o),this.categories.setHeight(this.height()-this.corralHeight-3*o),this.categories.setWidth(this.categoryWidth),this.categoriesHtml.el.style.left=this.categories.left()+"px",this.categoriesHtml.el.style.top=this.categories.top()+"px",this.categoriesHtml.el.style.height=this.categories.height()+"px",this.categoriesHtml.el.style.width=this.categories.width()+"px",this.createCorralButton(!0)),"refreshPalette"!==t&&(this.spriteEditor.isVisible&&(this.spriteEditor.setTop(this.top()+o),this.spriteEditor.setLeft(this.categories.right()),this.spriteEditor.setExtent(new Point(this.right()-this.spriteEditor.left(),this.height()-this.corralHeight-this.spriteBarHeight-3*o)),this.spriteEditor.fixLayout&&this.spriteEditor.fixLayout()),this.spriteBar.setLeft(this.spriteEditor.left()),document.querySelector("#SpriteBar").style.left=this.spriteEditor.left()+"px",document.querySelector("#SpriteBar").style.top=this.spriteEditor.bottom()+"px",document.querySelector("#SpriteBar").style.height=this.spriteBarHeight+"px",document.querySelector("#SpriteBar").style.width=this.spriteEditor.width()+5+"px",this.spriteBar.setTop(this.spriteEditor.bottom()),this.spriteBar.setExtent(new Point(Math.max(0,this.right()-o-this.spriteBar.left()),this.spriteBarHeight)),this.spriteBar.fixLayout(),document.querySelector("#costume-editor").style.left=this.categories.right()+"px",document.querySelector("#costume-editor").style.height=this.spriteEditor.height()+"px",contains(["selectSprite","tabEditor"],t)||(this.createCorralHtml(!0),this.corral.setHeight(this.corralHeight-3),this.corral.setLeft(this.left()+this.corralHtmlWidth+o-10),this.corral.setBottom(this.bottom()-o-3),this.corral.setWidth(this.right()-this.corral.left()-this.corralButtonWidth-o+10),this.corral.fixLayout())),this.palette.setLeft(this.spriteEditor.left()),this.palette.setTop(this.spriteEditor.top()),this.palette.setHeight(this.spriteEditor.height()),this.palette.removeShadow(),this.palette.addShadow(new Point(1,1),.3,SpriteMorph.prototype.paletteColor.darker(50)),Morph.prototype.trackChanges=!0,this.changed()},IDE_Morph.prototype.createCorralHtml=function(){var t=this;this.corralHtml.style.display="",this.corralHtml.style.bottom=t.padding+"px",this.corralHtml.style.left=this.left()+t.padding+"px",this.corralHtml.style.width=this.corralHtmlWidth+"px",this.corralHtml.style.height=this.corralHtmlHeight+"px",this.corralHtml.el||(this.corralHtml.el=document.getElementById("ide-corral"),this.corralHtml.stageCostumeEl=this.corralHtml.el.querySelector(".stage-button .icon-costume"),this.corralHtml.vm=new Vue({el:"#ide-corral",data:{active:!1},computed:{currentStage:function(){return t.stage},currentClass:function(){return{active:this.active}}},methods:{refresh:function(){this.active=t.currentSprite===t.stage,t.corralHtml.stageCostumeEl.innerHTML="",t.corralHtml.stageCostumeEl.appendChild(t.stage.thumbnail(new Point(t.stageIconWidth,t.stageIconHeight)))},clickStage:function(){t.currentSprite=t.stage,t.selectSprite(t.stage),"costumes"===t.currentTab?CostumeEditor.refresh(myself.object.costumes.contents):"sounds"===t.currentTab&&SoundEditor.refresh()},openSettings:function(){"use strict";CostumeEditor.show()}}}),this.corralHtml.refresh=function(){t.stage.isRunning||t.corralHtml.vm.refresh()},this.corralHtml.el.addEventListener("wearcostume",this.corralHtml.refresh)),this.corralHtml.refresh()},IDE_Morph.prototype.setProjectName=function(t){var e=IDEMorph;e.projectName=t.replace(/['"]/g,""),e.hasChangedMedia=!0,e.controlBar.vm.projectName=e.projectName},IDE_Morph.prototype.setExtent=function(t){var e,o,i=new Point(430,110);e=this.isAppMode?StageMorph.prototype.dimensions:this.isSmallStage?i.add(StageMorph.prototype.dimensions.divideBy(2)):i.add(StageMorph.prototype.dimensions),o=t.max(e),IDE_Morph.uber.setExtent.call(this,o),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.uploadedImage=function(t,e){
return e.contents=t,e.isTainted()?void this.inform("不可以这样导入图片哦","这样导入进来会导致错误的哦。"):(e.shrinkToFit(e.maxExtent()),e.rotationCenter=e.center(),e.version=Date.now(),this.currentSprite.wearCostume(e),CostumeEditor.show(),void(this.hasChangedMedia=!0))},IDE_Morph.prototype.droppedImage=function(t,e){var o=new Costume(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));if(o.isTainted())return void this.inform("不可以这样进行导入哦","这样直接拖进来会导致错误的哦。");this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o);var i=o.contents.toDataURL("image/png"),r=new CDNUpload;r.getToken(i,function(t){o.src=t.src},{img:o.contents,src:r.url}),CostumeEditor.show(),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedSVG=function(t,e){var o=new SVG_Costume(t,e.split(".")[0]);this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),CostumeEditor.show(),this.hasChangedMedia=!0,this.showMessage("SVG costumes are\nnot yet fully supported\nin every browser",2)},IDE_Morph.prototype.droppedAudio=function(t,e){this.currentSprite.addSound(t,e.split(".")[0]),SoundEditor.show(),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedText=function(t,e){var o=e?e.split(".")[0]:"";return 0===t.indexOf("<project")?this.openProjectString(t):0===t.indexOf("<snapdata")?this.openCloudDataString(t):0===t.indexOf("<blocks")?this.openBlocksString(t,o,!0):0===t.indexOf("<sprites")?this.openSpritesString(t):0===t.indexOf("<media")?this.openMediaString(t):void 0},IDE_Morph.prototype.droppedBinary=function(t,e){function o(t,e){var o=new sb.Reader,i=e.split(".")[0];o.onload=function(t){r.droppedText((new sb.XMLWriter).write(i,t))},o.readYPR(new Uint8Array(t))}var i=document.getElementById("ypr"),r=this,s=e.substring(e.length-3);"ypr"===s.toLowerCase()&&(i?o(t,e):(i=document.createElement("script"),i.id="ypr",i.onload=function(){o(t,e)},document.head.appendChild(i),i.src="ypr.js"))},IDE_Morph.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e)},IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():this.runScripts()},IDE_Morph.prototype.refreshSpriteCoordinate=function(){var t=this.currentSprite.costume?this.currentSprite.rotationOffset:this.currentSprite.extent().divideBy(2);this.currentSprite instanceof SpriteMorph&&null!=this.spriteBar&&(this.SpriteBarVM.x=Math.round((this.currentSprite.bounds.origin.x+t.x-this.stage.center().x)/this.stage.scale),this.SpriteBarVM.y=Math.round((this.stage.center().y-this.currentSprite.bounds.origin.y-t.y)/this.stage.scale))},IDE_Morph.prototype.upload=function(){document.createElement("a");this.isUploadStage=!0,this.isUploadCostume=!1},IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage)},IDE_Morph.prototype.isPaused=function(){return this.stage?this.stage.threads.isPaused():!1},IDE_Morph.prototype.stopAllScripts=function(){this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(t){this.currentSprite=t,CostumeEditor.refresh(),SoundEditor.refresh(),this.createPalette(),this.hidePalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs(),this.SpriteBarVM.name=this.currentSprite.name,this.SpriteBarVM.x=this.currentSprite.xPosition&&this.currentSprite.xPosition(),this.SpriteBarVM.y=this.currentSprite.yPosition&&this.currentSprite.yPosition(),this.SpriteBarVM.heading=Math.round(this.currentSprite.heading),this.SpriteBarVM.scale=this.currentSprite.getScale&&Math.round(this.currentSprite.getScale()),this.SpriteBarVM.hidden=!this.currentSprite.isVisible,this.SpriteBarVM.draggable=this.currentSprite.isDraggable,this.SpriteBarVM.rs=this.currentSprite.rotationStyle,this.corralHtml.refresh&&this.corralHtml.refresh()},IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var t;if(Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(e){this.showMessage("Serialization failed: "+e)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(t)},IDE_Morph.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),o=this.getSetting("language"),i=(this.getSetting("click"),this.getSetting("longform")),r=this.getSetting("longurls"),s=this.getSetting("plainprototype");"flat"===t?this.setFlatDesign():this.setDefaultDesign(),e&&(SyntaxElementMorph.prototype.setScale(Math.min(e,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),o&&"en"!==o?this.userLanguage="zh":this.userLanguage="zh",i&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),r?this.projectsInURLs=!0:this.projectsInURLs=!1,s&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(t,e){localStorage&&(localStorage["-snap-setting-"+t]=e)},IDE_Morph.prototype.getSetting=function(t){return localStorage?localStorage["-snap-setting-"+t]:null},IDE_Morph.prototype.removeSetting=function(t){localStorage&&delete localStorage["-snap-setting-"+t]},IDE_Morph.prototype.addSprite=function(){openAddActor()},IDE_Morph.prototype.addNewSprite=function(){this.isUploadStage=!1,this.isUploadCostume=!1,materialVM.displayMaterialWindow=!0},IDE_Morph.prototype.paintNewSprite=function(){var t=new Costume,e=this;CostumeEditor&&CostumeEditor.show(),t.edit(this.world(),this,!0,null,function(){var o=new SpriteMorph(e.globalVariables);o.name=e.newSpriteName(o.name),o.setCenter(e.stage.center()),e.stage.add(o),e.sprites.add(o),e.corral.addSprite(o),e.selectSprite(o),o.addCostume(t),CostumeEditor.refresh()})},IDE_Morph.prototype.paintNewCostume=function(){var t=this.currentSprite;cos=new Costume,myself=this,cos.edit(this.world(),this,!0,null,function(){t.addCostume(cos),t.wearCostume(cos),CostumeEditor.show()})},IDE_Morph.prototype.duplicateSprite=function(t){var e=t.fullCopy();e.setPosition(this.world().hand.position()),e.appearIn(this),e.keepWithin(this.stage),this.selectSprite(e)},IDE_Morph.prototype.removeSprite=function(t){var e,o=this;t.parts.forEach(function(t){o.removeSprite(t)}),e=this.sprites.asArray().indexOf(t)+1,this.stage.threads.stopAllForReceiver(t),t.destroy(),this.stage.watchers().forEach(function(e){e.object()===t&&e.destroy()}),e>0&&this.sprites.remove(e),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(t){return t instanceof SpriteMorph})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSpriteName=function(t,e){for(var o=t.indexOf("("),i=0>o?t:t.substring(0,o),r=-1,s=i,n=this.sprites.asArray().concat(this.stage).filter(function(t){return t!==e}).map(function(t){return t.name});contains(n,s);)r+=1,s=i+"("+r+")";return s},IDE_Morph.prototype.userMenu=function(){var t=new MenuMorph(this);return t},IDE_Morph.prototype.getCostumesList=function(t){var e,o=[];return e=this.getURL(t),e.split("\n").forEach(function(t){var e,i,r=t.search(new RegExp('href="[^./?].*"'));r>0&&(i=t.substring(r+6),e=i.search(new RegExp('"')),i=i.substring(0,e),o.push(i))}),o.sort(function(t,e){return e>t?-1:1}),o},IDE_Morph.prototype.aboutCodemao=function(){var t,e,o,i,r,s,n,a,h,p,l="",c=this.world();e="编程猫\n做最有趣的儿童教育\n\n编程猫是一个创新的儿童教育品牌，专注于为8-12岁的孩子提供免费的少儿编程教育。\n编程猫采用一对一真人实时在线 互动授课，通过极具参与性的视频教学模式和沉浸式\n的智能交互体验，让孩子在不知不觉中掌握大学里才能学到的编程知识。并突破了传统\n教育的时间和地点限制，在家即可上课，目前已有超过3000名小朋友进入了编程猫的数码王国！\n\n\n了解更多信息参见 http://biancm.com\n",o="这段文字还没有写出来~";for(r in modules)Object.prototype.hasOwnProperty.call(modules,r)&&(l+="\n"+r+" ("+modules[r]+")");""!==l&&(l=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+l),i=localize("Translations")+"\n"+CmTranslator.credits(),t=new DialogBoxMorph,t.inform("About Snap",e,c),s=t.buttons.children[0],p=t.addButton(function(){t.body.text=i,t.body.drawNew(),s.show(),n.show(),a.hide(),h.hide(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(c.center())},"Translators..."),n=t.addButton(function(){t.body.text=e,t.body.drawNew(),s.show(),n.hide(),a.show(),h.show(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(c.center())},"Back..."),n.hide(),a=t.addButton(function(){t.body.text=l,t.body.drawNew(),s.show(),n.show(),a.hide(),h.hide(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(c.center())},"Modules..."),h=t.addButton(function(){t.body.text=o,t.body.drawNew(),s.show(),n.show(),p.show(),a.hide(),h.hide(),t.fixLayout(),t.drawNew(),t.setCenter(c.center())},"Credits..."),p.hide(),t.fixLayout(),t.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var t=(new DialogBoxMorph).withKey("projectNotes"),e=new ScrollFrameMorph,o=new TextMorph(this.projectNotes||""),i=t.ok,r=this,s=250,n=this.world();e.padding=6,e.setWidth(s),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(s-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(s),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.ok=function(){r.projectNotes=o.text,i.call(this)},t.justDropped=function(){o.edit()},t.labelString="Project Notes",t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(n),t.setCenter(n.center()),o.edit()},IDE_Morph.prototype.newProject=function(){if(this.isProjectNew=!0,this.parentId=null,codemao.id)this.openProjectString(codemao.preloadXML),this.id=codemao.id,this.isProjectNew=!1,codemao.parentid&&(this.parentId=codemao.parentid);else if(codemao.preloadXML)IDEMorph.openProjectString(codemao.preloadXML);else{this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.currentSprite.name="编程猫",this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(310,450),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,SpriteMorph.prototype.useFlatLineEnds=!1,codemao.preloadConfig.lessonName?IDEMorph.setProjectName(codemao.preloadConfig.lessonName):this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout();var t,e=this,o=new Costume(null,"编程猫");this.currentSprite.addCostume(o);var i=new Image;i.crossOrigin="anonymous",i.onload=function(){t=newCanvas(new Point(i.width,i.height)),t.getContext("2d").drawImage(i,0,0),o.contents=t,o.shrinkToFit(o.maxExtent()),o.rotationCenter=o.center(),o.src="http://7xpmmk.com2.z0.glb.qiniucdn.com/runningcat.png",o.version=Date.now(),e.currentSprite.wearCostume(o)},i.src="http://7xpmmk.com2.z0.glb.qiniucdn.com/runningcat.png"}},IDE_Morph.prototype.save=function(t){IDEMorph.isProjectNew?SaveProjectDialog.show(t):IDEMorph.saveProject(IDEMorph.projectName,t)},IDE_Morph.prototype.checkUploading=function(t){"use strict";var e=this;CDNUpload&&CDNUpload.prototype.uploadingList.length>0?savingMessage.$savingWindow.is(":visible")&&(this.savingCheckCount>20?(alert("保存失败，请稍后再试"),savingMessage.$savingWindow.hide(),savingMessage.$savingCancel.hide(),savingMessage.$savingMessage.hide()):(++this.savingCheckCount,setTimeout(function(){e.checkUploading(t)},500))):e.rawSaveProject(t)},IDE_Morph.prototype.saveProject=function(t,e){var o=this,i=null;this.savingCheckCount=0,e||(e={}),$.ajax({type:"GET",url:window.codemao.apiServer+"/work/list?type=old",async:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(r){r?o.projectList=r.data:console.log("读取项目列表失败"),t&&(detect(o.projectList,function(e){return e.workName===t&&e.id!=o.id?(i=e,!0):void 0})?o.confirm(t+"已存在，是否进行替换？","替换项目",function(){e.name=t,e.id=i.id,savingMessage.saving(o.checkUploading,o,e)}):(e.name=t,e.id=o.id,savingMessage.saving(o.checkUploading,o,e)))}})},IDE_Morph.prototype.judgeBlocks=function(t,e,o,i){function r(t,e){if(t instanceof BlockMorph){++e;for(var i=0;i<o.length;++i)if(o[i]&&o[i]===t.selector){o.splice(i,1);break}}for(var s=0;s<t.children.length;++s)e=r(t.children[s],e);return e}var s=t.children[t.children.length-1];++e,++i;for(var n=0;n<o.length;++n)o[n]&&o[n]===t.selector&&o.splice(n,1);for(var a=0;a<t.children.length-1;++a)i=r(t.children[a],i);return s instanceof BlockMorph?IDEMorph.judgeBlocks(s,e,o,i):(i=r(s,i),[e,i])},IDE_Morph.prototype.judgeScripts=function(t){var e,o,i,r,s,n=0,a=0,h=0,p=0,l=t||{};e=l.spriteNum||0,o=l.scriptNum||0,i=l.scriptLvl||0,s=l.totalBlock||0,r=l.needBlock||[],r=r.slice(0);var c=r;return n=this.sprites.contents.length,this.sprites.contents.forEach(function(t){var e=0;t.scripts.children.forEach(function(t){var o=[0,0];t instanceof HatBlockMorph&&(++e,o=IDEMorph.judgeBlocks(t,o[0],c,o[1]),o[0]>h&&(h=o[0]),p+=o[1])}),e>a&&(a=e)}),n>=e&&a>=o&&h>=i&&p>=s&&0===c.length?{spriteNum:n,maxScriptNum:a,maxScriptLvl:h,lackBlocks:c,Total:p,isPass:!0}:{spriteNum:n,maxScriptNum:a,maxScriptLvl:h,lackBlocks:c,Total:p,isPass:!1}},IDE_Morph.prototype.rawSaveProject=function(t){var e,o=this,i=t.name;if(i){this.setProjectName(i),1!=codemao.isLesson&&(IDEMorph.stage.thumbnailIsUploadCdn=!0,IDEMorph.stage.isProductThumbnail=!0);var r,s=this.serializer.serialize(this.stage);if(!s)return alert("保存失败"),!1;r=s;try{e=codemao.preloadConfig&&codemao.preloadConfig.judgement?this.judgeScripts(codemao.preloadConfig.judgement).isPass:"No Judge Info"}catch(n){e=n}var a=this.projectName,h=(this.parentId,this.stage.thumbnailUrl),p="POST",l=window.codemao.apiServer+"/work";t.id&&(p="PUT",l=window.codemao.apiServer+"/work/"+t.id),$.ajax({type:p,url:l,data:{href:r,name:a,preview:h,isOld:"yes"},xhrFields:{withCredentials:!0},async:!0,success:function(e){console.log("成功"),o.isProjectNew=!1,o.id=t.id;try{e.data&&e.data.id&&(IDEMorph.id=e.data.id,t.id=e.data.id)}catch(i){console.log("保存信息获取失败：可能是因为返回信息不符合JSON格式。\n"+i)}savingMessage.saved(),t.callback&&t.callback.call(t.callbackTarget,t)}})}},IDE_Morph.prototype.savePerStep=function(t,e){this.stage.thumbnailIsUploadCdn=!1,this.stage.isProductThumbnail=!1;var o,i=this.serializer.serialize(this.stage);if(!i)return alert("保存失败"),!1;o=i;try{pass=codemao.preloadConfig&&codemao.preloadConfig.judgement?this.judgeScripts(codemao.preloadConfig.judgement).isPass:"No Judge Info"}catch(r){pass=r}var s="POST",n=window.codemao.apiServer+"/work/teaching/"+t;$.ajax({type:s,url:n,data:{href:o,token:window.codemao.token},xhrFields:{withCredentials:!0},async:!0,success:function(t){console.log("成功"),e(t)}})},IDE_Morph.prototype.saveProjectToDisk=function(){var t,e=document.createElement("a");if(Process.prototype.isCatchingErrors)try{this.stage.isProductThumbnail=!1,this.stage.thumbnailIsUploadCdn=!1,t=this.serializer.serialize(this.stage),e.setAttribute("href","data:text/xml,"+t),e.setAttribute("download",this.projectName+".xml"),document.body.appendChild(e),e.click(),document.body.removeChild(e)}catch(o){this.showMessage("Saving failed: "+o)}else this.stage.isProductThumbnail=!1,this.stage.thumbnailIsUploadCdn=!1,t=this.serializer.serialize(this.stage),e.setAttribute("href","data:text/xml,"+t),e.setAttribute("download",this.projectName+".xml"),document.body.appendChild(e),e.click(),document.body.removeChild(e)},IDE_Morph.prototype.exportProject=function(t,e){var o,i;if(t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{o=this.showMessage("Exporting"),i=encodeURIComponent(this.serializer.serialize(this.stage)),this.setURL("#open:"+i),window.open("data:text/"+(e?"plain,"+i:"xml,"+i)),o.destroy(),this.showMessage("Exported!",1)}catch(r){this.showMessage("Export failed: "+r)}else o=this.showMessage("Exporting"),i=encodeURIComponent(this.serializer.serialize(this.stage)),this.setURL("#open:"+i),window.open("data:text/"+(e?"plain,"+i:"xml,"+i)),o.destroy(),this.showMessage("Exported!",1)},IDE_Morph.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},IDE_Morph.prototype.exportSprite=function(t){var e=this.serializer.serialize(t.allParts()),o=document.createElement("a"),i=new Blob(['<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>"]);if(document.all){var r=document.createEvent("HTMLEvents");r.initEvent("click",!1,!1),o.download=t.name+".xml",o.href=URL.createObjectURL(i),o.dispatchEvent(r)}else{var r=document.createEvent("MouseEvents");r.initEvent("click",!1,!1),o.download=t.name+".xml",o.href=URL.createObjectURL(i),o.dispatchEvent(r)}},IDE_Morph.prototype.exportScriptsPicture=function(){var t,e,o=[],i=20,r=0,s=0,n=0;return this.sprites.asArray().forEach(function(t){o.push(t.image),o.push(t.scripts.scriptsPicture()),t.customBlocks.forEach(function(t){o.push(t.scriptsPicture())})}),o.push(this.stage.image),o.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(t){o.push(t.scriptsPicture())}),this.stage.globalBlocks.forEach(function(t){o.push(t.scriptsPicture())}),o=o.filter(function(t){return!isNil(t)}),o.forEach(function(t){r=Math.max(r,t.width),s+=t.height,s+=i}),s-=i,t=newCanvas(new Point(r,s)),e=t.getContext("2d"),o.forEach(function(t){e.drawImage(t,0,n),n+=i,n+=t.height}),t.toDataURL()},IDE_Morph.prototype.sendScriptsPicture=function(){"use strict";var t;t=this.exportScriptsPicture();var e=new CDNUpload;e.getToken(t,function(t){openPostWindow(t.src)})},IDE_Morph.prototype.openProjectString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("打开中...")},function(){nop()},function(){o.rawOpenProjectString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenProjectString=function(t){if(CostumeEditor.hide(),SoundEditor.hide(),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(t,this),this)}catch(e){this.showMessage("读取失败: "+e)}else this.serializer.openProject(this.serializer.load(t,this),this);this.stopFastTracking(),this.stage.dimensions!=new Point(310,450)&&this.setStageExtent(new Point(310,450)),this.controlBar.vm.projectName=this.projectName},IDE_Morph.prototype.openCloudDataString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("打开中...")},function(){nop()},function(){o.rawOpenCloudDataString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenCloudDataString=function(t){var e;if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this)}catch(o){this.showMessage("Load failed: "+o)}else e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this);this.stopFastTracking(),this.toggleAppMode(!0)},IDE_Morph.prototype.openBlocksString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("读取积木中")},function(){nop()},function(){r.rawOpenBlocksString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var i,r=this;if(Process.prototype.isCatchingErrors)try{i=this.serializer.loadBlocks(t,r.stage)}catch(s){this.showMessage("Load failed: "+s)}else i=this.serializer.loadBlocks(t,r.stage);o?(i.forEach(function(t){t.receiver=r.stage,r.stage.globalBlocks.push(t),r.stage.replaceDoubleDefinitionsFor(t)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2)):new BlockImportDialogMorph(i,this.stage,e).popUp()},IDE_Morph.prototype.openSpritesString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("读取角色中")},function(){nop()},function(){o.rawOpenSpritesString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(e){this.showMessage("Load failed: "+e)}else this.serializer.loadSprites(t,this)},IDE_Morph.prototype.openMediaString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(e){this.showMessage("Load failed: "+e)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openProject=function(t){var e;t&&(this.showMessage("读取项目中\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],this.openProjectString(e),this.setURL("#open:"+e))},IDE_Morph.prototype.setURL=function(t){this.projectsInURLs&&(location.hash=t)},IDE_Morph.prototype.switchToUserMode=function(){var t=this.world();t.isDevMode=!1,Process.prototype.isCatchingErrors=!0,this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(t.bounds.copy()),this.siblings().forEach(function(e){e instanceof DialogBoxMorph?t.add(e):e.destroy()}),this.flushBlocksCache(),this.refreshPalette(),t.reactToDropOf=function(e){e instanceof DialogBoxMorph||t.hand.grab(e)},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(t){t?(this.stage.blocksCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.blocksCache[t]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache={})})),this.flushPaletteCache(t)},IDE_Morph.prototype.flushPaletteCache=function(t){t?(this.stage.paletteCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.paletteCache[t]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var t=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(e){(e instanceof SpriteMorph||e instanceof StageMorph)&&(t=t.concat(e.scripts.children.filter(function(t){return t instanceof BlockMorph})))}),t.forEach(function(t){t.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){var t;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(e){this.showMessage("Serialization failed: "+e)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),CostumeEditor.hide(),SoundEditor.hide(),this.createCategories(),this.createCorralBar(),this.openProjectString(t)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){InputSlotMorph.prototype.executeOnSliderEdit=!InputSlotMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.toggleAppMode=function(t){var e=this.world(),o=[this.corral,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(t)?!this.isAppMode:t,Morph.prototype.trackChanges=!1,this.isAppMode?(this.color=new Color(134,134,134),this.drawNew(),o.forEach(function(t){t.hide()}),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.hide()}),"costumes"===this.currentTab?CostumeEditor.hide():"sounds"===this.currentTab&&SoundEditor.hide()):(this.color=IDE_Morph.prototype.backgroundColor,this.drawNew(),o.forEach(function(t){t.isScriptHide||t.show()}),this.stage.setScale(1),e.children.forEach(function(t){t instanceof DialogBoxMorph&&!t.isScriptHide&&t.show()}),e.allChildren().filter(function(t){return t instanceof ScrollFrameMorph}).forEach(function(t){t.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(t){t instanceof PushButtonMorph&&t.hide()}),"costumes"===this.currentTab?CostumeEditor.show():"sounds"===this.currentTab&&SoundEditor.show(),this.categories.trashBox&&this.hideTrashBox()),this.setExtent(this.world().extent())},IDE_Morph.prototype.toggleStageSize=function(t){function e(){r.isSmallStage=isNil(t)?!r.isSmallStage:t}function o(){r.step=function(){r.stageRatio-=(r.stageRatio-s)/2,r.setExtent(n.extent()),r.stageRatio<s+.1&&(r.stageRatio=s,r.setExtent(n.extent()),delete r.step)}}function i(){r.step=function(){r.stageRatio+=(1-r.stageRatio)/2,r.setExtent(n.extent()),r.stageRatio>.9&&(r.stageRatio=1,r.isSmallStage=!1,r.setExtent(n.extent()),delete r.step)}}var r=this,s=.5,n=this.world();16===n.currentKey;s=(n.height()-this.corralBarHeight)/this.stage.height(),e(),this.isAnimating?this.isSmallStage?o():i():(this.isSmallStage&&(this.stageRatio=s),this.setExtent(n.extent())),this.createCorral()},IDE_Morph.prototype.createNewProject=function(){var t=IDEMorph;confirmDialog&&(confirmDialog.vm?confirmDialog.build("新建","是否保存当前作品？",function(e){e?t.save({callback:t.newProject,callbackTarget:t}):t.newProject()}):confirmDialog.build("新建","是否保存当前作品？",function(e){e?t.save({callback:t.newProject,callbackTarget:t}):t.newProject()}))},IDE_Morph.prototype.saveProjectsBrowser=function(t,e){new ProjectDialogMorph(IDEMorph,"save",t,e).popUp()},IDE_Morph.prototype.setLanguage=function(t,e){var o=document.getElementById("language"),i="build/js/snap-translations/lang-"+t+".js",r=this;return CmTranslator.unload(),o&&document.head.removeChild(o),"en"===t?this.reflectLanguage("en",e):(o=document.createElement("script"),o.id="language",o.onload=function(){r.reflectLanguage(t,e)},document.head.appendChild(o),void(o.src=i))},IDE_Morph.prototype.reflectLanguage=function(t,e){var o;if(CmTranslator.language="zh",!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{o=this.serializer.serialize(this.stage)}catch(i){this.showMessage("序列化失败: "+i)}else o=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),CostumeEditor.hide(),SoundEditor.hide(),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.newProject(),this.saveSetting("language","zh"),e&&e.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var t,e,o,i,r,s=this;t=new CommandBlockMorph,t.color=SpriteMorph.prototype.blockColor.motion,t.setSpec(localize("build")),e=new CommandBlockMorph,e.color=SpriteMorph.prototype.blockColor.sound,e.setSpec(localize("your own")),t.nextBlock(e),e=new CommandBlockMorph,e.color=SpriteMorph.prototype.blockColor.operators,e.setSpec(localize("blocks")),t.bottomBlock().nextBlock(e),i=new FrameMorph,i.acceptsDrops=!1,i.color=IDE_Morph.prototype.groupColor,i.cachedTexture=this.scriptsPaneTexture,i.setExtent(new Point(250,180)),t.setPosition(i.position().add(10)),i.add(t),o=new Morph,o.alpha=0,o.setExtent(i.extent()),o.setPosition(i.position()),i.add(o),r=function(e){t.blockSequence().forEach(function(t){t.setScale(e),t.drawNew(),t.setSpec(t.blockSpec)})},new DialogBoxMorph(null,function(t){s.setBlocksScale(Math.min(t,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),i,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,r)},IDE_Morph.prototype.setBlocksScale=function(t){var e;if(Process.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(o){this.showMessage("Serialization failed: "+o)}else e=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(t),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),CostumeEditor.hide(),SoundEditor.hide(),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(310,450),"Stage width","Stage height",this.world(),null,null)},IDE_Morph.prototype.setStageExtent=function(t){var e=(this.world(),t.max(StageMorph.prototype.defaultSize));StageMorph.prototype.dimensions=e,this.fixLayout()},IDE_Morph.prototype.initializeCloud=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){var o,i=hex_sha512(e.password);SnapCloud.login(e.username,i,function(){e.choice&&(o=SnapCloud.encodeDict({username:e.username,password:i}),localStorage["-snap-user"]=o),t.source="cloud",t.showMessage("now connected.",2)},t.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.signup(o.username,o.email,function(o,i){(new DialogBoxMorph).inform(i,o+".\n\nAn e-mail with your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.resetCloudPassword=function(){
var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.resetPassword(o.username,function(o,i){(new DialogBoxMorph).inform(i,o+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){SnapCloud.changePassword(e.oldpassword,e.password,function(){t.logout(),t.showMessage("password has been changed.",2)},t.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.logout=function(){var t=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),t.showMessage("disconnected.",2)},function(){SnapCloud.clear(),t.showMessage("disconnected.",2)})},IDE_Morph.prototype.saveProjectToCloud=function(t){var e=this;t&&(this.showMessage("Saving project\nto the cloud..."),this.setProjectName(t),SnapCloud.saveProject(this,function(){e.showMessage("saved.",2)},this.cloudError()))},IDE_Morph.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),encodeURIComponent(this.serializer.serialize(this.stage)),o=encodeURIComponent(this.serializer.mediaXML(t)),window.open("data:text/xml,"+o),e.destroy(),this.showMessage("Exported!",1)}catch(i){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+i)}else e=this.showMessage("Exporting"),encodeURIComponent(this.serializer.serialize(this.stage)),o=encodeURIComponent(this.serializer.mediaXML()),window.open("data:text/xml,"+o),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=encodeURIComponent(this.serializer.serialize(this.stage)),window.open("data:text/xml,"+o),e.destroy(),this.showMessage("Exported!",1)}catch(i){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+i)}else e=this.showMessage("Exporting"),o=encodeURIComponent(this.serializer.serialize(this.stage)),window.open("data:text/xml,"+o),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(t){var e,o,i,r;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=encodeURIComponent(this.serializer.serialize(this.stage)),i=encodeURIComponent(this.serializer.mediaXML(t)),r=encodeURIComponent("<snapdata>")+o+i+encodeURIComponent("</snapdata>"),window.open("data:text/xml,"+r),e.destroy(),this.showMessage("Exported!",1)}catch(s){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+s)}else e=this.showMessage("Exporting"),o=encodeURIComponent(this.serializer.serialize(this.stage)),i=encodeURIComponent(this.serializer.mediaXML()),r=encodeURIComponent("<snapdata>")+o+i+encodeURIComponent("</snapdata>"),window.open("data:text/xml,"+r),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var t=this;return function(e,o){nop(e),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+o,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var t=this;return function(e,o){var i=e;i.length>50&&(i=i.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+o+":\n\nresponds:\n"+i,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var t=this;return function(e,o){var i=e,r=null;return t.shield&&(t.shield.destroy(),t.shield=null),r?void t.showMessage(r):(i.length>50&&(i=i.substring(0,50)+"..."),void(new DialogBoxMorph).inform("Snap!Cloud",(o?o+"\n":"")+i,t.world(),t.cloudIcon(null,new Color(180,0,0))))}},IDE_Morph.prototype.cloudIcon=function(t,e){var o=e||DialogBoxMorph.prototype.titleBarColor,i=MorphicPreferences.isFlat,r=new SymbolMorph(i?"cloud":"cloudGradient",t||50,o,i?null:new Point(-1,-1),o.darker(50));return r},IDE_Morph.prototype.getURL=function(t){var e=new XMLHttpRequest,o=this;try{if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(i){return void o.showMessage(i)}},IDE_Morph.prototype.getXmlURL=function(t){var e=this;$.ajax({url:window.codemao.apiServer+"/work/"+t.id,type:"GET",async:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(o){o&&o.data&&(e.id=t.id,e.openProjectString(o.data.config))}})},IDE_Morph.prototype.getthumbnailXmlURL=function(t){var e,o=encodeURIComponent(t);return $.ajax({url:"action/get_thumbnail.php",type:"GET",async:!1,dataType:"json",cache:!0,data:{path:o},success:function(t){e=t.data.thumbnail[0]}}),e},IDE_Morph.prototype.showMessage=function(t,e){var o,i=new MenuMorph(null,t);return i.popUpCenteredInWorld(this.world()),e&&(o=setInterval(function(){i.destroy(),clearInterval(o)},1e3*e)),i},IDE_Morph.prototype.inform=function(t,e){(new DialogBoxMorph).inform(t,localize(e),this.world())},IDE_Morph.prototype.confirm=function(t,e,o){new DialogBoxMorph(null,o).askYesNo(e,localize(t),this.world())},IDE_Morph.prototype.confirmCancel=function(t,e,o){new DialogBoxMorph(null,o).askYesNoCancel(e,localize(t),this.world())},IDE_Morph.prototype.prompt=function(t,e,o,i){new DialogBoxMorph(null,e).withKey(i).prompt(t,"",this.world(),null,o)},ProjectDialogMorph.prototype=new DialogBoxMorph,ProjectDialogMorph.prototype.constructor=ProjectDialogMorph,ProjectDialogMorph.uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.savetocloud=function(){var t=this.nameField.contents().text.text,e=this.notesText.text,o=this;this.ide.projectNotes=e||this.ide.projectNotes,t&&(detect(this.projectList,function(e){return e.name===t})?this.ide.confirm(localize("确定要替换掉")+'\n"'+t+'"?',"替换项目",function(){savingMessage.saving(o.rawSaveProject,o,t)}):savingMessage.saving(o.rawSaveProject,o,t))},ProjectDialogMorph.prototype.init=function(t,e,o,i){var r=this;this.ide=t,this.task=e||"open",this.param={callback:o,target:i},this.source="cloud",this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,this.buildContents(),this.onNextStep=function(){r.getProjectList(r.source)}},ProjectDialogMorph.prototype.buildContents=function(){var t,e;this.addBody(new Morph),this.body.color=this.color,"save"===this.task&&(this.projectNameTxt=new TextMorph("名字:"),this.projectNameTxt.fontSize=20,this.projectNameTxt.fontStyle="Microsoft YaHei",this.projectNameTxt.setColor(new Color(134,134,134)),this.body.add(this.projectNameTxt),this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.color=new Color(255,255,255),this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){var t=this.image.getContext("2d");t.drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(new Point(320,180)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.color=new Color(255,255,255),this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","分享"),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new Point(810,485).add(e.extent())):this.setExtent(new Point(810,485)),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(t){var e=t||this.ide.world();e&&ProjectDialogMorph.uber.popUp.call(this,e)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var t=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(e){e.pressColor=t.titleBarBoxColor.darker(20),e.color=new Color(0,0,0,0),e.noticesTransparentClick=!0})},ProjectDialogMorph.prototype.setSource=function(){var t=this;this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.workName}:null,null,function(){t.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(e){var o;void 0!==e&&(t.nameField&&t.nameField.setContents(e.workName||""),t.preview.texture=o,t.notesText.text="正在预览...",t.notesText.drawNew(),t.notesField.contents.adjustBounds(),t.preview.cachedTexture=null,t.preview.drawNew(),t.edit())},this.body.add(this.listField),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.getLocalProjectList=function(){var t,e,o,i=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e=t.substr(14),o={name:e,thumb:null,notes:null},i.push(o));return i.sort(function(t,e){return t.name<e.name?-1:1}),i},ProjectDialogMorph.prototype.getProjectList=function(){var t=this;$.ajax({type:"GET",url:window.codemao.apiServer+"/work/list?type=old",async:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){e?(t.projectList=e.data,t.setSource()):console.log("读取项目列表失败")}})},ProjectDialogMorph.prototype.installCloudProjectList=function(t){var e=this;this.projectList=t||[],this.projectList.sort(function(t,e){return t.ProjectName<e.ProjectName?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.ProjectName}:null,[["bold",function(t){return"true"===t.Public}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.ProjectName||""),"open"===e.task&&(e.notesText.text=t.Notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture=t.Thumbnail||null,e.preview.cachedTexture=null,e.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+t.Updated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),this.shareButton.show(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.openProject=function(){var t=this.listField.selected;t&&(this.ide.source=this.source,this.ide.isProjectNew=!1,this.ide.getXmlURL(t),this.destroy())},ProjectDialogMorph.prototype.saveProject=function(){var t,e=this.nameField.contents().text.text,o=this.notesText.text,i=this,r={};this.ide.createCorralHtml(this.ide.isSmallStage),this.ide.projectNotes=o||this.ide.projectNotes,e&&(detect(this.projectList,function(o){return o.workName===e?(t=o,!0):void 0})?(t=this.listField.selected||t,this.ide.confirm(localize("确定要替换掉")+'\n"'+e+'"?',"替换项目",function(){r.name=e,r.id=t.id,savingMessage.saving(i.ide.rawSaveProject,i.ide,r),i.destroy()})):(r.name=e,r.id=null,savingMessage.saving(i.ide.rawSaveProject,i.ide,r),i.destroy()))},ProjectDialogMorph.prototype.saveCloudProject=function(){var t=this;this.ide.showMessage("Saving project\nto the cloud..."),SnapCloud.saveProject(this.ide,function(){t.ide.source="cloud",t.ide.showMessage("saved.",2)},this.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var t,e=this;t=this.listField.selected,t&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t+'"?',"Delete Project",function(){$.ajax({url:codemao.apiServer+"/work/"+t.id,type:"DELETE",async:!1,dataType:"text",xhrFields:{withCredentials:!0},success:function(t){console.log("成功")}}),e.getProjectList()})},ProjectDialogMorph.prototype.edit=function(){this.nameField&&this.nameField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setLeft(this.left()+15),this.listField.setWidth(450),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(this.body.top()),this.nameField?this.listField.setHeight(this.body.height()-this.nameField.height()-this.padding):(this.listField.setTop(this.body.top()),this.listField.setHeight(this.body.height())),this.nameField&&(this.projectNameTxt.setLeft(this.left()+15),this.projectNameTxt.setTop(this.listField.bottom()+this.padding),this.nameField.setWidth(385),this.nameField.setLeft(this.projectNameTxt.right()+this.padding),this.nameField.setTop(this.listField.bottom()+this.padding),this.nameField.drawNew()),this.preview.setLeft(this.listField.right()+10),this.preview.setTop(this.body.top()),this.notesField.setTop(this.preview.bottom()+10),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},SpriteIconMorph.prototype=new ToggleButtonMorph,SpriteIconMorph.prototype.constructor=SpriteIconMorph,SpriteIconMorph.uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(64,64),SpriteIconMorph.prototype.stageThumbSize=new Point(64,64),SpriteIconMorph.prototype.smallThumbSize=new Point(70,70),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.fontSize=16,SpriteIconMorph.prototype.fontSizeSmall=12,SpriteIconMorph.prototype.labelColor=new Color(65,61,52),SpriteIconMorph.prototype.init=function(t,e,o){var i,r,s,n=this;e||(i=[SpriteIconMorph.prototype.Color,SpriteIconMorph.prototype.highlightColor,SpriteIconMorph.prototype.pressColor]),r=function(){var t=n.parentThatIsA(IDE_Morph);t&&(t.selectSprite(n.object),"costumes"===t.currentTab?CostumeEditor.refresh(n.object.costumes.contents):"sounds"===t.currentTab&&SoundEditor.refresh())},s=function(){var t=n.parentThatIsA(IDE_Morph);return t?t.currentSprite===n.object:!1},this.object=t||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,this.deleteButton=null,this.editorButton=null,SpriteIconMorph.uber.init.call(this,i,null,r,this.object.name,s,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.outline=this.spriteIconOutlineWidth,this.outlineColor=this.spriteIconOutlineColor,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,t=IDEMorph.isSmallStage?this.smallThumbSize:this.thumbSize,this.object instanceof SpriteMorph?(this.thumbnail.setExtent(t),this.thumbnail.image=this.object.fullThumbnail(t),this.add(this.thumbnail),this.createRotationButton(),this.createDeleteButton(),this.createEditorButton()):this.object instanceof StageMorph?(this.thumbnail.setExtent(t),this.thumbnail.image=this.object.thumbnail(t),this.add(this.thumbnail),this.createEditorButton()):(this.thumbnail.setExtent(t),this.thumbnail.image=this.object.thumbnail(t),this.add(this.thumbnail),this.createEditorButton(),this.createDeleteButton())},SpriteIconMorph.prototype.createLabel=function(){var t,e;e=this.fontSizeSmall,this.label&&this.label.destroy(),t=new StringMorph(this.object.name,e,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},SpriteIconMorph.prototype.createEditorButton=function(){var t;t=IDEMorph.isSmallStage?new Point(20,20):new Point(30,30),this.editorButton&&(this.editorButton.destroy(),this.editorButton=null),this.editorButton=new PushButtonMorph(this,"editSprite",null,30),this.editorButton.color="transparent",this.editorButton.highlightColor="transparent",this.editorButton.pressColor=this.editorButton.highlightColor,this.editorButton.labelColor=TurtleIconMorph.prototype.labelColor,this.editorButton.contrast=this.buttonContrast,this.editorButton.hint="编辑角色",this.editorButton.setExtent(t),this.editorButton.setScaledTexture("img/sprite-edit.png",.8,.8,"img/sprite-edit-hover.png","img/sprite-edit.png"),this.editorButton.drawNew(),this.editorButton.fixLayout(),this.editorButton.changed(),this.add(this.editorButton)},SpriteIconMorph.prototype.createDeleteButton=function(){var t;t=IDEMorph.isSmallStage?new Point(20,20):new Point(30,30),this.deleteButton&&(this.deleteButton.destroy(),this.deleteButton=null),this.deleteButton=new PushButtonMorph(this,"removeSprite",null,30),this.deleteButton.color="transparent",this.deleteButton.highlightColor="transparent",this.deleteButton.pressColor=this.deleteButton.highlightColor,this.deleteButton.contrast=this.buttonContrast,this.deleteButton.hint="删除角色",this.deleteButton.setExtent(t),this.deleteButton.setScaledTexture("img/sprite-delete.png",.8,.8,"img/sprite-delete-hover.png","img/sprite-delete.png"),this.deleteButton.drawNew(),this.deleteButton.fixLayout(),this.deleteButton.changed(),this.add(this.deleteButton)},SpriteIconMorph.prototype.createRotationButton=function(){var t,e=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&(t=new ToggleButtonMorph(null,null,function(){e.object.rotatesWithAnchor=!e.object.rotatesWithAnchor},["→","↻"],function(){return e.object.rotatesWithAnchor}),t.corner=8,t.labelMinExtent=new Point(11,11),t.padding=0,t.pressColor=t.color,t.drawNew(),t.fixLayout(),t.refresh(),t.changed(),this.rotationButton=t,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){var t;return this.thumbnail&&this.label?(IDEMorph.isSmallStage?(t=3,this.setWidth(IDEMorph.spriteIconSizeSmall),this.setHeight(IDEMorph.spriteIconSizeSmall)):(t=5,this.setWidth(IDEMorph.spriteIconSize),this.setHeight(IDEMorph.spriteIconSize)),this.thumbnail.setCenter(this.center()),this.object instanceof StageMorph?this.thumbnail.setTop(this.top()+t):this.thumbnail.setTop(this.top()+t),this.deleteButton&&(this.deleteButton.setTop(this.top()+3),this.deleteButton.setRight(this.right()-3)),this.editorButton&&(this.editorButton.setTop(this.top()+3),this.editorButton.setLeft(this.left()+3)),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),void this.label.setBottom(this.bottom()-t)):null},SpriteIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return this.object instanceof StageMorph,this.object instanceof SpriteMorph?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate","duplicateSprite"),t.addItem("delete","removeSprite"),t.addLine(),this.object.anchor&&t.addItem(localize("detach from")+" "+this.object.anchor.name,function(){e.object.detachFromAnchor()}),this.object.parts.length&&t.addItem("detach all parts",function(){e.object.detachAllParts()}),t.addItem("export...","exportSprite"),codemao&&codemao.isTeamMember&&t.addItem("加入战队背包","addTeamSprite"),t):null},SpriteIconMorph.prototype.duplicateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this.object)},SpriteIconMorph.prototype.removeSprite=function(){var t=this.parentThatIsA(IDE_Morph),e=this;t&&confirmDialog.build("确认删除",'确认要删除角色"'+this.object.name+'"吗？',function(o){o&&t.removeSprite(e.object)},{isHideCancel:!0})},SpriteIconMorph.prototype.editSprite=function(){CostumeEditor.show()},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.addTeamSprite=function(){this.object.addTeamSprite()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.createBackgrounds=function(){var t,e=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawBackground(t,this.color),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawBackground(t,this.highlightColor),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),void(this.image=this.normalImage))},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},SpriteIconMorph.prototype.wantsDropOf=function(t){return t instanceof BlockMorph||t instanceof CostumeIconMorph||t instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(t,e){t instanceof BlockMorph?this.copyStack(t):t instanceof CostumeIconMorph?this.copyCostume(t.object):t instanceof SoundIconMorph&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(t){var e=t.fullCopy(),o=Math.max(this.object.scripts.children.map(function(t){return t.fullBounds().bottom()}).concat([this.object.scripts.top()]));e.setPosition(new Point(this.object.scripts.left()+20,o+20)),this.object.scripts.add(e),e.allComments().forEach(function(t){t.align(e)}),this.object.scripts.adjustBounds(),e.allChildren().forEach(function(t){t.definition&&!t.definition.isGlobal&&t.deleteBlock()})},SpriteIconMorph.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),this.object.addCostume(e),this.object.wearCostume(e)},SpriteIconMorph.prototype.copySound=function(t){var e=t.copy();this.object.addSound(e.audio,e.name)},CostumeIconMorph.prototype=new ToggleButtonMorph,CostumeIconMorph.prototype.constructor=CostumeIconMorph,CostumeIconMorph.uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(t,e){var o,i,r,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph),e=s.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(s.object),e&&e.updateSelection()},r=function(){var t=s.parentThatIsA(IDE_Morph);return t?t.currentSprite.costume===s.object:!1},this.object=t||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.outline=5,this.outlineColor="white",this.corner=8,this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=SpriteIconMorph.prototype.createThumbnail,CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.createDeleteButton=function(){this.deleteButton&&(this.deleteButton.destroy(),this.deleteButton=null),this.deleteButton=new PushButtonMorph(this,"removeCostume",new SymbolMorph("deleteIcon",20)),this.deleteButton.corner=5,this.deleteButton.color=new Color(255,164,0),this.deleteButton.highlightColor=this.deleteButton.color.lighter(20),this.deleteButton.pressColor=this.deleteButton.highlightColor,this.deleteButton.labelColor=TurtleIconMorph.prototype.labelColor,this.deleteButton.contrast=this.buttonContrast,this.deleteButton.hint="删除造型",this.deleteButton.drawNew(),this.deleteButton.fixLayout(),this.deleteButton.changed(),this.add(this.deleteButton)},CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Costume?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null},CostumeIconMorph.prototype.editCostume=function(){this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world()):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph))},CostumeIconMorph.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),t.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){var t=this.object,e=this.parentThatIsA(WardrobeMorph),o=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(i){i&&i!==t.name&&(t.name=e.sprite.newCostumeName(i,t),t.version=Date.now(),o.hasChangedMedia=!0)}).prompt("rename costume",t.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parentThatIsA(IDE_Morph),o=this.object.copy();o.name=t.sprite.newCostumeName(o.name),t.sprite.addCostume(o),t.updateList(),e&&e.currentSprite.wearCostume(o)},CostumeIconMorph.prototype.removeCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this),o=this.parentThatIsA(IDE_Morph);t.removeCostumeAt(e+1),o.currentSprite.costume===this.object&&o.currentSprite.wearCostume(o.currentSprite.costumes.contents[0])},CostumeIconMorph.prototype.exportCostume=function(){this.object instanceof SVG_Costume?window.open(this.object.contents.src):window.open(this.object.contents.toDataURL())},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.mouseClickLeft(),this.removeCostume()},TurtleIconMorph.prototype=new ToggleButtonMorph,TurtleIconMorph.prototype.constructor=TurtleIconMorph,TurtleIconMorph.uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(t,e){var o,i,r,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph),e=s.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},r=function(){var t=s.parentThatIsA(IDE_Morph);return t?null===t.currentSprite.costume:!1},this.object=t,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,o,null,i,"default",r,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var t=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)),this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(localize("Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),
this.label.add(t),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this,"pen"),o="●",i="○";return this.object instanceof StageMorph?null:(e.addItem(("tip"===this.object.penPoint?o:i)+" "+localize("tip"),function(){t.object.penPoint="tip",t.object.changed(),t.object.drawNew(),t.object.changed()}),e.addItem(("middle"===this.object.penPoint?o:i)+" "+localize("middle"),function(){t.object.penPoint="middle",t.object.changed(),t.object.drawNew(),t.object.changed()}),e)},WardrobeMorph.prototype=new ScrollFrameMorph,WardrobeMorph.prototype.constructor=WardrobeMorph,WardrobeMorph.uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var t,e,o,i=this,r=this.left()+5,s=this.top()+5,n=4,a=Morph.prototype.trackChanges,h=this.contents.position();[new Color(128,214,222),new Color(128,214,222).lighter(20),new Color(128,214,222).lighter(20)];this.changed(),a=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){i.reactToDropOf(t)},this.addBack(this.contents),this.newbutton=new PushButtonMorph(this,"upload",new SymbolMorph("turtle",100)),this.newbutton.corner=9,this.newbutton.color=new Color(215,215,215),this.newbutton.highlightColor=new Color(255,164,0),this.newbutton.pressColor=this.newbutton.highlightColor,this.newbutton.labelMinExtent=new Point(100,100),this.newbutton.padding=0,this.newbutton.labelShadowOffset=new Point(0,0),this.newbutton.labelColor=this.buttonLabelColor,this.newbutton.contrast=this.buttonContrast,this.newbutton.drawNew(),this.newbutton.hint="添加新造型",this.newbutton.fixLayout(),this.add(this.newbutton),o=new TextMorph(localize("costumes tab help")),o.fontSize=15,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(r,s)),this.add(o),s=o.bottom()+n,this.sprite.costumes.asArray().forEach(function(o){e=t=new CostumeIconMorph(o,e),t.setPosition(new Point(r,s)),i.addContents(t),s=t.bottom()+n}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(h),this.adjustScrollBars(),Morph.prototype.trackChanges=a,this.changed(),this.updateSelection()},WardrobeMorph.prototype.fixLayout=function(){},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},WardrobeMorph.prototype.upload=function(){this.parent.currentSprite instanceof StageMorph?this.parent.isUploadStage=!0:this.parent.isUploadStage=!1,this.parent.isUploadCostume=!0,materialVM.displayMaterialWindow=!0},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(t){this.sprite.costumes.remove(t),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var t=new Costume(newCanvas(),this.sprite.newCostumeName(localize("Untitled"))),e=this.parentThatIsA(IDE_Morph),o=this;t.edit(this.world(),e,!0,null,function(){o.sprite.addCostume(t),o.updateList(),e&&e.currentSprite.wearCostume(t)})},WardrobeMorph.prototype.modify=function(){this.sprite.costume instanceof SVG_Costume?this.sprite.costume.editRotationPointOnly(this.world()):this.sprite.costume.edit(this.world(),this.parentThatIsA(IDE_Morph))},WardrobeMorph.prototype.wantsDropOf=function(t){return t instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof CostumeIconMorph&&t.top()<i-4&&(e+=1)}),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},SoundIconMorph.prototype=new ToggleButtonMorph,SoundIconMorph.prototype.constructor=SoundIconMorph,SoundIconMorph.uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(t,e){var o,i,r;e||(o=[IDE_Morph.prototype.groupColor,new Color(255,164,0),IDE_Morph.prototype.frameColor]),i=function(){nop()},r=function(){return!1},this.object=t,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=2,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.thumbnail.setColor(new Color(255,255,255)),this.add(this.thumbnail),t=new StringMorph("","16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(t),t.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,30))},SoundIconMorph.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(10>e?"0":"")+e.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var t=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){t.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Sound?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t):null},SoundIconMorph.prototype.renameSound=function(){var t=this.object,e=this.parentThatIsA(IDE_Morph),o=this;new DialogBoxMorph(null,function(i){i&&i!==t.name&&(t.name=i,t.version=Date.now(),o.createLabel(),o.fixLayout(),e.hasChangedMedia=!0)}).prompt("rename sound",t.name,this.world())},SoundIconMorph.prototype.removeSound=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.removeSound(e)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.removeSound()},JukeboxMorph.prototype=new ScrollFrameMorph,JukeboxMorph.prototype.constructor=JukeboxMorph,JukeboxMorph.uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var t,e,o,i=this,r=this.left()+5,s=this.top()+5,n=4,a=Morph.prototype.trackChanges;this.changed(),a=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){i.reactToDropOf(t)},this.addBack(this.contents),o=new TextMorph(localize("import a sound from your computer\nby dragging it into here")),o.fontSize=15,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(r,s)),this.addContents(o),s=o.bottom()+n,this.sprite.sounds.asArray().forEach(function(o){e=t=new SoundIconMorph(o,e),t.setPosition(new Point(r,s)),i.addContents(t),s=t.bottom()+n}),Morph.prototype.trackChanges=a,this.changed(),this.updateSelection()},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(t){return t instanceof SoundIconMorph},JukeboxMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t.top()<i-4&&(e+=1)}),this.sprite.sounds.add(o,e),this.updateList()};