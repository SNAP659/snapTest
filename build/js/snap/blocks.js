function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(t){this.init(t)}function RingMorph(){this.init()}function ScriptsMorph(t){this.init(t)}function ArgMorph(t){this.init(t)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(t,o,e,r){this.init(t,o,e,r)}function TemplateSlotMorph(t){this.init(t)}function BooleanSlotMorph(){this.init()}function ArrowMorph(t,o,e,r){this.init(t,o,e,r)}function TextSlotMorph(t,o,e,r){this.init(t,o,e,r)}function SymbolMorph(t,o,e,r,i){this.init(t,o,e,r,i)}function ColorSlotMorph(t){this.init(t)}function BlockHighlightMorph(){this.init()}function MultiArgMorph(t,o,e,r,i,n,h,s,a){this.init(t,o,e,r,i,n,h,s,a)}function ArgLabelMorph(t,o){this.init(t,o)}function FunctionSlotMorph(t){this.init(t)}function ReporterSlotMorph(t){this.init(t)}function RingReporterSlotMorph(t){this.init(t)}function CommentMorph(t){this.init(t)}modules.blocks="2015-June-08";var SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,SymbolMorph,CommentMorph,ArgLabelMorph,TextSlotMorph;WorldMorph.prototype.customMorphs=function(){return[]},SyntaxElementMorph.prototype=new Morph,SyntaxElementMorph.prototype.constructor=SyntaxElementMorph,SyntaxElementMorph.uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(t){var o=Math.min(Math.max(t,1),25);this.scale=o,this.corner=3*o,this.rounding=9*o,this.edge=0,this.inset=6*o,this.hatHeight=12*o,this.hatWidth=70*o,this.rfBorder=3*o,this.minWidth=0,this.dent=8*o,this.bottomPadding=3*o,this.cSlotPadding=4*o,this.typeInPadding=o,this.labelPadding=4*o,this.labelFontName="Verdana",this.labelFontStyle="微软雅黑",this.fontSize=10*o,this.embossing=new Point(0,0),this.labelWidth=450*o,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*o,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1.65),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this),this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var t=null;return this.nextBlock&&(t=this.nextBlock()),this.children.filter(function(o){return!(o===t||o instanceof ShadowMorph||o instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return(isNil(this.cachedInputs)||!this.isCachingInputs)&&(this.cachedInputs=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var t,o;if(isNil(this.cachedInputs)||(t=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(o=0;o<t.length;o+=1)if(this.cachedInputs[o]!==t[o])throw new Error("cached input does not match: "+this.constructor.name+" #"+o+" "+this.cachedInputs[o].constructor.name+" != "+t[o].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var t=this;return this.allChildren().slice(0).reverse().filter(function(o){return o instanceof ArgMorph||o instanceof ReporterBlockMorph&&o!==t})},SyntaxElementMorph.prototype.allEmptySlots=function(){var t=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(o){o.isEmptySlot&&o.isEmptySlot()?t.push(o):o.allEmptySlots&&(t=t.concat(o.allEmptySlots()))}),t},SyntaxElementMorph.prototype.tagExitBlocks=function(t,o){"doReport"===this.selector?this.partOfCustomCommand=o:"doStopThis"===this.selector?this.exitTag=t:this instanceof RingMorph||this.children.forEach(function(e){e.tagExitBlocks&&e.tagExitBlocks(t,o)})},SyntaxElementMorph.prototype.replaceInput=function(t,o){var e,r=this.parentThatIsA(ScriptsMorph),i=o,n=this.children.indexOf(t),h=0;return-1===n&&o instanceof MultiArgMorph&&this.children.forEach(function(o){o instanceof ArgLabelMorph&&o.argMorph()===t&&(n=h),h+=1}),-1===n||null===r?null:(this.startLayout(),o.parent&&o.parent.removeChild(o),t instanceof MultiArgMorph&&(t.inputs().forEach(function(o){t.replaceInput(o,new InputSlotMorph)}),this.dynamicInputLabels&&(i=new ArgLabelMorph(o))),i.parent=this,this.children[n]=i,t instanceof ReporterBlockMorph?(!(t instanceof RingMorph)||t instanceof RingMorph&&t.contents())&&(r.add(t),t.moveBy(i.extent()),t.fixBlockColor()):t instanceof CommandSlotMorph&&(e=t.nestedBlock(),e&&(r.add(e),e.moveBy(i.extent()),e.fixBlockColor())),i instanceof MultiArgMorph||i instanceof ArgLabelMorph||i.constructor===CommandSlotMorph?(i.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(i.drawNew(),this.fixLayout()),this.cachedInputs=null,void this.endLayout())},SyntaxElementMorph.prototype.silentReplaceInput=function(t,o){var e,r=this.children.indexOf(t);-1!==r&&(o.parent&&o.parent.removeChild(o),e=t instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(o):o,e.parent=this,this.children[r]=e,e instanceof MultiArgMorph||e instanceof ArgLabelMorph||e.constructor===CommandSlotMorph?(e.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(e.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(t,o){var e=this.parts().indexOf(t),r=this.inputs().indexOf(t),i=new InputSlotMorph;-1!==e&&(this instanceof BlockMorph?(i=this.labelPart(this.parseSpec(this.blockSpec)[e]),i instanceof InputSlotMorph&&this.definition&&(i.setChoices.apply(i,this.definition.inputOptionsOfIdx(r)),i.setContents(this.definition.defaultValueOfInputIdx(r)))):this instanceof MultiArgMorph?i=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(i=this.emptySlot())),o||-1!==r&&(i instanceof MultiArgMorph?(i.setContents(this.defaults),i.defaults=this.defaults):isNil(this.defaults[r])||i.setContents(this.defaults[r])),this.silentReplaceInput(t,i),i instanceof MultiArgMorph?i.refresh():i instanceof RingMorph&&i.fixBlockColor(),this.cachedInputs=null},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.reactToGrabOf=function(t){var o,e=this.topBlock();IDEMorph.palette.hide(),t instanceof CommandBlockMorph&&(o=this.parentThatIsA(CommandSlotMorph),o&&(this.startLayout(),o.fixLayout(),this.endLayout())),e&&(e.allComments().forEach(function(t){t.align(e)}),e.getHighlight()&&e.addHighlight(e.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.drawNew(),this.children.forEach(function(t){t.drawNew(),t.changed()}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(t,o,e){this.children.forEach(function(r){r instanceof StringMorph&&!r.isProtectedLabel?(r.shadowOffset=e||r.shadowOffset,r.shadowColor=o||r.shadowColor,r.setColor(t)):(r instanceof MultiArgMorph||r instanceof ArgLabelMorph||r instanceof SymbolMorph&&!r.isProtectedLabel||r instanceof InputSlotMorph&&r.isReadOnly)&&r.setLabelColor(t,o,e)})},SyntaxElementMorph.prototype.fixBlockColor=function(t,o){this.children.forEach(function(e){e instanceof SyntaxElementMorph&&e.fixBlockColor(t,o)})},SyntaxElementMorph.prototype.labelPart=function(t){var o,e;if("%"===t[0]&&t.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(t.length>5&&"%mult"===t.slice(0,5))return o=new MultiArgMorph(t.slice(5)),o.addInput(),o;switch(t){case"%imgsource":o=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0),o.setContents(["pen trails"]);break;case"%inputs":o=new MultiArgMorph("%s","with inputs"),o.isStatic=!1,o.canBeEmpty=!1;break;case"%scriptVars":o=new MultiArgMorph("%t",null,1,t),o.canBeEmpty=!1;break;case"%parms":o=new MultiArgMorph("%t","Input Names:",0,t),o.canBeEmpty=!1;break;case"%ringparms":o=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":o=new RingMorph,o.color=SpriteMorph.prototype.blockColor.other,o.selector="reifyScript",o.setSpec("%rc %ringparms"),o.isDraggable=!0;break;case"%repRing":o=new RingMorph,o.color=SpriteMorph.prototype.blockColor.other,o.selector="reifyReporter",o.setSpec("%rr %ringparms"),o.isDraggable=!0,o.isStatic=!0;break;case"%predRing":o=new RingMorph(!0),o.color=SpriteMorph.prototype.blockColor.other,o.selector="reifyPredicate",o.setSpec("%rp %ringparms"),o.isDraggable=!0,o.isStatic=!0;break;case"%words":o=new MultiArgMorph("%s",null,0),o.addInput(),o.addInput(),o.isStatic=!1;break;case"%exp":o=new MultiArgMorph("%s",null,0),o.addInput(),o.isStatic=!0,o.canBeEmpty=!1;break;case"%br":o=new Morph,o.setExtent(new Point(0,0)),o.isBlockLabelBreak=!0,o.getSpec=function(){return"%br"};break;case"%inputName":o=new ReporterBlockMorph,o.category="variables",o.color=SpriteMorph.prototype.blockColor.variables,o.setSpec(localize("Input name"));break;case"%s":o=new InputSlotMorph;break;case"%anyUE":o=new InputSlotMorph,o.isUnevaluated=!0;break;case"%txt":o=new InputSlotMorph,o.minWidth=1.7*o.height(),o.fixLayout();break;case"%mlt":o=new TextSlotMorph,o.fixLayout();break;case"%code":o=new TextSlotMorph,o.contents().fontName="monospace",o.contents().fontStyle="monospace",o.fixLayout();break;case"%obj":o=new ArgMorph("object");break;case"%n":o=new InputSlotMorph(null,!0);break;case"%dir":o=new InputSlotMorph(null,!0,{"(90) 右":90,"(-90) 左":-90,"(0) 上":"0","(180) 下":180}),o.setContents(90);break;case"%inst":o=new InputSlotMorph(null,!0,{"(1) Acoustic Grand":1,"(2) Bright Acoustic":2,"(3) Electric Grand":3,"(4) Honky Tonk":4,"(5) Electric Piano 1":5,"(6) Electric Piano 2":6,"(7) Harpsichord":7}),o.setContents(1);break;case"%month":o=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":o=new InputSlotMorph(null,!1,{"点击":["clicked"],"按下":["pressed"],"放开":["dropped"],"移入":["mouse-entered"],"移出":["mouse-departed"]},!0);break;case"%dates":o=new InputSlotMorph(null,!1,{"年份":["year"],"月份":["month"],"日期":["date"],"一周中的第几天":["day of week"],"小时":["hour"],"分钟":["minute"],"秒":["second"],"毫秒":["time in milliseconds"]},!0),o.setContents(["date"]);break;case"%delim":o=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"]},!1);break;case"%ida":o=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]}),o.setContents(1);break;case"%idx":o=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]}),o.setContents(1);break;case"%spr":o=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":o=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":o=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%drag":o=new InputSlotMorph(null,!1,"draggableMenu",!0);break;case"%cln":o=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%cst":o=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":o=new InputSlotMorph(null,!1,{brightness:["brightness"],ghost:["ghost"],negative:["negative"],comic:["comic"],duplicate:["duplicate"],confetti:["confetti"],fisheye:["fisheye"],whirl:["whirl"]},!0),o.setContents(["ghost"]);break;case"%snd":o=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":o=new InputSlotMorph(null,!1,{"上移键":["up arrow"],"下移键":["down arrow"],"右移键":["right arrow"],"左移键":["left arrow"],space:["space"]},!1),o.setContents(["space"]);break;case"%keyHat":o=this.labelPart("%key"),o.isStatic=!0;break;case"%msg":o=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":o=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0),o.isStatic=!0;break;case"%att":o=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":o=new InputSlotMorph(null,!1,{"绝对值":["abs"],"平方根":["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],"e^":["e^"]},!0),o.setContents(["sqrt"]);break;case"%txtfun":o=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0),o.setContents(["encode URI"]);break;case"%stopChoices":o=new InputSlotMorph(null,!1,{"所有":["all"],"当前脚本":["this script"],"当前积木":["this block"]},!0),o.setContents(["all"]),o.isStatic=!0;break;case"%stopOthersChoices":o=new InputSlotMorph(null,!1,{"除当前脚本外的所有脚本":["all but this script"],"角色的其他脚本":["other scripts in sprite"]},!0),o.setContents(["all but this script"]),o.isStatic=!0;break;case"%typ":o=new InputSlotMorph(null,!1,{number:["number"],text:["text"],Boolean:["Boolean"],list:["list"],command:["command"],reporter:["reporter"],predicate:["predicate"]},!0),o.setContents(["number"]);break;case"%var":o=new InputSlotMorph(null,!1,"getVarNamesDict",!0),o.isStatic=!0;break;case"%lst":o=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":o=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0),o.setContents(["code"]);break;case"%l":o=new ArgMorph("list");break;case"%b":case"%boolUE":o=new BooleanSlotMorph(null,!0);break;case"%cmd":o=new CommandSlotMorph;break;case"%rc":o=new RingCommandSlotMorph,o.isStatic=!0;break;case"%rr":o=new RingReporterSlotMorph,o.isStatic=!0;break;case"%rp":o=new RingReporterSlotMorph(!0),o.isStatic=!0;break;case"%c":o=new CSlotMorph,o.isStatic=!0;break;case"%cs":o=new CSlotMorph;break;case"%clr":o=new ColorSlotMorph,o.isStatic=!0;break;case"%t":o=new TemplateSlotMorph("a");break;case"%upvar":o=new TemplateSlotMorph("↑");break;case"%f":o=new FunctionSlotMorph;break;case"%r":o=new ReporterSlotMorph;break;case"%p":o=new ReporterSlotMorph(!0);break;case"%codeListPart":o=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":o=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":o=new SymbolMorph("turtle"),o.size=1.2*this.fontSize,o.color=new Color(255,255,255),o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%turtleOutline":o=new SymbolMorph("turtleOutline"),o.size=this.fontSize,o.color=new Color(255,255,255),o.isProtectedLabel=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%clockwise":o=new SymbolMorph("turnRight"),o.size=1.5*this.fontSize,o.color=new Color(255,255,255),o.isProtectedLabel=!1,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%counterclockwise":o=new SymbolMorph("turnLeft"),o.size=1.5*this.fontSize,o.color=new Color(255,255,255),o.isProtectedLabel=!1,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%greenflag":o=new SymbolMorph("flag"),o.size=35,o.color=new Color(0,200,0),o.isProtectedLabel=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%stop":o=new SymbolMorph("octagon"),o.size=1.5*this.fontSize,o.color=new Color(200,0,0),o.isProtectedLabel=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;case"%pause":o=new SymbolMorph("pause"),o.size=this.fontSize,o.color=new Color(255,220,0),o.isProtectedLabel=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();break;default:nop()}}else if("$"===t[0]&&t.length>1&&"reportGetVar"!==this.selector){if(e=t.slice(1).split("-"),!contains(SymbolMorph.prototype.names,e[0]))return o=new StringMorph(t),o.fontName=this.labelFontName,o.fontStyle=this.labelFontStyle,o.fontSize=this.fontSize,o.color=new Color(255,255,255),o.isBold=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew(),o;o=new SymbolMorph(e[0]),o.size=this.fontSize*(+e[1]||1.2),o.color=new Color(0===+e[2]?0:+e[2]||255,0===+e[3]?0:+e[3]||255,0===+e[4]?0:+e[4]||255),o.isProtectedLabel=e.length>2,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew()}else o=new StringMorph(t),o.fontName=this.labelFontName,o.fontStyle=this.labelFontStyle,o.fontSize=this.fontSize,o.color=new Color(255,255,255),o.isBold=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,o.drawNew();return o},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(){var t,o,e,r,i,n=this.parts(),h=this,s=0,a=0,l=0,p=this.minWidth,c=[],d=[],u=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),f=this.extent();if(p+=this instanceof MultiArgMorph&&"%c"!==this.slotSpec?this.arrows().width():this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(t=this.nextBlock()),n.forEach(function(t){t instanceof CSlotMorph||"%c"===t.slotSpec?c.length>0?(d.push(c),d.push([t]),c=[],s=0):d.push([t]):t instanceof BlockHighlightMorph?nop():(t.isVisible&&(s+=t.fullBounds().width()+u),(s>h.labelWidth||t.isBlockLabelBreak)&&c.length>0&&(d.push(c),c=[],s=t.fullBounds().width()+u),c.push(t),t.isBlockLabelBreak&&(s=0))}),c.length>0&&d.push(c),this instanceof CommandBlockMorph?(o=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(o+=this.hatHeight)):this instanceof ReporterBlockMorph?o=this.top()+2*this.edge+5:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(o=this.top()),d.forEach(function(t){s=h.left()+h.edge+h.labelPadding,h instanceof RingMorph?s=h.left()+u:h.isPredicate?s=h.left()+h.rounding:(h instanceof MultiArgMorph||h instanceof ArgLabelMorph)&&(s=h.left()),o+=a,a=0,t.forEach(function(t){t instanceof CSlotMorph?(s-=h.labelPadding,h.isPredicate&&(s=h.left()+h.rounding),t.setColor(h.color),t.setPosition(new Point(s,o)),a=t.height()):(t.setPosition(new Point(s,o)),t.isBlockLabelBreak||("%c"===t.slotSpec?s+=t.width():t.isVisible&&(s+=t.fullBounds().width()+u)),l=Math.max(l,s),a=Math.max(a,t instanceof StringMorph?t.rawHeight():t.height()))}),t.forEach(function(t){t.moveBy(new Point(0,Math.floor((a-t.height())/2)))})}),o+=a,this.children.some(function(t){return t instanceof CSlotMorph})&&(i=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(i=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),o+=i),this instanceof CommandBlockMorph?e=o-this.top()+2*this.corner:this instanceof ReporterBlockMorph?e=o-this.top()+2*this.edge+5:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(e=o-this.top()),this.isPredicate?p=Math.max(p,l-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?p=Math.max(p,l-this.left()-u):(p=Math.max(p,l-this.left()+this.labelPadding-this.edge),n[n.length-1]instanceof MultiArgMorph&&1===d.length&&(p-=u),this instanceof HatBlockMorph&&(p=Math.max(p,1.5*this.hatWidth))),this.setExtent(new Point(p,e)),n.forEach(function(t){t instanceof CSlotMorph&&(h.isPredicate?t.setWidth(p-2*h.rounding):t.setWidth(p-h.edge))}),this.drawNew(),t&&t.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==f.y&&(r=this.parentThatIsA(CommandSlotMorph),r&&r.fixLayout()),this.width()!==f.x&&(r=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]),r&&r.fixLayout()),r)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(t,o){var e,r,i,n,h=!1,s=this.parentThatIsA(ScrollFrameMorph),a=this.world();return void 0!==t&&a?(t instanceof ListWatcherMorph?(n=t,n.update(!0),n.step=t.update,n.isDraggable=!1,h=!0):t instanceof Morph?(i=t.fullImage(),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):t instanceof Costume?(i=t.thumbnail(new Point(40,40)),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):t instanceof Context?(i=t.image(),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):"boolean"==typeof t?n=SpriteMorph.prototype.booleanMorph.call(null,t):isString(t)?(r=t.length>500?t.slice(0,500)+"...":t,n=new TextMorph(r,this.fontSize)):null===t?n=new TextMorph("",this.fontSize):0===t?n=new TextMorph("0",this.fontSize):t.toString&&(n=new TextMorph(t.toString(),this.fontSize)),e=new SpeechBubbleMorph(n,null,Math.max(this.rounding-2,6),0),e.popUp(a,this.rightCenter().add(new Point(2,0)),h),o&&this.exportPictureWithResult(e),void(s&&e.keepWithin(s))):null},SyntaxElementMorph.prototype.exportPictureWithResult=function(t){var o=this.fullImage(),e=t.fullImageClassic(),r=Math.max(0,e.height-o.height),i=newCanvas(new Point(o.width+e.width+2,o.height+r)),n=i.getContext("2d");n.drawImage(o,0,i.height-o.height),n.drawImage(e,o.width+2,0),window.open(i.toDataURL())},SyntaxElementMorph.prototype.mappedCode=function(t){var o=this.evaluate();return o instanceof BlockMorph?o.mappedCode(t):o},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,BlockMorph.prototype.constructor=BlockMorph,BlockMorph.uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,BlockMorph.prototype.init=function(){this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,BlockMorph.uber.init.call(this),this.color=new Color(0,17,173),this.cashedInputs=null},BlockMorph.prototype.receiver=function(){for(var t=this.parent;t;){if(t.owner)return t.owner;t=t.parent}return null},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(t){function o(t){"%"===t[0]&&t.length>1?(""!==i&&(r.push(i),i=""),r.push(t)):""!==i?i+=" "+t:i=t}var e,r=[],i="";return e=isString(t)?t.split(" "):[],0===e.length&&(e=[t]),this.labelWordWrap?e:(e.forEach(function(t){o(t)}),""!==i&&r.push(i),r)},BlockMorph.prototype.setSpec=function(t){var o,e=this,r=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t){"%"===t[0]&&(r+=1),o=e.labelPart(t),e.add(o),o instanceof CommandSlotMorph||o.drawNew(),o instanceof RingMorph&&o.fixBlockColor(),(o instanceof MultiArgMorph||contains([CommandSlotMorph,RingCommandSlotMorph],o.constructor))&&o.fixLayout(),e.isPrototype&&e.add(e.placeHolder()),o instanceof InputSlotMorph&&e.definition&&o.setChoices.apply(o,e.definition.inputOptionsOfIdx(r))}),this.blockSpec=t,this.fixLayout(),this.cachedInputs=null)},BlockMorph.prototype.buildSpec=function(){var t=this;this.blockSpec="",this.parts().forEach(function(o){o instanceof StringMorph?t.blockSpec+=o.text:o instanceof ArgMorph?t.blockSpec+=o.getSpec():o.isBlockLabelBreak?t.blockSpec+=o.getSpec():t.blockSpec+="[undefined]",t.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(t){this.setSpec(this.blockSpec),t&&this.inputs().forEach(function(o){o instanceof ReporterBlockMorph&&(o.setColor(o.color.lighter(t)),o.setSpec(o.blockSpec))})},BlockMorph.prototype.userMenu=function(){var t,o,e,r=new MenuMorph(this),i=this.world(),n=this,h=16===i.currentKey;return h&&(o=this.topBlock(),o instanceof ReporterBlockMorph&&r.addItem("script pic with result...",function(){o.ExportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0))),this.isTemplate?(this.parent instanceof SyntaxElementMorph||StageMorph.prototype.enableCodeMapping&&(r.addLine(),r.addItem("header mapping...","mapToHeader"),r.addItem("code mapping...","mapToCode")),r):(r.addLine(),"reportGetVar"===this.selector?(e=this.fullCopy(),e.addShadow(),r.addItem("rename...",function(){new DialogBoxMorph(n,n.setSpec,n).prompt("变量名",n.blockSpec,i,e.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(n))})):SpriteMorph.prototype.blockAlternatives[this.selector]||this.definition&&this.alternatives&&(t=this.alternatives()),r.addItem("duplicate",function(){var t=n.fullCopy(),o=n.parentThatIsA(IDE_Morph);t.pickUp(i),o&&(i.hand.grabOrigin={origin:o.palette,position:o.palette.center()})},"创建一个副本并抓起"),r.addItem("delete","userDestroy"),r.addItem("script pic...",function(){window.open(n.topBlock().fullImage().toDataURL())},"open a new window\nwith a picture of this script"),this.parentThatIsA(RingMorph)?(r.addLine(),r):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph?r:(r.addLine(),StageMorph.prototype.enableCodeMapping&&(r.addLine(),r.addItem("header mapping...","mapToHeader"),r.addItem("code mapping...","mapToCode")),r))},BlockMorph.prototype.developersMenu=function(){var t=BlockMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",function(){new DialogBoxMorph(this,this.setSpec,this).prompt(t.title+"\nspec",this.blockSpec,this.world())}),t},BlockMorph.prototype.hidePrimitive=function(){var t,o,e=this.parentThatIsA(IDE_Morph);e&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"},o=t[this.selector]||this.category,"lists"===o&&(o="variables"),e.flushBlocksCache(o),e.refreshPalette())},BlockMorph.prototype.deleteBlock=function(){var t,o,e=this.parentThatIsA(ScriptsMorph),r=this.nextBlock?this.nextBlock():null;e&&(r&&e.add(r),this.inputs().forEach(function(t){t instanceof BlockMorph&&e.add(t)})),this instanceof ReporterBlockMorph?this.parent instanceof BlockMorph&&this.parent.revertToDefaultInput(this):this.parent?this.parent.fixLayout&&(t=this.parentThatIsA(ArgMorph)):o=!0,this.destroy(),o&&(this.isCorpse=!0),t&&t.fixLayout()},BlockMorph.prototype.ringify=function(){var t=new RingMorph,o=this.topBlock(),e=o.fullBounds().center();return null===this.parent?null:(this.parent instanceof SyntaxElementMorph?this instanceof ReporterBlockMorph?(this.parent.silentReplaceInput(this,t),t.embed(this)):o&&(o.parent.add(t),t.embed(o),t.setCenter(e)):(this.parent.add(t),t.embed(this),t.setCenter(e)),void this.fixBlockColor(null,!0))},BlockMorph.prototype.unringify=function(){var t,o,e=this.parentThatIsA(RingMorph),r=this.parentThatIsA(ScriptsMorph);return null===e?null:(t=e.contents(),o=e.center(),e.parent instanceof SyntaxElementMorph?t instanceof ReporterBlockMorph?e.parent.silentReplaceInput(e,t):r&&(r.add(t),t.setFullCenter(o),t.moveBy(20),e.parent.revertToDefaultInput(e)):(e.parent.add(t),t.setFullCenter(o),e.destroy()),void this.fixBlockColor(null,!0))},BlockMorph.prototype.relabel=function(t){var o=new MenuMorph(this),e=this.inputs(),r=this;t.forEach(function(t){var i=SpriteMorph.prototype.blockForSelector(t);i.restoreInputs(e),i.fixBlockColor(null,!0),i.addShadow(new Point(3,3)),o.addItem(i,function(){r.setSelector(t)})}),o.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},BlockMorph.prototype.setSelector=function(t){var o,e=this.inputs();o=SpriteMorph.prototype.blocks[t],this.setCategory(o.category),this.selector=t,this.setSpec(localize(o.spec)),this.restoreInputs(e),this.fixLabelColor()},BlockMorph.prototype.restoreInputs=function(t){var o,e,r=0,i=this;this.inputs().forEach(function(n){o=t[r],o instanceof ReporterBlockMorph?i.silentReplaceInput(n,o.fullCopy()):o&&n instanceof InputSlotMorph?o.contents&&n.setContents(o.contents().text):o instanceof CSlotMorph&&n instanceof CSlotMorph&&(e=o.nestedBlock(),e&&n.nestedBlock(e.fullCopy())),r+=1}),this.cachedInputs=null},BlockMorph.prototype.showHelp=function(){var t,o,e,r,i=this,n=new Image,h="evaluateCustomBlock"===this.selector,s=h?this.definition.helpSpec():this.selector;n.onload=function(){t=newCanvas(new Point(n.width,n.height)),r=t.getContext("2d"),r.drawImage(n,0,0),(new DialogBoxMorph).inform("Help",null,i.world(),t)},h&&this.definition.comment?(e=this.fullCopy(),e.addShadow(),o=this.definition.comment.fullCopy(),o.contents.parse(),t="",o.contents.lines.forEach(function(o){t=t+"\n"+o}),(new DialogBoxMorph).inform("Help",t.substr(1),i.world(),e.fullImage())):n.src="help/"+s+".png"},BlockMorph.prototype.mapToHeader=function(){var t,o,e="reify"===this.selector.substr(0,5)?"reify":this.selector,r=this.codeDefinitionHeader(),i=this;r.addShadow(new Point(3,3)),o=r.fullImageClassic(),t=this.definition?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===e?i.definition.codeHeader=t:StageMorph.prototype.codeHeaders[e]=t},this).promptCode("Header mapping","evaluateCustomBlock"===e?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[e]||"",this.world(),o,t)},BlockMorph.prototype.mapToCode=function(){var t,o="reify"===this.selector.substr(0,5)?"reify":this.selector,e=this.codeMappingHeader(),r=this;e.addShadow(new Point(3,3)),t=e.fullImageClassic(),new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===o?r.definition.codeMapping=t:StageMorph.prototype.codeMappings[o]=t},this).promptCode("Code mapping","evaluateCustomBlock"===o?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[o]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(t,o){var e=o||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeHeader=t:StageMorph.prototype.codeHeaders[e]=t);
},BlockMorph.prototype.mapCode=function(t,o){var e=o||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeMapping=t:StageMorph.prototype.codeMappings[e]=t)},BlockMorph.prototype.mappedCode=function(t){var o,e,r,i,n,h,s,a="reify"===this.selector.substr(0,5)?"reify":this.selector,l=1,p=this.definition?this.definition.spec:a,c=t||{},d=[];return o="reportGetVar"===a?this.blockSpec:this.definition?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[a]||"","reportGetVar"===a||c.hasOwnProperty(p)||(c[p]=null,this.definition?(r=this.definition.codeHeader||"",-1!==r.indexOf("<body")&&(h="",this.definition.body&&(h=this.definition.body.expression.mappedCode(c)),s=h.split("\n"),n=r.split("\n"),n.forEach(function(t,o){var e,r="";0===t.trimLeft().indexOf("<body")&&(e=t.indexOf("<body"),r=t.slice(0,e)),n[o]=t.replace(new RegExp("<body>"),s.join("\n"+r)),n[o]=n[o].replace(new RegExp("<body>","g"),s.join("\n"))}),r=n.join("\n")),c[p]=r):c[p]=StageMorph.prototype.codeHeaders[p]),e=o.split("\n"),this.inputs().forEach(function(t){d.push(t.mappedCode(c).toString())}),d.forEach(function(t){var o=t.split("\n"),r="<#"+l+">",i=new RegExp(r,"g");e.forEach(function(t,n){var h,s="";0===t.trimLeft().indexOf(r)&&(h=t.indexOf(r),s=t.slice(0,h)),e[n]=t.replace(new RegExp(r),o.join("\n"+s)),e[n]=e[n].replace(i,o.join("\n"))}),l+=1}),o=e.join("\n"),this.nextBlock&&this.nextBlock()&&(o+="\n"+this.nextBlock().mappedCode(c)),!t&&(i=[],Object.keys(c).forEach(function(t){c[t]&&i.push(c[t])}),i.length)?i.join("\n\n")+"\n\n"+o:o},BlockMorph.prototype.codeDefinitionHeader=function(){var t=this.definition?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),o=new HatBlockMorph,e=1;return this.definition?t:(t.inputs().forEach(function(o){var r=new TemplateSlotMorph("#"+e);t.silentReplaceInput(o,r),e+=1}),t.isPrototype=!0,o.setCategory("control"),o.setSpec("%s"),o.silentReplaceInput(o.inputs()[0],t),"control"===this.category&&o.alternateBlockColor(),o)},BlockMorph.prototype.codeMappingHeader=function(){var t=this.definition?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),o=new HatBlockMorph,e=1;return t.inputs().forEach(function(o){var r=new TemplateSlotMorph("<#"+e+">");t.silentReplaceInput(o,r),e+=1}),t.isPrototype=!0,o.setCategory("control"),o.setSpec("%s"),o.silentReplaceInput(o.inputs()[0],t),"control"===this.category&&o.alternateBlockColor(),o},BlockMorph.prototype.eraseHoles=function(t){var o,e,r=this,i=this instanceof ReporterBlockMorph,n=.5*this.edge,h=this.parts().filter(function(t){return t.isHole});this.isPredicate&&h.length>0&&(e=this.width()-this.rounding,t.clearRect(e,0,this.width(),this.height()),o=t.createLinearGradient(e-this.edge,0,this.width(),0),o.addColorStop(0,this.color.toString()),o.addColorStop(1,this.dark()),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e-n,this.edge+n),t.lineTo(e-n,this.height()-this.edge-n),t.stroke()),h.forEach(function(o){var e=10*o.width(),n=Math.floor(o.height())-2;t.clearRect(Math.floor(o.bounds.origin.x-r.bounds.origin.x)+1,Math.floor(o.bounds.origin.y-r.bounds.origin.y)+1,i?e-1:e+1,n)})},BlockMorph.prototype.addHighlight=function(t){var o,e=!this.isVisible;return e&&this.show(),o=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(o),this.fullChanged(),e&&this.hide(),o},BlockMorph.prototype.addErrorHighlight=function(){var t,o=!this.isVisible;return o&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),o&&this.hide(),t},BlockMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(t,o,e){var r=new BlockHighlightMorph,i=this.fullBounds(),n=useBlurredShadows&&!MorphicPreferences.isFlat?o:e;return r.setExtent(i.extent().add(2*n)),r.color=t,r.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(t,o):this.highlightImage(t,e),r.setPosition(i.origin.subtract(new Point(n,n))),r},BlockMorph.prototype.highlightImage=function(t,o){var e,r,i,n,h;return e=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(e.add(2*o)),n=i.getContext("2d"),n.drawImage(r,0,0),n.drawImage(r,o,0),n.drawImage(r,2*o,0),n.drawImage(r,2*o,o),n.drawImage(r,2*o,2*o),n.drawImage(r,o,2*o),n.drawImage(r,0,2*o),n.drawImage(r,0,o),n.globalCompositeOperation="destination-out",n.drawImage(r,o,o),h=newCanvas(e.add(2*o)),n=h.getContext("2d"),n.drawImage(i,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,h.width,h.height),h},BlockMorph.prototype.highlightImageBlurred=function(t,o){var e,r,i,n;return e=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(e.add(2*o)),n=i.getContext("2d"),n.shadowBlur=o,n.shadowColor=t.toString(),n.drawImage(r,o,o),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,o,o),i},BlockMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof BlockHighlightMorph}),0!==t.length?t[0]:null},BlockMorph.prototype.fixBlockColor=function(t,o){var e,r,i=t;if(this.zebraContrast||o){if(!this.zebraContrast&&o)return this.forceNormalColoring();i||this.parent&&(this.isPrototype?i=null:this instanceof ReporterBlockMorph?i=this.parent.parentThatIsA(BlockMorph):(r=this.parentThatIsA(CommandSlotMorph),r&&(i=r.parentThatIsA(BlockMorph)))),i?i.category===this.category?i.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():(e=SpriteMorph.prototype.blockColor[this.category],this.color.eq(e)||this.alternateBlockColor()),o&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.setColor(t),this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),new Point(0,0)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast)):this.setColor(t),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),new Point(0,0)):this.setLabelColor(new Color(0,0,0),t.lighter(this.zebraContrast).lighter(2*this.labelContrast),new Point(0,0))}},BlockMorph.prototype.fixChildrensBlockColor=function(t){var o=this;this.children.forEach(function(e){e instanceof CommandBlockMorph?e.fixBlockColor(null,t):e instanceof SyntaxElementMorph&&e.fixBlockColor(o,t)})},BlockMorph.prototype.setCategory=function(t){this.category=t,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.fullCopy=function(){var t=BlockMorph.uber.fullCopy.call(this);return t.removeHighlight(),t.isDraggable=!0,this.instantiationSpec&&t.setSpec(this.instantiationSpec),t.allChildren().filter(function(t){return t instanceof SyntaxElementMorph?(t.cachedInputs=null,t instanceof InputSlotMorph&&t.contents().clearSelection()):t instanceof CursorMorph&&t.destroy(),!isNil(t.comment)}).forEach(function(t){var o=t.comment.fullCopy();t.comment=o,o.block=t}),t.cachedInputs=null,t},BlockMorph.prototype.mouseClickLeft=function(){var t,o=this.topBlock(),e=o.receiver();return IDEMorph&&IDEMorph.soundEffect&&(IDEMorph.soundEffect.src="http://7xli7a.com2.z0.glb.qiniucdn.com/se/click.wav",IDEMorph.soundEffect.play()),o instanceof PrototypeHatBlockMorph?o.mouseClickLeft():void(e&&(t=e.parentThatIsA(StageMorph),t&&t.threads.toggleProcess(o)))},BlockMorph.prototype.thumbnail=function(t,o,e){var r,i,n,h,s=this.fullCopy(),a=s.nextBlock(),l=12;return a&&a.destroy(),e||s.addShadow(),r=s.fullBounds().extent(),e||(r=r.subtract(this.shadowBlur*(useBlurredShadows&&!MorphicPreferences.isFlat?1:2))),i=newCanvas(new Point(Math.min(r.x*t,o||r.x),r.y*t)),n=i.getContext("2d"),n.scale(t,t),n.drawImage(s.fullImage(),0,0),i.width===o&&(h=n.createLinearGradient(i.width/t-l,0,i.width/t,0),h.addColorStop(0,new Color(255,255,255,0).toString()),h.addColorStop(1,"white"),n.fillStyle=h,n.fillRect(i.width/t-l,0,i.width/t,i.height/t)),i},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(t){return(t instanceof ArgMorph||t instanceof StringMorph||t instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(t){t.isDraggable=!1,t instanceof InputSlotMorph?t.drawNew():t instanceof MultiArgMorph&&t.fixLayout(),this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){var t=this.parentThatIsA(ScriptsMorph);return t?{origin:t,position:this.position().subtract(t.position())}:BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(t){var o=this,e=t.world.children[0];IDEMorph&&IDEMorph.soundEffect&&(IDEMorph.soundEffect.src="http://7xli7a.com2.z0.glb.qiniucdn.com/se/grab.wav",IDEMorph.soundEffect.play()),CostumeEditor.hide(),SoundEditor.hide(),e.showTrashBox(),e.categoriesHtml.el.style.display="none",IDEMorph.hidePalette(),this.allComments().forEach(function(e){e.startFollowing(o,t.world)})},BlockMorph.prototype.justDropped=function(){var t=world.children[0];t.hideTrashBox(),t.categoriesHtml.el.style.display="",this.allComments().forEach(function(t){t.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(t){return!isNil(t.comment)}).map(function(t){return t.comment})},BlockMorph.prototype.destroy=function(){this.allComments().forEach(function(t){t.destroy()}),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var t=this.fullBounds(),o=Math.max(this.allComments().map(function(t){return t.bottom()}))||this.bottom();return Math.max(t.bottom(),o)-t.top()},BlockMorph.prototype.snap=function(){var t=this.topBlock();t.allComments().forEach(function(o){o.align(t)}),this.getHighlight()&&this!==t&&this.removeHighlight(),t.getHighlight()&&t.addHighlight(t.removeHighlight())},CommandBlockMorph.prototype=new BlockMorph,CommandBlockMorph.prototype.constructor=CommandBlockMorph,CommandBlockMorph.uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(){CommandBlockMorph.uber.init.call(this),this.setExtent(new Point(200,100)),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var t=this.nextBlock(),o=[this];return t&&(o=o.concat(t.blockSequence())),o},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph&&!t.isPrototype});var o=this.nextBlock(),e=this.parentThatIsA(CommandSlotMorph);this.add(t),o&&t.bottomBlock().nextBlock(o),this.fixLayout(),e&&e.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var t=[];return this instanceof HatBlockMorph||this.parent instanceof SyntaxElementMorph||t.push({point:this.topAttachPoint(),element:this,loc:"top",type:"block"}),this.isStop()||t.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),t},CommandBlockMorph.prototype.allAttachTargets=function(t){var o,e=this,r=t||this.parent,i=[];return o=r.children.filter(function(t){return t!==e&&t instanceof SyntaxElementMorph&&!t.isTemplate}),o.forEach(function(t){t.forAllChildren(function(t){t.attachTargets&&t.attachTargets().forEach(function(t){i.push(t)})})}),i},CommandBlockMorph.prototype.closestAttachTarget=function(t){var o,e=t||this.parent,r=this.bottomBlock(),i=null,n=Math.max(2*this.corner+this.dent,this.minSnapDistance),h=[],s=1e3;return this instanceof HatBlockMorph||h.push({point:this.topAttachPoint(),loc:"top"}),this.isStop()||h.push({point:r.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(e).forEach(function(t){h.forEach(function(e){e.loc!==t.loc&&(o=e.point.distanceTo(t.point),n>o&&s>o&&(s=o,i=t))})}),i},CommandBlockMorph.prototype.snap=function(){var t,o,e,r=this.closestAttachTarget(),i=this.parentThatIsA(ScriptsMorph);return i.clearDropHistory(),i.lastDroppedBlock=this,null===r?(this.startLayout(),this.fixBlockColor(),this.endLayout(),void CommandBlockMorph.uber.snap.call(this)):(i.lastDropTarget=r,this.startLayout(),"bottom"===r.loc?("slot"===r.type?(this.removeHighlight(),i.lastNextBlock=r.element.nestedBlock(),r.element.nestedBlock(this)):(i.lastNextBlock=r.element.nextBlock(),r.element.nextBlock(this)),this.isStop()&&(t=this.nextBlock(),t&&(i.add(t),t.moveBy(this.extent().floorDivideBy(2)),e=this.parentThatIsA(CommandSlotMorph),e&&e.fixLayout()))):"top"===r.loc&&(r.element.removeHighlight(),o=this.bottomBlock().bottom()-this.bottom(),this.setBottom(r.element.top()+this.corner-o),this.setLeft(r.element.left()),this.bottomBlock().nextBlock(r.element)),this.fixBlockColor(),this.endLayout(),void CommandBlockMorph.uber.snap.call(this))},CommandBlockMorph.prototype.isStop=function(){return["doStopThis","doStop","doStopBlock","doStopAll","doForever","doReport","removeClone"].indexOf(this.selector)>-1},CommandBlockMorph.prototype.userDestroy=function(){if(this.nextBlock())return void this.userDestroyJustThis();var t=this.parentThatIsA(CSlotMorph);this.destroy(),t&&t.fixLayout()},CommandBlockMorph.prototype.userDestroyJustThis=function(){var t,o,e=this.parentThatIsA(ScriptsMorph),r=this.parentThatIsA(CommandSlotMorph),i=this.nextBlock(),n=this.parentThatIsA(CSlotMorph);this.parent&&(t=this.parent.parentThatIsA(CommandBlockMorph)),t&&t.nextBlock()===this?o=t:r&&r.nestedBlock()===this&&(o=r),this.destroy(),i?o instanceof CommandSlotMorph?o.nestedBlock(i):o instanceof CommandBlockMorph?o.nextBlock(i):e.add(i):n&&n.fixLayout()},CommandBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawTop(t),this.drawBody(t),this.drawBottom(t),this.eraseHoles(t)},CommandBlockMorph.prototype.drawBody=function(t){t.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)},CommandBlockMorph.prototype.drawTop=function(t){t.beginPath(),t.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(t,0,0),t.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawBottom=function(t){var o=this.height()-2*this.corner;t.beginPath(),t.arc(this.corner,o,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(t,0,this.height()-this.corner),t.arc(this.width()-this.corner,o,this.corner,radians(90),radians(0),!0),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawDent=function(t,o,e){var r=o+2*this.corner+this.inset;t.lineTo(o+this.corner+this.inset,e),t.lineTo(r,e+this.corner),t.lineTo(r+this.dent,e+this.corner),t.lineTo(o+3*this.corner+this.inset+this.dent,e),t.lineTo(this.width()-this.corner,e)},CommandBlockMorph.prototype.drawTopDentEdge=function(t,o,e){var r,i,n,h,s=.5*this.edge,a=o+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,e,0,e+this.edge),r.addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,e+s),t.lineTo(o+this.corner+this.inset,e+s),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(o+3*this.corner+this.inset+this.dent+s,e+s),t.lineTo(this.width()-this.corner,e+s),t.stroke(),h=o+this.corner+this.inset,n=t.createLinearGradient(h-this.edge,e+this.edge,h,e),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrBright),t.strokeStyle=n,t.beginPath(),t.moveTo(o+this.corner+this.inset,e+s),t.lineTo(a,e+this.corner+s),t.stroke(),i=t.createLinearGradient(0,e+this.corner,0,e+this.corner+this.edge),i.addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(a,e+this.corner+s),t.lineTo(a+this.dent,e+this.corner+s),t.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(t,o,e){var r,i,n,h=.5*this.edge,s=o+2*this.corner+this.inset;return t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,e-this.edge,0,e),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,e-h),this.isStop()?t.lineTo(this.width()-this.corner,e-h):t.lineTo(o+this.corner+this.inset-h,e-h),t.stroke(),this.isStop()?null:(i=t.createLinearGradient(0,e+this.corner-this.edge,0,e+this.corner),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(s+h,e+this.corner-h),t.lineTo(s+this.dent,e+this.corner-h),t.stroke(),n=t.createLinearGradient(o+s+this.dent-this.edge,e+this.corner-this.edge,o+s+this.dent,e+this.corner),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(o+s+this.dent,e+this.corner-h),t.lineTo(o+3*this.corner+this.inset+this.dent,e-h),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(o+3*this.corner+this.inset+this.dent,e-h),t.lineTo(this.width()-this.corner,e-h),void t.stroke())},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(t){var o=.5*this.edge,e=t.createLinearGradient(0,0,this.edge,0);e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.corner),t.lineTo(o,this.height()-2*this.corner-o),t.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(t){var o,e=.5*this.edge,r=this.width();o=t.createLinearGradient(r-this.edge,0,r,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(r-e,this.corner+e),t.lineTo(r-e,this.height()-2*this.corner),t.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(t){var o,e=.5*this.edge;o=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(this.corner,this.corner,this.corner-e,radians(-180),radians(-90),!1),t.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(t){var o,e=.5*this.edge,r=this.width()-this.corner,i=this.height()-2*this.corner;o=t.createRadialGradient(r,i,this.corner,r,i,this.corner-this.edge),o.addColorStop(0,this.cachedClrDark),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(r,i,this.corner-e,radians(90),radians(0),!0),t.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,HatBlockMorph.prototype.constructor=HatBlockMorph,HatBlockMorph.uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.blockSequence=function(){var t=HatBlockMorph.uber.blockSequence.call(this);return t.shift(),t},HatBlockMorph.prototype.drawTop=function(t){var o=this.hatWidth,e=this.hatHeight,r=(4*e*e+o*o)/(8*e),i=degrees(4*Math.atan(2*e/o)),n=i/2,h=Math.min(1.7*o,this.width()-this.corner);t.beginPath(),t.moveTo(0,e+this.corner),t.arc(o/2,r,r,radians(-n-90),radians(-90),!1),t.bezierCurveTo(o,0,o,e,h,e),t.arc(this.width()-this.corner,e+this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},HatBlockMorph.prototype.drawBody=function(t){t.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(t){var o=.5*this.edge,e=t.createLinearGradient(0,0,this.edge,0);e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.hatHeight+o),t.lineTo(o,this.height()-2*this.corner-o),t.stroke()},HatBlockMorph.prototype.drawRightEdge=function(t){var o,e=.5*this.edge,r=this.width();o=t.createLinearGradient(r-this.edge,0,r,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(r-e,this.corner+this.hatHeight+e),t.lineTo(r-e,this.height()-2*this.corner),t.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(t){var o,e=.5*this.edge,r=this.hatWidth,i=this.hatHeight,n=(4*i*i+r*r)/(8*i),h=degrees(4*Math.atan(2*i/r)),s=h/2,a=Math.min(1.7*r,this.width()-this.corner);o=t.createRadialGradient(r/2,n,n-this.edge,r/2,n,n),o.addColorStop(1,this.cachedClrBright),o.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(Math.round(r/2),n,n-e,radians(-s-90),radians(-90),!1),t.moveTo(r/2,e),t.bezierCurveTo(r,e,r,i+e,a,i+e),t.lineTo(this.width()-this.corner,i+e),t.stroke()},ReporterBlockMorph.prototype=new BlockMorph,ReporterBlockMorph.prototype.constructor=ReporterBlockMorph,ReporterBlockMorph.uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(t){ReporterBlockMorph.uber.init.call(this),this.isPredicate=t||!1},ReporterBlockMorph.prototype.snap=function(t){var o,e=this.parent;return!e instanceof ScriptsMorph?null:(e.clearDropHistory(),e.lastDroppedBlock=this,o=e.closestInput(this,t),null!==o&&(e.lastReplacedInput=o,e.lastDropTarget=o.parent,o instanceof MultiArgMorph&&(e.lastPreservedBlocks=o.inputs(),e.lastReplacedInput=o.fullCopy()),o.parent.replaceInput(o,this)),this.startLayout(),this.fixBlockColor(),this.endLayout(),void ReporterBlockMorph.uber.snap.call(this))},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(t){var o=this.position();nop(t),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(o)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,t)},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){return contains(["%anyUE","%boolUE","%f"],this.getSlotSpec())},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},ReporterBlockMorph.prototype.getSlotSpec=function(){var t,o;return this.parent instanceof BlockMorph&&(t=this.parent.parts().filter(function(t){return!(t instanceof BlockHighlightMorph)}),o=t.indexOf(this),-1!==o&&this.parent.blockSpec)?this.parseSpec(this.parent.blockSpec)[o]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(t){var o;return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():void(this.parent instanceof TemplateSlotMorph?(o=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph,new DialogBoxMorph(this,this.setSpec,this).prompt(o?"参数名":"脚本变量名称",this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,t))},ReporterBlockMorph.prototype.ExportResultPic=function(){var t,o=this.topBlock(),e=o.receiver();o===this&&e&&(t=e.parentThatIsA(StageMorph),t&&(t.threads.stopProcess(o),t.threads.startProcess(o,!1,!0)))},ReporterBlockMorph.prototype.userDestroy=function(){this.prepareToBeGrabbed(this.world().hand),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(t):this.drawRounded(t),this.eraseHoles(t)},ReporterBlockMorph.prototype.drawRounded=function(t){var o=this.height(),e=Math.min(this.rounding,o/2),r=this.width();this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.arc(e,e,e,radians(-180),radians(-90),!1),t.arc(r-e,e,e,radians(-90),radians(-0),!1),t.arc(r-e,o-e,e,radians(0),radians(90),!1),t.arc(e,o-e,e,radians(90),radians(180),!1),t.closePath(),t.fill()},ReporterBlockMorph.prototype.drawDiamond=function(t){var o=this.width(),e=this.height(),r=Math.floor(e/2),i=this.rounding;this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,r),t.lineTo(i,0),t.lineTo(o-i,0),t.lineTo(o,r),t.lineTo(o-i,e),t.lineTo(i,e),t.closePath(),t.fill()},RingMorph.prototype=new ReporterBlockMorph,RingMorph.prototype.constructor=RingMorph,RingMorph.uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(t,o){var e;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,t instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",e=this.parts()[0],e.nestedBlock(t)):t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",e=this.parts()[0],e.silentReplaceInput(e.contents(),t)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",e=this.parts()[0],e.silentReplaceInput(e.contents(),t)),e=this.parts()[1],o&&o.forEach(function(t){e.addInput(t)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var t=this.parts()[0],o=t.nestedBlock();return o&&this.parent instanceof SyntaxElementMorph?this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===o.selector||o instanceof RingMorph)&&this.parent.silentReplaceInput(this,o)):null},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(t,o){var e=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,t,o),e instanceof RingCommandSlotMorph&&e.fixLayout()},ScriptsMorph.prototype=new FrameMorph,ScriptsMorph.prototype.constructor=ScriptsMorph,ScriptsMorph.uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0,ScriptsMorph.prototype.init=function(t){this.owner=t||null,this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70))},ScriptsMorph.prototype.fullCopy=function(){var t,o=new ScriptsMorph,e=this.position();return this.children.forEach(function(r){r.block||(t=r.fullCopy(),t.setPosition(r.position().subtract(e)),o.add(t),t instanceof BlockMorph&&t.allComments().forEach(function(o){o.align(t)}))}),o.adjustBounds(),o},ScriptsMorph.prototype.step=function(){var t,o=this.world().hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),0===o.children.length?null:this.bounds.containsPoint(o.bounds.origin)?(t=o.children[0],(t instanceof BlockMorph||t instanceof CommentMorph)&&contains(o.morphAtPointer().allParents(),this)?void(t instanceof CommentMorph?this.showCommentDropFeedback(t,o):t instanceof ReporterBlockMorph?this.showReporterDropFeedback(t,o):this.showCommandDropFeedback(t)):null):null},ScriptsMorph.prototype.showReporterDropFeedback=function(t,o){var e=this.closestInput(t,o);return null===e?null:(this.feedbackMorph.bounds=e.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),e instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed())},ScriptsMorph.prototype.showCommandDropFeedback=function(t){var o,e;return(e=t.closestAttachTarget(this))?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(e.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),o=e.point.y,"bottom"===e.loc&&("block"===e.type?e.element.nextBlock()&&(o-=SyntaxElementMorph.prototype.corner):"slot"===e.type&&e.element.nestedBlock()&&(o-=SyntaxElementMorph.prototype.corner)),void this.feedbackMorph.setPosition(new Point(e.element.left(),o))):null},ScriptsMorph.prototype.showCommentDropFeedback=function(t,o){var e=this.closestBlock(t,o);return e?(this.feedbackMorph.bounds=e.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed()):null},ScriptsMorph.prototype.closestInput=function(t,o){function e(t,o){return t instanceof MultiArgMorph?o?t.arrows().bounds.containsPoint(o):t.arrows().bounds.intersects(h):!0}var r,i,n,h=t.fullBoundsNoShadow(),s=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(h)}),a=t.allInputs();if(n=[],s.forEach(function(t){n=n.concat(t.allInputs())}),0===n.length)return null;if(this.isPreferringEmptySlots){if(o&&(r=o.position(),i=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(r)&&!contains(a,t)&&e(t,r)})))return i;if(i=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(h)&&!contains(a,t)&&e(t);
}))return i}return o&&(r=o.position(),i=detect(n,function(o){return o!==t&&!o.isLocked()&&o.bounds.containsPoint(r)&&!(o.parent instanceof PrototypeHatBlockMorph)&&!contains(a,o)}))?i:detect(n,function(o){return o!==t&&!o.isLocked()&&o.fullBounds().intersects(h)&&!(o.parent instanceof PrototypeHatBlockMorph)&&!contains(a,o)})},ScriptsMorph.prototype.closestBlock=function(t,o){var e,r,i,n=t.bounds,h=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(n)});return i=[],h.forEach(function(t){i=i.concat(t.allChildren().slice(0).reverse().filter(function(t){return t instanceof BlockMorph&&!t.isTemplate}))}),0===i.length?null:o&&(e=o.position(),r=detect(i,function(t){return!t.comment&&!t.isPrototype&&t.bounds.containsPoint(e)}))?r:detect(i,function(t){return!t.comment&&!t.isPrototype&&t.bounds.intersects(n)})},ScriptsMorph.prototype.userMenu=function(){var t,o=new MenuMorph(this),e=this.parentThatIsA(IDE_Morph),r=this.owner;r.parentThatIsA(StageMorph);return e||(t=this.parentThatIsA(BlockEditorMorph),t&&(e=t.target.parentThatIsA(IDE_Morph))),o.addItem("整理脚本","cleanUp","整理脚本，垂直排列"),o.addItem("添加注释","addComment"),o.addItem("流程图...","sendScriptsPicture","将流程图发布到百科"),o},ScriptsMorph.prototype.cleanUp=function(){var t=this.topLeft(),o=this.cleanUpMargin,e=this;this.children.sort(function(t,o){return t instanceof PrototypeHatBlockMorph?0:t.top()-o.top()}).forEach(function(r){r instanceof CommentMorph&&r.block||(r.setPosition(t.add(new Point(e.cleanUpMargin,o))),r instanceof BlockMorph&&r.allComments().forEach(function(t){t.align(r,!0)}),o+=r.stackHeight()+e.cleanUpSpacing)}),this.parent&&this.setPosition(this.parent.topLeft()),this.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture();return t?t.toDataURL():void 0},ScriptsMorph.prototype.sendScriptsPicture=function(){"use strict";var t;t=this.exportScriptsPicture();var o=new CDNUpload;o.getToken(t,function(t){openPostWindow(t.src)})},ScriptsMorph.prototype.scriptsPicture=function(){var t,o,e;if(0!==this.children.length)return t=this.children[0].fullBounds(),this.children.forEach(function(o){o.isVisible&&(t=t.merge(o.fullBounds()))}),o=newCanvas(t.extent()),e=o.getContext("2d"),this.children.forEach(function(o){var r=o.position();o.isVisible&&e.drawImage(o.fullImageClassic(),r.x-t.origin.x,r.y-t.origin.y)}),o},ScriptsMorph.prototype.addComment=function(){(new CommentMorph).pickUp(this.world())},ScriptsMorph.prototype.undrop=function(){this.lastDroppedBlock&&(this.lastDroppedBlock instanceof CommandBlockMorph?(this.lastNextBlock&&this.add(this.lastNextBlock),this.lastDropTarget&&("bottom"===this.lastDropTarget.loc?"slot"===this.lastDropTarget.type?this.lastNextBlock&&this.lastDropTarget.element.nestedBlock(this.lastNextBlock):this.lastNextBlock&&this.lastDropTarget.element.nextBlock(this.lastNextBlock):"top"===this.lastDropTarget.loc&&this.add(this.lastDropTarget.element))):this.lastDropTarget&&(this.lastDropTarget.replaceInput(this.lastDroppedBlock,this.lastReplacedInput),this.lastDropTarget.fixBlockColor(null,!0),this.lastPreservedBlocks&&this.lastPreservedBlocks.forEach(function(t){t.destroy()})),this.lastDroppedBlock.pickUp(this.world()),this.clearDropHistory())},ScriptsMorph.prototype.clearDropHistory=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null},ScriptsMorph.prototype.fixMultiArgs=function(){var t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(t){t instanceof MultiArgMorph&&t.fixLayout()}),Morph.prototype.trackChanges=t},ScriptsMorph.prototype.wantsDropOf=function(t){return t instanceof SyntaxElementMorph||t instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(t,o){(t instanceof BlockMorph||t instanceof CommentMorph)&&t.snap(o),this.adjustBounds()},ArgMorph.prototype=new SyntaxElementMorph,ArgMorph.prototype.constructor=ArgMorph,ArgMorph.uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(t){this.type=t||null,this.isHole=!1,ArgMorph.uber.init.call(this),this.color=new Color(0,17,173),this.setExtent(new Point(50,50))},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)},ArgMorph.prototype.listIcon=function(){var t,o,e,r,i=new Morph,n=new CellMorph,h=new CellMorph;return i.color=new Color(255,255,255),h.setPosition(n.bottomLeft().add(new Point(0,this.fontSize/3))),n.add(h),n.setPosition(i.position().add(this.fontSize)),i.add(n),i.bounds.corner=h.bounds.corner.add(this.fontSize),i.drawNew(),t=i.fullImage(),r=(this.fontSize+this.edge)/t.height,o=newCanvas(new Point(Math.ceil(t.width*r)+1,Math.ceil(t.height*r)+1)),e=o.getContext("2d"),e.fillStyle="black",e.fillRect(0,0,o.width,o.height),e.scale(r,r),e.drawImage(t,1/r,1/r),o},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,CommandSlotMorph.prototype.constructor=CommandSlotMorph,CommandSlotMorph.uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph});var o=this.nestedBlock();this.add(t),o&&t.bottomBlock().nextBlock(o),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},CommandSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var t=this.overlappedMorphs(),o=new MenuMorph(this,"choose new parent:"),e=this;t.forEach(function(t){o.addItem(t.toString().slice(0,50),function(){t.add(e),e.isDraggable=!1,t.fixLayout&&t.fixLayout()})}),t.length>0&&o.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t)},CommandSlotMorph.prototype.drawFlat=function(t){var o=null!==this.nestedBlock(),e=o?this.inset:this.inset/2,r=o?this.dent:this.dent/2,i=2*this.corner+e,n=this.edge,h=o?this.rfBorder:0,s=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+e+n+2*h,n),t.lineTo(i+n+2*h,this.corner+n),t.lineTo(i+n+2*h+(r-2*h),this.corner+n),t.lineTo(i+n+2*h+(r-2*h)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.arc(this.width()-this.corner-n,s,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,s,this.corner,radians(90),radians(180),!1),t.closePath(),t.fill()},CommandSlotMorph.prototype.drawEdges=function(t){var o,e,r,i,n=null!==this.nestedBlock(),h=n?this.inset:this.inset/2,s=n?this.dent:this.dent/2,a=2*this.corner+h,l=this.edge,p=n?this.rfBorder:0,c=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o=t.createLinearGradient(0,this.height(),0,this.height()-this.edge),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(this.corner+l,this.height()-c),t.lineTo(this.width()-this.corner-l,this.height()-c),t.stroke(),o=t.createRadialGradient(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner,this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+l),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+c,radians(0),radians(90),!1),t.stroke(),o=t.createLinearGradient(this.width(),0,this.width()-this.edge,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(this.width()-c,this.height()-this.corner-this.edge),t.lineTo(this.width()-c,l+this.corner),t.stroke(),t.shadowOffsetY=c,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString(),o=t.createLinearGradient(0,0,l,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(c,l+this.corner),t.lineTo(c,this.height()-l-this.corner),t.stroke(),o=t.createRadialGradient(this.corner+l,this.corner+l,this.corner,this.corner+l,this.corner+l,this.corner+l),o.addColorStop(0,this.cachedClrDark),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.corner+l,this.corner+l,this.corner+c,radians(-180),radians(-90),!1),t.stroke(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+l,c),t.lineTo(this.corner+h+l+2*p-c,c),t.stroke(),r=t.createLinearGradient(0,this.corner,0,this.corner+l),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+l+2*p+c,this.corner+c),t.lineTo(a+l+2*p+(s-2*p),this.corner+c),t.stroke(),i=t.createLinearGradient(a+l+2*p+(s-2*p)-c,this.corner,a+l+2*p+(s-2*p)+.7*c,this.corner+c+.7*c),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(a+l+2*p+(s-2*p),this.corner+c),t.lineTo(a+l+2*p+(s-2*p)+this.corner,c),t.stroke(),t.strokeStyle=e,t.beginPath(),t.moveTo(a+l+2*p+(s-2*p)+this.corner,c),t.lineTo(this.width()-this.corner-l,c),t.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph,RingCommandSlotMorph.uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(){RingCommandSlotMorph.uber.init.call(this),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawFlat(t)},RingCommandSlotMorph.prototype.drawFlat=function(t){var o=null!==this.nestedBlock(),e=o?this.inset:this.inset/2,r=o?this.dent:this.dent/2,i=2*this.corner+e,n=this.edge,h=this.width(),s=this.height(),a=o?this.rfBorder:0,l=s-this.corner-n;t.beginPath(),t.moveTo(0,s/2),t.lineTo(n,s/2),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+e+n+2*a,n),t.lineTo(i+n+2*a,this.corner+n),t.lineTo(i+n+2*a+(r-2*a),this.corner+n),t.lineTo(i+n+2*a+(r-2*a)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(h-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.lineTo(h-this.edge,s/2),t.lineTo(h,s/2),t.lineTo(h,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(h,s/2),t.lineTo(h-n,s/2),t.arc(this.width()-this.corner-n,l,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,l,this.corner,radians(90),radians(180),!1),t.lineTo(n,s/2),t.lineTo(0,s/2),t.lineTo(0,s),t.lineTo(h,s),t.closePath(),t.fill()},CSlotMorph.prototype=new CommandSlotMorph,CSlotMorph.prototype.constructor=CSlotMorph,CSlotMorph.uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this),this.isHole=!0,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))},CSlotMorph.prototype.getSpec=function(){return"%c"},CSlotMorph.prototype.mappedCode=function(t){var o=StageMorph.prototype.codeMappings.reify||"<#1>",e=o.split("\n"),r=this.nestedBlock(),i=r?r.mappedCode(t):"",n=i.toString().split("\n"),h=new RegExp("<#1>","g");return e.forEach(function(t,o){var r,i="";0===t.trimLeft().indexOf("<#1>")&&(r=t.indexOf("<#1>"),i=t.slice(0,r)),e[o]=t.replace(new RegExp("<#1>"),n.join("\n"+i)),e[o]=e[o].replace(h,n.join("\n"))}),e.join("\n")},CSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(t.fullBounds().height()+this.corner),this.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||(this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},CSlotMorph.prototype.drawFlat=function(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.width(),0),t.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),t.lineTo(this.width()-this.corner,this.corner),t.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),t.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),t.lineTo(2*this.inset+2*this.corner,2*this.corner),t.lineTo(2*this.inset+this.corner,this.corner),t.lineTo(this.inset+this.corner,this.corner),t.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),t.lineTo(this.inset,this.height()-2*this.corner),t.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),t.lineTo(this.width()-this.corner,this.height()-this.corner),t.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),t.lineTo(0,this.height()),t.closePath(),t.fill()},CSlotMorph.prototype.drawTopRightEdge=function(t){var o,e=.5*this.edge,r=this.width()-this.corner,i=0;o=t.createRadialGradient(r,i,this.corner,r,i,this.corner-this.edge),o.addColorStop(0,this.cachedClrDark),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(r,i,this.corner-e,radians(90),radians(0),!0),t.stroke()},CSlotMorph.prototype.drawTopEdge=function(t,o,e){var r,i,n,h=.5*this.edge,s=o+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,e-this.edge,0,e),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(o+this.corner,e-h),t.lineTo(o+this.corner+this.inset-h,e-h),t.stroke(),i=t.createLinearGradient(0,e+this.corner-this.edge,0,e+this.corner),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(s+h,e+this.corner-h),t.lineTo(s+this.dent,e+this.corner-h),t.stroke(),n=t.createLinearGradient(o+this.inset+2*this.corner+this.dent-h,e+this.corner-h-h,o+this.inset+2*this.corner+this.dent+.7*h,e+this.corner-h+.7*h),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(o+this.inset+2*this.corner+this.dent,e+this.corner-h),t.lineTo(o+3*this.corner+this.inset+this.dent,e-h),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(o+3*this.corner+this.inset+this.dent,e-h),t.lineTo(this.width()-this.corner,e-h),t.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(t){var o,e=.5*this.edge;o=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge),o.addColorStop(0,this.cachedClrDark),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+e,radians(-180),radians(-90),!1),t.stroke()},CSlotMorph.prototype.drawRightEdge=function(t){var o,e=.5*this.edge,r=this.inset;o=t.createLinearGradient(r-this.edge,0,r,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(r-e,2*this.corner),t.lineTo(r-e,this.height()-2*this.corner),t.stroke()},CSlotMorph.prototype.drawBottomEdge=function(t){var o,e,r=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+r,radians(180),radians(90),!0),t.stroke(),o=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+r),t.lineTo(this.width()-this.corner,this.height()-this.corner+r),t.stroke()},InputSlotMorph.prototype=new ArgMorph,InputSlotMorph.prototype.constructor=InputSlotMorph,InputSlotMorph.uber=ArgMorph.prototype,InputSlotMorph.prototype.executeOnSliderEdit=!1,InputSlotMorph.prototype.init=function(t,o,e,r){var i=new StringMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.isShowingBlanks=!0,i.drawNew(),this.isUnevaluated=!1,this.choices=e||null,this.oldContentsExtent=i.extent(),this.isNumeric=o||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(t){var o=this.contents(),e=t,r=e instanceof Array;if(r){switch(e[0]){case"_Recording":return void SoundEditor.show();case"_More":return void(materialVM.displayMaterialWindow=!0)}e=localize(e[0]),o.isItalic=!1}else if(o.isItalic=!1,null!==this.choices&&this.choices[e]instanceof Array)return this.setContents(this.choices[e]);o.text=e,isNil(e)?o.text="":e.toString&&(o.text=e.toString()),o.drawNew(),this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor(),this.constant=r?t:null},InputSlotMorph.prototype.dropDownMenu=function(){var t,o=this.choices,e=new MenuMorph(this.setContents,null,this,16);if(o instanceof Function?o=o.call(this):isString(o)&&(o=this[o]()),!o)return null;for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&("~"===t[0]?e.addLine():e.addItem(t,o[t]));return e.items.length>0?void e.popUpAtHand(this.world()):null},InputSlotMorph.prototype.messagesMenu=function(){var t={},o=this.parentThatIsA(BlockMorph).receiver(),e=o.parentThatIsA(StageMorph),r=this,i=[];return e.children.concat(e).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(o){t[o]=o}),i.length>0&&(t["~"]=null),t["new..."]=function(){new DialogBoxMorph(r,r.setContents,r).prompt("消息名称",null,r.world())},t},InputSlotMorph.prototype.messagesReceivedMenu=function(){var t={"任何消息":["any message"]},o=this.parentThatIsA(BlockMorph).receiver(),e=o.parentThatIsA(StageMorph),r=this,i=[];return e.children.concat(e).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(o){t[o]=o}),t["~"]=null,t["new..."]=function(){new DialogBoxMorph(r,r.setContents,r).prompt("消息名称",null,r.world())},t},InputSlotMorph.prototype.collidablesMenu=function(){var t={"鼠标指针":["mouse-pointer"],"边缘":["edge"],"画笔轨迹":["pen trails"]},o=this.parentThatIsA(BlockMorph).receiver(),e=o.parentThatIsA(StageMorph),r=[];return e.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&t.name!==o.name&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(o){t[o]=o})),t},InputSlotMorph.prototype.distancesMenu=function(){var t={"鼠标指针":["mouse-pointer"]},o=this.parentThatIsA(BlockMorph).receiver(),e=o.parentThatIsA(StageMorph),r=[];return e.children.forEach(function(t){t instanceof SpriteMorph&&t.name!==o.name&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(o){t[o]=o})),t},InputSlotMorph.prototype.draggableMenu=function(){return{"可拖动":"可拖动","不可拖动":"不可拖动"}},InputSlotMorph.prototype.clonablesMenu=function(){var t={},o=this.parentThatIsA(BlockMorph).receiver(),e=o.parentThatIsA(StageMorph),r=[];return o instanceof SpriteMorph&&(t.myself=["myself"]),e.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(o){t[o]=o})),t},InputSlotMorph.prototype.objectsMenu=function(){var t=this.parentThatIsA(BlockMorph).receiver(),o=t.parentThatIsA(StageMorph),e={},r=[];return e[o.name]=o.name,o.children.forEach(function(t){t instanceof SpriteMorph&&r.push(t.name)}),r.length>0&&(e["~"]=null,r.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.attributesMenu=function(){var t,o=this.parentThatIsA(BlockMorph),e=o.inputs()[0].evaluate(),r=o.receiver(),i=r.parentThatIsA(StageMorph),n={},h=[];return(t=e===i.name?i:detect(i.children,function(t){return t.name===e}))?(n=t instanceof SpriteMorph?{"x坐标":["x position"],"y坐标":["y position"],"方向":["direction"],"造型编号":["costume #"],"造型名字":["costume name"],"大小":["size"]}:{"造型编号":["costume #"],"造型名字":["costume name"]},h=t.variables.names(),h.length>0&&(n["~"]=null,h.forEach(function(t){n[t]=t})),n):n},InputSlotMorph.prototype.costumesMenu=function(){var t,o=this.parentThatIsA(BlockMorph).receiver(),e=[];return t={Empty:["空白"]},o.costumes.asArray().forEach(function(t){e=e.concat(t.name)}),e.length>0&&(t["~"]=null,e.forEach(function(o){t[o]=o})),t},InputSlotMorph.prototype.soundsMenu=function(){var t=this.parentThatIsA(BlockMorph).receiver(),o=[],e={};return e={_Recording:["_Recording"],_More:["_More"]},t.sounds.asArray().forEach(function(t){o=o.concat(t.name)}),o.length>0&&(e["~"]=null,o.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.getVarNamesDict=function(){var t,o,e=this.parentThatIsA(BlockMorph),r=[];return e?(t=e.receiver(),e.allParents().forEach(function(t){t instanceof PrototypeHatBlockMorph?r.push.apply(r,t.inputs()[0].inputFragmentNames()):t instanceof BlockMorph&&t.inputs().forEach(function(t){t instanceof TemplateSlotMorph?r.push(t.contents()):t instanceof MultiArgMorph&&t.children.forEach(function(t){t instanceof TemplateSlotMorph&&r.push(t.contents())})})}),t?(o=t.variables.allNamesDict(),r.forEach(function(t){o[t]=t}),o):{}):{}},InputSlotMorph.prototype.setChoices=function(t,o){var e=this.contents();this.choices=t,this.isReadOnly=o||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),o||(e.shadowOffset=new Point,e.shadowColor=null,e.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.fixLayout=function(){var t=this.contents(),o=this.arrow();t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.isReadOnly?(t.disableSelecting(),t.color=new Color(254,254,254)):(t.enableSelecting(),t.color=new Color(0,0,0)),this.choices?(o.setSize(this.fontSize),o.show()):(o.setSize(0),o.hide()),this.setHeight(t.height()+2*this.edge),this.isNumeric?this.setWidth(t.width()+Math.floor(.5*o.width())+this.height()+2*this.typeInPadding):this.setWidth(Math.max(t.width()+o.width()+2*this.edge+2*this.typeInPadding,t.rawHeight?t.rawHeight()+o.width():t.height()/1.2+o.width(),this.minWidth)),this.isNumeric?t.setPosition(new Point(Math.floor(this.height()/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):t.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),o.setPosition(new Point(this.right()-o.width()-this.edge,t.top()));var e=document.querySelector("#myinput");e&&(e.style.width=this.contents().width()+4+"px"),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(t){this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):(this.contents().edit(),this.contents().selectAll())},InputSlotMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():(this.contents().edit(),this.contents().selectAll())},InputSlotMorph.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.drawNew())},InputSlotMorph.prototype.reactToEdit=function(){this.contents().clearSelection()},InputSlotMorph.prototype.reactToSliderEdit=function(){var t,o,e,r;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(BlockMorph))){if(o=t.topBlock(),e=o.receiver(),o instanceof PrototypeHatBlockMorph)return;e&&(r=e.parentThatIsA(StageMorph),r&&r.isThreadSafe?r.threads.startProcess(o,r.isThreadSafe):o.mouseClickLeft())}},InputSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return!StageMorph.prototype.enableCodeMapping||this.isNumeric?this.parent.userMenu():(t.addItem("code string mapping...","mapToCode"),t)},InputSlotMorph.prototype.mapToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.string=t},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var t=StageMorph.prototype.codeMappings.string||"<#1>",o=this.parentThatIsA(BlockMorph),e=this.evaluate();return this.isNumeric?e:isNaN(parseFloat(e))&&isString(e)?o&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],o.selector)?e:t.replace(/<#1>/g,e):e},InputSlotMorph.prototype.evaluate=function(){var t,o=this.contents();return this.constant?this.constant:this.isNumeric&&(t=parseFloat(o.text||"0"),!isNaN(t))?t:o.text},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text},InputSlotMorph.prototype.drawNew=function(){var t,o,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),o=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&(t.fillStyle=o.darker().toString()),this.cachedClr=o.toString(),this.cachedClrBright=o.lighter(this.contrast).toString(),this.cachedClrDark=o.darker(this.contrast).toString(),this.isNumeric?(e=(this.height()-2*this.edge)/2,t.beginPath(),t.arc(e+this.edge,e+this.edge,e,radians(90),radians(-90),!1),t.arc(this.width()-e-this.edge,e+this.edge,e,radians(-90),radians(90),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t))},InputSlotMorph.prototype.drawRectBorder=function(t){var o,e=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=e,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(this.edge,e),t.lineTo(this.width()-this.edge-e,e),t.stroke(),t.shadowOffsetY=0,o=t.createLinearGradient(0,0,this.edge,0),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.edge),t.lineTo(e,this.height()-this.edge-e),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,o=t.createLinearGradient(0,this.height()-this.edge,0,this.height()),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(this.edge,this.height()-e),t.lineTo(this.width()-this.edge,this.height()-e),t.stroke(),o=t.createLinearGradient(this.width()-this.edge,0,this.width(),0),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(this.width()-e,this.edge),t.lineTo(this.width()-e,this.height()-this.edge),t.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(t){var o,e,r,i=.5*this.edge,n=(this.height()-2*this.edge)/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o=n+this.edge,e=this.width()-n-this.edge,e>o&&(t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),r=t.createLinearGradient(0,0,0,this.edge),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(o,i),t.lineTo(e,i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),r=t.createLinearGradient(0,this.height()-this.edge,0,this.height()),r.addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(n+this.edge,this.height()-i),t.lineTo(this.width()-n-this.edge,this.height()-i),t.stroke(),n=this.height()/2,t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),r=t.createRadialGradient(n,n,n-this.edge,n,n,n),r.addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.arc(n,n,n-i,radians(180),radians(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,r=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n),r.addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrBright),t.strokeStyle=r,t.beginPath(),t.arc(this.width()-n,n,n-i,radians(0),radians(90),!1),t.stroke()},TemplateSlotMorph.prototype=new ArgMorph,TemplateSlotMorph.prototype.constructor=TemplateSlotMorph,TemplateSlotMorph.uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(t){var o=new ReporterBlockMorph;this.labelString=t||"",o.isDraggable=!1,o.isTemplate=!0,void 0!==modules.objects?(o.color=SpriteMorph.prototype.blockColor.variables,o.category="variables"):(o.color=new Color(243,118,29),o.category=null),o.setSpec(this.labelString),
o.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(o),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(t){var o=this.template();o.setSpec(t),o.fixBlockColor(),o.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var t=this.template();this.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.drawNew=function(){var t;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawRounded(t)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,BooleanSlotMorph.prototype=new ArgMorph,BooleanSlotMorph.prototype.constructor=BooleanSlotMorph,BooleanSlotMorph.uber=ArgMorph.prototype,BooleanSlotMorph.prototype.init=function(){BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return"%b"},BooleanSlotMorph.prototype.drawNew=function(){var t;this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.parent&&(this.color=this.parent.color),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.drawDiamond(t,!0)},BooleanSlotMorph.prototype.drawDiamond=function(t){var o,e=this.width(),r=this.height(),i=r/2,n=this.edge/2;t.fillStyle=this.color.darker(25).toString(),t.beginPath(),t.moveTo(0,i),t.lineTo(i,0),t.lineTo(e-i,0),t.lineTo(e,i),t.lineTo(e-i,r),t.lineTo(i,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetX=n,t.shadowBlur=n,t.shadowColor="black",o=t.createLinearGradient(0,i,.6*this.edge,i+.6*this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,i),t.lineTo(i,n),t.closePath(),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=n,t.shadowBlur=this.edge,o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(i,n),t.lineTo(e-i,n),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,o=t.createLinearGradient(e-i-.6*this.edge,r-.6*this.edge,e-i,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(e-i,r-n),t.lineTo(e-n,i),t.closePath(),t.stroke(),o=t.createLinearGradient(0,r-this.edge,0,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(i,r-n),t.lineTo(e-i-n,r-n),t.closePath(),t.stroke())},BooleanSlotMorph.prototype.isEmptySlot=function(){return!0},ArrowMorph.prototype=new Morph,ArrowMorph.prototype.constructor=ArrowMorph,ArrowMorph.uber=Morph.prototype,ArrowMorph.prototype.init=function(t,o,e,r){this.direction=t||"down",this.size=o||(0===o?0:50),this.padding=e||0,ArrowMorph.uber.init.call(this),this.color=r||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(t){var o=Math.max(t,1);this.size=t,this.setExtent(new Point(o,o))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),o=this.padding,e=this.height(),r=Math.floor(e/2),i=this.width(),n=Math.floor(i/2);t.fillStyle=this.color.toString(),t.beginPath(),"down"===this.direction?(t.moveTo(o,r),t.lineTo(i-o,r),t.lineTo(n,e-o)):"up"===this.direction?(t.moveTo(o,r),t.lineTo(i-o,r),t.lineTo(n,o)):"left"===this.direction?(t.moveTo(o,r),t.lineTo(n,o),t.lineTo(n,e-o)):(t.moveTo(n,o),t.lineTo(i-o,r),t.lineTo(n,e-o)),t.closePath(),t.fill()},TextSlotMorph.prototype=new InputSlotMorph,TextSlotMorph.prototype.constructor=TextSlotMorph,TextSlotMorph.uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(t,o,e,r){var i=new TextMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.drawNew(),this.isUnevaluated=!1,this.choices=e||null,this.oldContentsExtent=i.extent(),this.isNumeric=o||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof TextMorph})},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},SymbolMorph.prototype=new Morph,SymbolMorph.prototype.constructor=SymbolMorph,SymbolMorph.uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","line","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot"],SymbolMorph.prototype.init=function(t,o,e,r,i){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=o||(0===o?0:40),this.shadowOffset=r||new Point(0,0),this.shadowColor=i||null,SymbolMorph.uber.init.call(this),this.color=e||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(t,o,e){this.shadowOffset=e,this.shadowColor=o,this.setColor(t)},SymbolMorph.prototype.drawNew=function(){var t,o,e,r,i;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),t=this.image.getContext("2d"),r=this.shadowOffset.x<0?0:this.shadowOffset.x,i=this.shadowOffset.y<0?0:this.shadowOffset.y,o=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,e=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&t.drawImage(this.symbolCanvasColored(this.shadowColor),r,i),t.drawImage(this.symbolCanvasColored(this.color),o,e)},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var o=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"deleteIcon":return this.drawSymbolDeleteIcon(o,t);case"square":return this.drawSymbolStop(o,t);case"pointRight":return this.drawSymbolPointRight(o,t);case"gears":return this.drawSymbolGears(o,t);case"openProject":return this.drawSymbolOpenProject(o,t);case"file":return this.drawSymbolFile(o,t);case"fullScreen":return this.drawSymbolFullScreen(o,t);case"zoomin":return this.drawSymbolZoomin(o,t);case"zoomout":return this.drawSymbolZoomout(o,t);case"sflip":return this.drawSymbolSflip(o,t);case"cflip":return this.drawSymbolCflip(o,t);case"rotate":return this.drawSymbolRotate(o,t);case"undo":return this.drawSymbolUndo(o,t);case"normalScreen":return this.drawSymbolNormalScreen(o,t);case"smallStage":return this.drawSymbolSmallStage(o,t);case"normalStage":return this.drawSymbolNormalStage(o,t);case"turtle":return this.drawSymbolTurtle(o,t);case"stage":return this.drawSymbolStop(o,t);case"turtleOutline":return this.drawSymbolTurtleOutline(o,t);case"pause":return this.drawSymbolPause(o,t);case"pencil":return this.drawSymbolPencil(o,t);case"flag":return this.drawSymbolFlag(o,t);case"octagon":return this.drawSymbolOctagon(o,t);case"cloud":return this.drawSymbolCloud(o,t);case"cloudfile":return this.drawSymbolCloudfile(o,t);case"cloudOutline":return this.drawSymbolCloudOutline(o,t);case"cloudGradient":return this.drawSymbolCloudGradient(o,t);case"turnRight":return this.drawSymbolTurnRight(o,t);case"turnLeft":return this.drawSymbolTurnLeft(o,t);case"storage":return this.drawSymbolStorage(o,t);case"poster":return this.drawSymbolPoster(o,t);case"flash":return this.drawSymbolFlash(o,t);case"brush":return this.drawSymbolBrush(o,t);case"library":return this.drawSymbolLibrary(o,t);case"rectangle":return this.drawSymbolRectangle(o,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(o,t);case"circle":return this.drawSymbolCircle(o,t);case"circleSolid":return this.drawSymbolCircleSolid(o,t);case"line":return this.drawSymbolLine(o,t);case"crosshairs":return this.drawSymbolCrosshairs(o,t);case"paintbucket":return this.drawSymbolPaintbucket(o,t);case"eraser":return this.drawSymbolEraser(o,t);case"pipette":return this.drawSymbolPipette(o,t);case"speechBubble":return this.drawSymbolSpeechBubble(o,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(o,t);case"arrowUp":return this.drawSymbolArrowUp(o,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(o,t);case"arrowLeft":return this.drawSymbolArrowLeft(o,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(o,t);case"arrowDown":return this.drawSymbolArrowDown(o,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(o,t);case"arrowRight":return this.drawSymbolArrowRight(o,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(o,t);case"robot":return this.drawSymbolRobot(o,t);case"modify":return this.drawSymbolModify(o,t);case"inputText":return this.drawSymbolInputText(o,t);default:return o}},SymbolMorph.prototype.symbolWidth=function(){var t=this.size;if(this.name instanceof Costume)return t/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"flash":case"file":return t;case"smallStage":case"normalStage":return 1.2*t;case"turtleOutline":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":return t;case"turnRight":case"turnLeft":return t/3*2;case"flag":case"octagon":return 100;default:return t}},SymbolMorph.prototype.drawSymbolStop=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/stop.gif",100,35),t},SymbolMorph.prototype.drawSymbolPointRight=function(t,o){var e=t.getContext("2d");return e.fillStyle=o.toString(),e.beginPath(),e.moveTo(0,0),e.lineTo(t.width,Math.round(t.height/2)),e.lineTo(0,t.height),e.lineTo(0,0),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolGears=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/save.png",30,30),t},SymbolMorph.prototype.drawSymbolFile=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/new.png",30,30),t},SymbolMorph.prototype.drawSymbolFullScreen=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/fullscreen.png",25,25),t},SymbolMorph.prototype.drawSymbolZoomin=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/zoomin.png",25,25),t},SymbolMorph.prototype.drawSymbolZoomout=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/zoomout.png",25,25),t},SymbolMorph.prototype.drawSymbolSflip=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/sflip.png",25,25),t},SymbolMorph.prototype.drawSymbolCflip=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/cflip.png",25,25),t},SymbolMorph.prototype.drawSymbolRotate=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/rotate.png",25,25),t},SymbolMorph.prototype.drawSymbolUndo=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/undo.png",25,25),t},SymbolMorph.prototype.drawSymbolNormalScreen=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/narrow.png",25,25),t},SymbolMorph.prototype.drawSymbolSmallStage=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/extend.png",25,25),t},SymbolMorph.prototype.drawSymbolNormalStage=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/narrow.png",25,25),t},SymbolMorph.prototype.drawSymbolTurtle=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/addsprite.png",100,100),t},SymbolMorph.prototype.drawSymbolTurtleOutline=function(t,o){var e=t.getContext("2d");return e.strokeStyle=o.toString(),e.beginPath(),e.moveTo(0,0),e.lineTo(t.width,t.height/2),e.lineTo(0,t.height),e.lineTo(t.height/2,t.height/2),e.closePath(),e.stroke(),t},SymbolMorph.prototype.drawSymbolPause=function(t,o){var e=t.getContext("2d"),r=t.width/5;return e.fillStyle=o.toString(),e.fillRect(0,0,2*r,t.height),e.fillRect(3*r,0,2*r,t.height),t},SymbolMorph.prototype.drawSymbolFlag=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("http://7xpmmk.com2.z0.glb.qiniucdn.com/start.png",100,35),t},SymbolMorph.prototype.drawSymbolOctagon=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("http://7xpmmk.com2.z0.glb.qiniucdn.com/stop.png",100,35),t},SymbolMorph.prototype.drawSymbolOpenProject=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/file.png",30,30),t},SymbolMorph.prototype.drawSymbolCloudfile=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=2*i/5,h=i/4,s=3*i/10,a=i/5;return e.fillStyle=o.toString(),e.beginPath(),e.arc(h,i-h,h,radians(90),radians(259),!1),e.arc(r/20*5,i/9*4,a,radians(165),radians(300),!1),e.arc(r/20*11,n,n,radians(200),radians(357),!1),e.arc(r-s,i-s,s,radians(269),radians(90),!1),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolCloud=function(t,o){return this.isTextureRepeat=!1,null==user.headimgurl?this.drawTexture("icon/login.png",35,35):this.drawTexture(user.headimgurl,45,45),t},SymbolMorph.prototype.drawSymbolCloudGradient=function(t,o){var e,r=t.getContext("2d"),i=t.width,n=t.height,h=2*n/5,s=n/4,a=3*n/10,l=n/5;return e=r.createRadialGradient(0,0,0,0,0,i),e.addColorStop(0,o.lighter(25).toString()),e.addColorStop(1,o.darker(25).toString()),r.fillStyle=e,r.beginPath(),r.arc(s,n-s,s,radians(90),radians(259),!1),r.arc(i/20*5,n/9*4,l,radians(165),radians(300),!1),r.arc(i/20*11,h,h,radians(200),radians(357),!1),r.arc(i-a,n-a,a,radians(269),radians(90),!1),r.closePath(),r.fill(),t},SymbolMorph.prototype.drawSymbolCloudOutline=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=2*i/5,h=i/4,s=3*i/10,a=i/5;return e.strokeStyle=o.toString(),e.beginPath(),e.arc(h+1,i-h-1,h,radians(90),radians(259),!1),e.arc(r/20*5,i/9*4,a,radians(165),radians(300),!1),e.arc(r/20*11,n+1,n,radians(200),radians(357),!1),e.arc(r-s-1,i-s-1,s,radians(269),radians(90),!1),e.closePath(),e.stroke(),t},SymbolMorph.prototype.drawSymbolTurnRight=function(t,o){var e=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),n=r/2;return e.lineWidth=i,e.strokeStyle=o.toString(),e.beginPath(),e.arc(n,2*n,n-i/2,radians(0),radians(-90),!1),e.stroke(),e.fillStyle=o.toString(),e.beginPath(),e.moveTo(r,n),e.lineTo(n,0),e.lineTo(n,2*n),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolTurnLeft=function(t,o){var e=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),n=r/2;return e.lineWidth=i,e.strokeStyle=o.toString(),e.beginPath(),e.arc(n,2*n,n-i/2,radians(180),radians(-90),!0),e.stroke(),e.fillStyle=o.toString(),e.beginPath(),e.moveTo(0,n),e.lineTo(n,0),e.lineTo(n,2*n),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolStorage=function(t,o){function e(t,e){r.fillStyle=o.toString(),r.beginPath(),r.arc(i/2,t-n,h,radians(60),radians(120),!1),r.lineTo(0,t-2*s),r.arc(i/2,t-n-2*s,h,radians(120),radians(60),!0),r.closePath(),r.fill(),r.fillStyle=o.darker(25).toString(),r.beginPath(),e&&r.arc(i/2,t-n-2*s,h,radians(120),radians(60),!0),r.arc(i/2,t+6*s+1,h,radians(60),radians(120),!0),r.closePath(),e?r.fill():r.stroke()}var r=t.getContext("2d"),i=t.width,n=t.height,h=t.height,s=t.height/11;return r.strokeStyle=o.toString(),e(n),e(n-3*s),e(n-6*s,!1),t},SymbolMorph.prototype.drawSymbolPoster=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=.75*i,h=t.height/5;return e.fillStyle=o.toString(),e.strokeStyle=o.toString(),e.lineWidth=r/15,e.moveTo(r/2,i/3),e.lineTo(r/6,i),e.stroke(),e.moveTo(r/2,i/3),e.lineTo(r/2,i),e.stroke(),e.moveTo(r/2,i/3),e.lineTo(5*r/6,i),e.stroke(),e.fillRect(0,0,r,n),e.clearRect(0,n,r,r/20),e.clearRect(r-h,n-h,h+1,h+1),e.fillStyle=o.darker(25).toString(),e.beginPath(),e.moveTo(r,n-h),e.lineTo(r-h,n-h),e.lineTo(r-h,n),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolFlash=function(t,o){var e=t.getContext("2d"),r=t.width,i=r/3,n=t.height,h=n/3,s=h/3;return e.fillStyle=o.toString(),e.beginPath(),e.moveTo(i,0),e.lineTo(0,h),e.lineTo(i,h),e.lineTo(0,2*h),e.lineTo(i,2*h),e.lineTo(0,n),e.lineTo(r,2*h-s),e.lineTo(2*i,2*h-s),e.lineTo(r,h-s),e.lineTo(2*i,h-s),e.lineTo(r,0),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolBrush=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/draw.png",30,30),t},SymbolMorph.prototype.drawSymbolPencil=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/pencil.png",25,25),t},SymbolMorph.prototype.drawSymbolRectangle=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/rectangle.png",25,25),t},SymbolMorph.prototype.drawSymbolRectangleSolid=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.width;return e.fillStyle=o.toString(),e.beginPath(),e.moveTo(0,0),e.lineTo(r,0),e.lineTo(r,i),e.lineTo(0,i),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolCircle=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/circle.png",22,22),t},SymbolMorph.prototype.drawSymbolCircleSolid=function(t,o){var e=t.getContext("2d"),r=t.width;return e.fillStyle=o.toString(),e.arc(r/2,r/2,r/2,radians(0),radians(360),!1),e.fill(),t},SymbolMorph.prototype.drawSymbolLibrary=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/addbackground.png",30,30),t},SymbolMorph.prototype.drawSymbolLine=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/line.png",25,25),t},SymbolMorph.prototype.drawSymbolModify=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/modify.png",30,30),t},SymbolMorph.prototype.drawSymbolInputText=function(t,o){var e=t.getContext("2d");return e.font=t.height+"px Times",e.fillStyle="white",e.fillText("T",6,t.height-5),t},SymbolMorph.prototype.drawSymbolCrosshairs=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=.5;return e.strokeStyle=o.toString(),e.lineWidth=2*n,e.moveTo(n,i/2),e.lineTo(r-n,i/2),e.stroke(),e.moveTo(r/2,n),e.lineTo(r/2,i-n),e.stroke(),e.moveTo(r/2,i/2),e.arc(r/2,r/2,r/3-n,radians(0),radians(360),!1),e.stroke(),t},SymbolMorph.prototype.drawSymbolDeleteIcon=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/deleteIcon.png",30,30),t},SymbolMorph.prototype.drawSymbolPaintbucket=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/5,h=Math.max(r/30,.5);return e.strokeStyle=o.toString(),e.lineWidth=2*h,e.beginPath(),e.moveTo(2*n,n),e.lineTo(4*n,3*n),e.lineTo(3*n,4*n),e.quadraticCurveTo(2*n,i,n,4*n),e.quadraticCurveTo(0,3*n,n,2*n),e.closePath(),e.stroke(),e.lineWidth=h,e.moveTo(2*n,2.5*n),e.arc(2*n,2.5*n,h,radians(0),radians(360),!1),e.stroke(),e.moveTo(2*n,2.5*n),e.lineTo(2*n,n/2+h),e.stroke(),e.arc(1.5*n,n/2+h,n/2,radians(0),radians(180),!0),e.stroke(),e.moveTo(n,n/2+h),e.lineTo(n,2*n),e.stroke(),e.fillStyle=o.toString(),e.beginPath(),e.moveTo(3.5*n,3.5*n),e.quadraticCurveTo(r,3.5*n,r-h,i),e.lineTo(r,i),e.quadraticCurveTo(r,2*n,2.5*n,1.5*n),e.lineTo(4*n,3*n),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolEraser=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/eraser.png",25,25),t},SymbolMorph.prototype.drawSymbolPipette=function(t,o){return this.isTextureRepeat=!1,this.drawTexture("icon/pipette.png",25,25),t},SymbolMorph.prototype.drawSymbolSpeechBubble=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/3,h=Math.max(r/20,.5);return e.fillStyle=o.toString(),e.lineWidth=2*h,e.beginPath(),e.moveTo(n,2*n),e.quadraticCurveTo(h,2*n,h,n),e.quadraticCurveTo(h,h,n,h),e.lineTo(2*n,h),e.quadraticCurveTo(r-h,h,r-h,n),e.quadraticCurveTo(r-h,2*n,2*n,2*n),e.lineTo(n/2,i-h),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/3,h=Math.max(r/20,.5);return e.strokeStyle=o.toString(),e.lineWidth=2*h,e.beginPath(),e.moveTo(n,2*n),e.quadraticCurveTo(h,2*n,h,n),e.quadraticCurveTo(h,h,n,h),e.lineTo(2*n,h),e.quadraticCurveTo(r-h,h,r-h,n),e.quadraticCurveTo(r-h,2*n,2*n,2*n),e.lineTo(n/2,i-h),e.closePath(),e.stroke(),t},SymbolMorph.prototype.drawSymbolArrowUp=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/2,h=Math.max(r/20,.5);return e.fillStyle=o.toString(),e.lineWidth=2*h,e.beginPath(),e.moveTo(h,n),e.lineTo(n,h),e.lineTo(r-h,n),e.lineTo(.65*r,n),e.lineTo(.65*r,i-h),e.lineTo(.35*r,i-h),e.lineTo(.35*r,n),e.closePath(),e.fill(),t},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/2,h=Math.max(r/20,.5);return e.strokeStyle=o.toString(),e.lineWidth=2*h,e.beginPath(),e.moveTo(h,n),e.lineTo(n,h),e.lineTo(r-h,n),e.lineTo(.65*r,n),e.lineTo(.65*r,i-h),e.lineTo(.35*r,i-h),e.lineTo(.35*r,n),e.closePath(),e.stroke(),t},SymbolMorph.prototype.drawSymbolArrowDown=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(r,r),e.rotate(radians(180)),this.drawSymbolArrowUp(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolArrowDownOutline=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(r,r),e.rotate(radians(180)),this.drawSymbolArrowUpOutline(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeft=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(0,r),e.rotate(radians(-90)),this.drawSymbolArrowUp(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(0,r),e.rotate(radians(-90)),this.drawSymbolArrowUpOutline(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolArrowRight=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(r,0),e.rotate(radians(90)),this.drawSymbolArrowUp(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(t,o){var e=t.getContext("2d"),r=t.width;return e.save(),e.translate(r,0),e.rotate(radians(90)),this.drawSymbolArrowUpOutline(t,o),e.restore(),t},SymbolMorph.prototype.drawSymbolRobot=function(t,o){var e=t.getContext("2d"),r=t.width,i=t.height,n=t.width/6,h=n/2,s=Math.max(r/20,.5);return e.fillStyle=o.toString(),e.beginPath(),e.moveTo(n+s,n),e.lineTo(2*n,n),e.lineTo(2.5*n,1.5*n),e.lineTo(3.5*n,1.5*n),e.lineTo(4*n,n),e.lineTo(5*n-s,n),e.lineTo(4*n,3*n),e.lineTo(4*n,4*n-s),e.lineTo(2*n,4*n-s),e.lineTo(2*n,3*n),e.closePath(),e.fill(),e.beginPath(),e.moveTo(2.75*n,n+s),e.lineTo(2.4*n,n),e.lineTo(2.2*n,0),e.lineTo(3.8*n,0),e.lineTo(3.6*n,n),e.lineTo(3.25*n,n+s),e.closePath(),e.fill(),e.beginPath(),e.moveTo(2.5*n,4*n),e.lineTo(n,4*n),e.lineTo(h+s,i),e.lineTo(2*n,i),e.closePath(),e.fill(),e.beginPath(),e.moveTo(3.5*n,4*n),e.lineTo(5*n,4*n),e.lineTo(r-(h+s),i),e.lineTo(4*n,i),e.closePath(),e.fill(),e.beginPath(),e.moveTo(n,n),e.lineTo(s,1.5*n),e.lineTo(s,3.25*n),e.lineTo(1.5*n,3.5*n),e.closePath(),e.fill(),e.beginPath(),e.moveTo(5*n,n),e.lineTo(r-s,1.5*n),e.lineTo(r-s,3.25*n),e.lineTo(4.5*n,3.5*n),e.closePath(),e.fill(),t},ColorSlotMorph.prototype=new ArgMorph,ColorSlotMorph.prototype.constructor=ColorSlotMorph,ColorSlotMorph.uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(t){ColorSlotMorph.uber.init.call(this),this.setColor(t||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var t=this,o=this.world(),e=o.hand,r=getDocumentPositionOf(o.worldCanvas),i=e.processMouseMove,n=e.processMouseDown,h=e.processMouseUp,s=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));o.add(s),s.setPosition(this.bottomLeft().add(new Point(0,this.edge))),e.processMouseMove=function(i){e.setPosition(new Point(i.pageX-r.x,i.pageY-r.y)),t.setColor(o.getGlobalPixelColor(e.position()))},e.processMouseDown=nop,e.processMouseUp=function(){s.destroy(),e.processMouseMove=i,e.processMouseDown=n,e.processMouseUp=h}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var t,o,e;e=this.fontSize+2*this.edge+2*this.typeInPadding,this.silentSetExtent(new Point(e,e)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),o=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=o.toString(),this.cachedClrBright=o.lighter(this.contrast).toString(),this.cachedClrDark=o.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,BlockHighlightMorph.prototype=new Morph,BlockHighlightMorph.prototype.constructor=BlockHighlightMorph,BlockHighlightMorph.uber=Morph.prototype,MultiArgMorph.prototype=new ArgMorph,MultiArgMorph.prototype.constructor=MultiArgMorph,MultiArgMorph.uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(t,o,e,r,i,n,h,s,a){var l,p,c,d,u=new FrameMorph;for(this.slotSpec=t||"%s",this.labelText=localize(o||""),this.minInputs=e||0,this.elementSpec=r||null,this.labelColor=n||null,this.shadowColor=h||null,this.shadowOffset=s||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this),this.alpha=a===!1?1:0,u.alpha=a===!1?1:0,u.noticesTransparentClick=!0,this.noticesTransparentclick=!0,l=this.labelPart(this.labelText),this.add(l),l.hide(),p=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),c=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),u.add(p),u.add(c),u.drawNew(),u.acceptsDrops=!1,this.add(u),d=0;d<this.minInputs;d+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.children[0]},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec},MultiArgMorph.prototype.setContents=function(t){var o,e=this.inputs();for(o=0;o<t.length;o+=1)null!==t[o]&&e[o]&&e[o].setContents(t[o])},MultiArgMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(t,o,e){this.textColor=t,this.shadowColor=o,this.shadowOffset=e,MultiArgMorph.uber.setLabelColor.call(this,t,o,e)},MultiArgMorph.prototype.fixLayout=function(){if("%t"===this.slotSpec&&(this.isStatic=!0),this.parent){var t,o,e=this.label();this.color=this.parent.color,t=this.shadowColor||this.parent.color.darker(this.labelContrast),o=this.shadowOffset||e.shadowOffset,this.arrows().color=this.color,""!==this.labelText&&(e.shadowColor.eq(t)||(e.shadowColor=t,e.shadowOffset=o,e.drawNew()))}this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var t=this.label(),o=this.arrows(),e=o.children[0],r=o.children[1],i=new Point(r.width()/2,r.height());this.inputs().length<this.minInputs+1?(t.hide(),e.hide(),r.setPosition(o.position().subtract(new Point(i.x,0))),o.setExtent(i)):(""!==this.labelText&&t.show(),e.show(),r.setPosition(e.topCenter()),o.bounds.corner=r.bottomRight().copy()),o.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(t){var o,e,r=this.labelPart(this.slotSpec),i=this.children.length-1;if(t)r.setContents(t);else if("%scriptVars"===this.elementSpec){for(e="",o=i;o>0;)e=String.fromCharCode(97+(o-1)%26)+e,o=Math.floor((o-1)/26);r.setContents(e)}else contains(["%parms","%ringparms"],this.elementSpec)&&r.setContents("#"+i);r.parent=this,this.children.splice(i,0,r),r.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var t,o;this.children.length>1&&(t=this.children[this.children.length-2],this.removeChild(t),t instanceof BlockMorph&&(o=this.parentThatIsA(ScriptsMorph),o&&o.add(t))),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(t){var o,e=this.arrows(),r=e.children[0],i=e.children[1],n=16===this.world().currentKey?3:1;if(this.startLayout(),i.bounds.containsPoint(t))for(o=0;n>o;o+=1)i.isVisible&&this.addInput();else if(r.bounds.containsPoint(t))for(o=0;n>o;o+=1)r.isVisible&&this.removeInput();else this.escalateEvent("mouseClickLeft",t);this.endLayout()},MultiArgMorph.prototype.userMenu=function(){var t=new MenuMorph(this),o=this.parentThatIsA(BlockMorph),e="",r=this;return StageMorph.prototype.enableCodeMapping?(o&&(o instanceof RingMorph?e="parms_":"doDeclareVariables"===o.selector&&(e="tempvars_")),t.addItem("code list mapping...",function(){r.mapCodeList(e)}),t.addItem("code item mapping...",function(){r.mapCodeItem(e)}),t.addItem("code delimiter mapping...",function(){r.mapCodeDelimiter(e)}),t):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(t,o){new DialogBoxMorph(this,function(o){StageMorph.prototype.codeMappings[t]=o},this).promptCode("Code mapping - "+o,StageMorph.prototype.codeMappings[t]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(t){var o,e,r,i=this.parentThatIsA(BlockMorph),n="",h="",s=0,a=[];return i&&(i instanceof RingMorph?n="parms_":"doDeclareVariables"===i.selector&&(n="tempvars_")),o=StageMorph.prototype.codeMappings[n+"list"]||"<#1>",e=StageMorph.prototype.codeMappings[n+"item"]||"<#1>",r=StageMorph.prototype.codeMappings[n+"delim"]||" ",this.inputs().forEach(function(o){a.push(e.replace(/<#1>/g,o.mappedCode(t)))}),a.forEach(function(t){s&&(h+=r),h+=t,s+=1}),o=o.replace(/<#1>/g,h)},MultiArgMorph.prototype.evaluate=function(){var t=[];return this.inputs().forEach(function(o){t.push(o.evaluate())}),t},MultiArgMorph.prototype.isEmptySlot=function(){return this.canBeEmpty?0===this.inputs().length:!1},ArgLabelMorph.prototype=new ArgMorph,ArgLabelMorph.prototype.constructor=ArgLabelMorph,ArgLabelMorph.uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(t,o){var e;this.labelText=localize(o||"input list:"),ArgLabelMorph.uber.init.call(this),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,e=this.labelPart(this.labelText),this.add(e),this.add(t)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var t,o,e=this.label();this.parent&&(this.color=this.parent.color,o=e.shadowOffset||new Point,t=o.x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(e.shadowColor.eq(t)||(e.shadowColor=t,e.shadowOffset=o,e.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(t,o,e){
if(""!==this.labelText){var r=this.label();r.color=t,r.shadowColor=o,r.shadowOffset=e,r.drawNew()}},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){return!1},FunctionSlotMorph.prototype=new ArgMorph,FunctionSlotMorph.prototype.constructor=FunctionSlotMorph,FunctionSlotMorph.uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(t){FunctionSlotMorph.uber.init.call(this),this.isPredicate=t||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge))},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var t,o;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),o=this.parent?this.parent.color:new Color(120,120,120),this.cachedClr=o.toString(),this.cachedClrBright=o.lighter(this.contrast).toString(),this.cachedClrDark=o.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},FunctionSlotMorph.prototype.drawRounded=function(t){var o,e=this.height(),r=Math.min(this.rounding,e/2),i=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.arc(i-r,e-r,r,radians(0),radians(90),!1),t.arc(r,e-r,r,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,e-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),o=t.createRadialGradient(r,r,r-this.edge,r,r,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),o=t.createLinearGradient(0,0,this.edge,0),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,r),t.lineTo(n,e-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,o=t.createRadialGradient(i-r,e-r,r-this.edge,i-r,e-r,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.arc(i-r,e-r,r-n,radians(0),radians(90),!1),t.stroke(),o=t.createLinearGradient(0,e-this.edge,0,e),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,e-n),t.lineTo(i-r+n,e-n),t.stroke(),o=t.createLinearGradient(i-this.edge,0,i,0),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,e-r),t.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(t){var o,e=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),h=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,i),t.lineTo(n,0),t.lineTo(e-n,0),t.lineTo(e,i),t.lineTo(e-n,r),t.lineTo(n,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(h,i),t.lineTo(n,r-h),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(e-h,i),t.lineTo(e-n,h),t.stroke(),t.shadowOffsetX=h,t.shadowOffsetY=h,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),o=t.createLinearGradient(0,0,n,0),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(h,i),t.lineTo(n,h),t.stroke(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,h),t.lineTo(e-n,h),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,o=t.createLinearGradient(e-n,0,e,0),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(e-n,r-h),t.lineTo(e-h,i),t.stroke(),o=t.createLinearGradient(0,r-this.edge,0,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n+h,r-h),t.lineTo(e-n-h,r-h),t.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,ReporterSlotMorph.prototype.constructor=ReporterSlotMorph,ReporterSlotMorph.uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(t){ReporterSlotMorph.uber.init.call(this,t),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var t=new ArgMorph,o=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.setExtent(new Point(2*(this.fontSize+2*this.edge)-o,this.fontSize+2*this.edge-o)),t},ReporterSlotMorph.prototype.getSpec=function(){return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var t=this.contents();return t instanceof ReporterBlockMorph?t:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var t=this.contents();this.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph,RingReporterSlotMorph.uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.init=function(t){RingReporterSlotMorph.uber.init.call(this,t),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(t,o){RingReporterSlotMorph.uber.replaceInput.call(this,t,o),this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.drawRounded=function(t){var o,e=this.height(),r=Math.min(this.rounding,e/2),i=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,e/2),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.lineTo(i,e/2),t.lineTo(i,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(i,e/2),t.arc(i-r,e-r,r,radians(0),radians(90),!1),t.arc(r,e-r,r,radians(90),radians(180),!1),t.lineTo(0,e/2),t.lineTo(0,e),t.lineTo(i,e),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,e-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),o=t.createRadialGradient(r,r,r-this.edge,r,r,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),o=t.createLinearGradient(0,0,this.edge,0),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,r),t.lineTo(n,e-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,o=t.createRadialGradient(i-r,e-r,r-this.edge,i-r,e-r,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.arc(i-r,e-r,r-n,radians(0),radians(90),!1),t.stroke(),o=t.createLinearGradient(0,e-this.edge,0,e),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,e-n),t.lineTo(i-r+n,e-n),t.stroke(),o=t.createLinearGradient(i-this.edge,0,i,0),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,e-r),t.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(t){var o,e=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),h=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(0,i),t.lineTo(n,0),t.lineTo(e-n,0),t.lineTo(e,i),t.lineTo(e,0),t.closePath(),t.fill(),t.moveTo(e,i),t.lineTo(e-n,r),t.lineTo(n,r),t.lineTo(0,i),t.lineTo(0,r),t.lineTo(e,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(h,i),t.lineTo(n,r-h),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(e-h,i),t.lineTo(e-n,h),t.stroke(),t.shadowOffsetX=h,t.shadowOffsetY=h,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),o=t.createLinearGradient(0,0,n,0),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(h,i),t.lineTo(n,h),t.stroke(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,h),t.lineTo(e-n,h),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,o=t.createLinearGradient(e-n,0,e,0),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(e-n,r-h),t.lineTo(e-h,i),t.stroke(),o=t.createLinearGradient(0,r-this.edge,0,r),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n+h,r-h),t.lineTo(e-n-h,r-h),t.stroke())},CommentMorph.prototype=new BoxMorph,CommentMorph.prototype.constructor=CommentMorph,CommentMorph.uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(t){var o=this,e=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*e,new Color(255,255,180)),this.titleBar.color=new Color(249,191,48),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){o.toggleExpand()},this.contents=new TextMorph(t||localize("在这里添加注释..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*e,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new Point(11*e,11*e)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*e,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.fullCopy=function(){var t=new CommentMorph(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),t},CommentMorph.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var t,o=this.contents.width()+2*this.padding,e=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,t=new StringMorph(this.contents.text,this.fontSize,null,!0),t.rootForGrab=function(){return e},this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(o-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(o),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=r,this.changed(),this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var t=new MenuMorph(this),o=this;return t.addItem("duplicate",function(){o.fullCopy().pickUp(o.world())},"创建一个副本并抓起"),t.addItem("删除","destroy"),t.addItem("comment pic...",function(){window.open(o.fullImage().toDataURL())},"open a new window\nwith a picture of this comment"),t},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.snap=function(t){var o,e=this.parent;return!e instanceof ScriptsMorph?null:(e.clearDropHistory(),e.lastDroppedBlock=this,o=e.closestBlock(this,t),null!==o&&(o.comment=this,this.block=o),void this.align())},CommentMorph.prototype.align=function(t,o){if(this.block){var e,r,i,n,h=t||this.block.topBlock(),s=h.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner),r=this.top(),i=this.bottom(),e=h.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>r&&t.top()<i}),n=Math.max.apply(null,e.map(function(t){return t.right()})),this.setLeft(n+5),!o&&s&&s.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed()}},CommentMorph.prototype.startFollowing=function(t,o){this.align(t),o.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){this.setPosition(this.block.position().add(this.stickyOffset))}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()};