function CustomBlockDefinition(t,o){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=t||"",this.declarations={},this.comment=null,this.codeMapping=null,this.codeHeader=null,this.receiver=o||null}function CustomCommandBlockMorph(t,o){this.init(t,o)}function CustomReporterBlockMorph(t,o,e){this.init(t,o,e)}function JaggedBlockMorph(t){this.init(t)}function BlockDialogMorph(t,o,e){this.init(t,o,e)}function BlockEditorMorph(t,o){this.init(t,o)}function PrototypeHatBlockMorph(t){this.init(t)}function BlockLabelFragment(t){this.labelString=t||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function BlockLabelFragmentMorph(t){this.init(t)}function BlockLabelPlaceHolderMorph(){this.init()}function BlockInputFragmentMorph(t){this.init(t)}function InputSlotDialogMorph(t,o,e,i,n){this.init(t,o,e,i,n)}function VariableDialogMorph(t,o,e){this.init(t,o,e)}function BlockExportDialogMorph(t,o){this.init(t,o)}function BlockImportDialogMorph(t,o,e){this.init(t,o,e)}modules.byob="2015-May-23";var CustomBlockDefinition,CustomCommandBlockMorph,CustomReporterBlockMorph,BlockDialogMorph,BlockEditorMorph,PrototypeHatBlockMorph,BlockLabelFragment,BlockLabelFragmentMorph,BlockInputFragmentMorph,BlockLabelPlaceHolderMorph,InputSlotDialogMorph,VariableDialogMorph,JaggedBlockMorph,BlockExportDialogMorph,BlockImportDialogMorph;CustomBlockDefinition.prototype.blockInstance=function(){var t;return t="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type),t.isDraggable=!0,t},CustomBlockDefinition.prototype.templateInstance=function(){var t;return t=this.blockInstance(),t.refreshDefaults(),t.isDraggable=!1,t.isTemplate=!0,t},CustomBlockDefinition.prototype.prototypeInstance=function(){var t,o,e=this;return t="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0),t.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(o=e.declarations[t.fragment.labelString],o&&(t.fragment.type=o[0],t.fragment.defaultValue=o[1],t.fragment.options=o[2],t.fragment.isReadOnly=o[3]||!1))}),t},CustomBlockDefinition.prototype.copyAndBindTo=function(t){var o=copy(this);return o.receiver=t,o.declarations=copy(this.declarations),o.body&&(o.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),o.body.outerContext=null),o},CustomBlockDefinition.prototype.blockSpec=function(){var t,o=this,e=[],i=this.parseSpec(this.spec);return i.forEach(function(i){t="%"===i[0]&&i.length>1?o.typeOf(i.slice(1)):i,e.push(t),e.push(" ")}),"".concat.apply("",e).trim()},CustomBlockDefinition.prototype.helpSpec=function(){var t=[],o=this.parseSpec(this.spec);return o.forEach(function(o){"%"!==o[0]&&t.push(o)}),"".concat.apply("",t).replace(/\?/g,"")},CustomBlockDefinition.prototype.typeOf=function(t){return this.declarations[t]?this.declarations[t][0]:"%s"},CustomBlockDefinition.prototype.defaultValueOf=function(t){return this.declarations[t]?this.declarations[t][1]:""},CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(t){var o=this.inputNames()[t];return this.defaultValueOf(o)},CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(t){var o=this.inputNames()[t];return this.dropDownMenuOf(o)},CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(t){var o=this.inputNames()[t];return this.isReadOnlyInput(o)},CustomBlockDefinition.prototype.inputOptionsOfIdx=function(t){var o=this.inputNames()[t];return this.inputOptionsOf(o)},CustomBlockDefinition.prototype.dropDownMenuOf=function(t){var o={};return this.declarations[t]&&this.declarations[t][2]?(this.declarations[t][2].split("\n").forEach(function(t){var e=t.split("=");o[e[0]]=isNil(e[1])?e[0]:e[1]}),o):null},CustomBlockDefinition.prototype.isReadOnlyInput=function(t){return this.declarations[t]&&this.declarations[t][3]===!0},CustomBlockDefinition.prototype.inputOptionsOf=function(t){return[this.dropDownMenuOf(t),this.isReadOnlyInput(t)]},CustomBlockDefinition.prototype.inputNames=function(){var t=[],o=this.parseSpec(this.spec);return o.forEach(function(o){"%"===o[0]&&o.length>1&&t.push(o.slice(1))}),t},CustomBlockDefinition.prototype.parseSpec=function(t){var o,e,i=[],n="",r=!1;for(o=0;o<t.length;o+=1)e=t[o],"'"===e?r=!r:" "!==e||r?n=n.concat(e):(i.push(n),n="");return i.push(n),i},CustomBlockDefinition.prototype.scriptsPicture=function(){var t,o,e,i;return t=new ScriptsMorph,t.cleanUpMargin=10,o=new PrototypeHatBlockMorph(this),o.setPosition(t.position().add(10)),null!==this.comment&&(i=this.comment.fullCopy(),o.comment=i,i.block=o),null!==this.body&&o.nextBlock(this.body.expression.fullCopy()),t.add(o),o.fixBlockColor(null,!0),this.scripts.forEach(function(o){e=o.fullCopy(),e.setPosition(t.position().add(o.position())),t.add(e),e instanceof BlockMorph&&e.allComments().forEach(function(t){t.align(e)})}),o.allComments().forEach(function(t){t.align(o)}),o.children[0].fixLayout(),t.fixMultiArgs(),t.scriptsPicture()},CustomCommandBlockMorph.prototype=new CommandBlockMorph,CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph,CustomCommandBlockMorph.uber=CommandBlockMorph.prototype,CustomCommandBlockMorph.prototype.init=function(t,o){this.definition=t,this.isPrototype=o||!1,CustomCommandBlockMorph.uber.init.call(this),this.category=t.category,this.selector="evaluateCustomBlock",t&&this.refresh()},CustomCommandBlockMorph.prototype.refresh=function(){var t,o=this.definition,e=this.isPrototype?o.spec:o.blockSpec();this.setCategory(o.category),this.blockSpec!==e?(t=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(e),this.fixLabelColor(),this.restoreInputs(t)):this.inputs().forEach(function(t,e){t instanceof InputSlotMorph&&t.setChoices.apply(t,o.inputOptionsOfIdx(e))}),this.cachedInputs=null,this.inputs().forEach(function(t,e){t instanceof TemplateSlotMorph&&"↑"===t.contents()&&t.setContents(o.inputNames()[e])})},CustomCommandBlockMorph.prototype.restoreInputs=function(t){var o,e=0,i=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(n){o=t[e],o instanceof ReporterBlockMorph&&!(n instanceof TemplateSlotMorph)?i.silentReplaceInput(n,o):o instanceof InputSlotMorph&&n instanceof InputSlotMorph?n.setContents(o.evaluate()):o instanceof TemplateSlotMorph&&n instanceof TemplateSlotMorph?n.setContents(o.evaluate()):o instanceof CSlotMorph&&n instanceof CSlotMorph&&n.nestedBlock(o.evaluate()),e+=1}),this.cachedInputs=null)},CustomCommandBlockMorph.prototype.refreshDefaults=function(){var t=this.inputs(),o=0,e=this;t.forEach(function(t){t instanceof InputSlotMorph&&t.setContents(e.definition.defaultValueOfInputIdx(o)),o+=1}),this.cachedInputs=null},CustomCommandBlockMorph.prototype.refreshPrototype=function(){var t,o,e,i,n=[],r=this,s=0;return this.isPrototype?(t=this.parentThatIsA(PrototypeHatBlockMorph),this.parts().forEach(function(t){t.fragment.isDeleted||(t.fragment.type?n.push(t.fragment):(e=r.definition.parseSpec(t.fragment.labelString),e.forEach(function(o){i=t.fragment.copy(),i.labelString=o,n.push(i)})))}),o=this.specFromFragments(),this instanceof CustomCommandBlockMorph&&("reporter"===t.type||"predicate"===t.type)?(r=new CustomReporterBlockMorph(this.definition,"predicate"===t.type,!0),t.silentReplaceInput(this,r)):this instanceof CustomReporterBlockMorph&&("command"===t.type?(r=new CustomCommandBlockMorph(this.definition,!0),t.silentReplaceInput(this,r)):(this.isPredicate="predicate"===t.type,this.drawNew())),r.setCategory(t.blockCategory||"other"),t.fixBlockColor(),r.setSpec(o),r.parts().forEach(function(t){t instanceof BlockLabelPlaceHolderMorph||(n[s]&&(t.fragment=n[s]),s+=1)}),this.refreshPrototypeSlotTypes(),void t.fixLayout()):null},CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(t.template().instantiationSpec=t.contents(),t.setContents(t.fragment.defTemplateSpecFragment()))}),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var t=[];return this.parts().forEach(function(o){!o.fragment.isDeleted&&o.fragment.type&&t.push(o.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var t=[];return this.parts().forEach(function(o){o.fragment.isDeleted||"%upvar"!==o.fragment.type||t.push(o.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentName=function(t){return this.upvarFragmentNames()[t]||"↑"},CustomCommandBlockMorph.prototype.specFromFragments=function(){var t="";return this.parts().forEach(function(o){o.fragment.isDeleted||(t=t+o.fragment.defSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var t="";return this.parts().forEach(function(o){o.fragment.isDeleted||(t=t+o.fragment.blockSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var t={};return this.parts().forEach(function(o){o instanceof BlockInputFragmentMorph&&(t[o.fragment.labelString]=[o.fragment.type,o.fragment.defaultValue,o.fragment.options,o.fragment.isReadOnly])}),t},CustomCommandBlockMorph.prototype.parseSpec=function(t){return this.isPrototype?this.definition.parseSpec.call(this,t):CustomCommandBlockMorph.uber.parseSpec.call(this,t)},CustomCommandBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomCommandBlockMorph.uber.mouseClickLeft.call(this)},CustomCommandBlockMorph.prototype.edit=function(){var t,o,e=this;this.isPrototype?(t=this.definition.blockInstance(),t.addShadow(),o=this.parentThatIsA(PrototypeHatBlockMorph),new BlockDialogMorph(null,function(t){t&&(o.blockCategory=t.category,o.type=t.type,e.refreshPrototype())},e).openForChange("Change block",o.blockCategory,o.type,e.world(),t.fullImage(),e.isInUse())):new BlockEditorMorph(this.definition,this.receiver()).popUp()},CustomCommandBlockMorph.prototype.labelPart=function(t){var o;return this.isPrototype?("%"===t[0]&&t.length>1?o=new BlockInputFragmentMorph(t.replace(/%/g,"")):(o=new BlockLabelFragmentMorph(t),o.fontSize=this.fontSize,o.color=new Color(255,255,255),o.isBold=!0,o.shadowColor=this.color.darker(this.labelContrast),o.shadowOffset=this.embossing,o.drawNew()),o):CustomCommandBlockMorph.uber.labelPart.call(this,t)},CustomCommandBlockMorph.prototype.placeHolder=function(){var t;return t=new BlockLabelPlaceHolderMorph,t.fontSize=1.4*this.fontSize,t.color=new Color(45,45,45),t.drawNew(),t},CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)},CustomCommandBlockMorph.prototype.isInUse=function(){return this.receiver().usesBlockInstance(this.definition)},CustomCommandBlockMorph.prototype.userMenu=function(){var t;return this.isPrototype?(t=new MenuMorph(this),t.addItem("script pic...",function(){window.open(this.topBlock().fullImage().toDataURL())},"open a new window\nwith a picture of this script")):(t=this.constructor.uber.userMenu.call(this),t?t.addLine():t=new MenuMorph(this),t.addItem("delete block definition...","deleteBlockDefinition")),t.addItem("edit...","edit"),t},CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var t=(new SnapSerializer).serialize(this.definition);window.open("data:text/xml,"+encodeURIComponent(t))},CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var t,o,e,i,n,r=this;return this.isPrototype?null:(n=r.definition.blockInstance(),n.addShadow(),void new DialogBoxMorph(this,function(){o=r.receiver(),o.deleteAllBlockInstances(r.definition),r.definition.isGlobal?(e=o.parentThatIsA(StageMorph),t=e.globalBlocks.indexOf(r.definition),-1!==t&&e.globalBlocks.splice(t,1)):(t=o.customBlocks.indexOf(r.definition),-1!==t&&o.customBlocks.splice(t,1)),i=o.parentThatIsA(IDE_Morph),i&&(i.flushPaletteCache(),i.refreshPalette())},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),r.world(),n.fullImage()))},CustomCommandBlockMorph.prototype.mouseEnter=function(){var t,o;this.isTemplate&&this.definition.comment&&(t=this.definition.comment.fullCopy(),t.contents.parse(),o="",t.contents.lines.forEach(function(t){o=o+"\n"+t}),this.bubbleHelp(o.substr(1),this.definition.comment.color))},CustomCommandBlockMorph.prototype.mouseLeave=function(){this.isTemplate&&this.definition.comment&&this.world().hand.destroyTemporaries()},CustomCommandBlockMorph.prototype.bubbleHelp=function(t,o){var e=this;this.fps=2,this.step=function(){this.bounds.containsPoint(this.world().hand.position())&&e.popUpbubbleHelp(t,o),e.fps=0,delete e.step}},CustomCommandBlockMorph.prototype.popUpbubbleHelp=function(t,o){new SpeechBubbleMorph(t,o,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))},CustomCommandBlockMorph.prototype.relabel=function(t){var o=new MenuMorph(this),e=this.inputs().map(function(t){return t.fullCopy()}),i=this;t.forEach(function(t){var n=t.blockInstance();n.restoreInputs(e),n.fixBlockColor(null,!0),n.addShadow(new Point(3,3)),o.addItem(n,function(){i.definition=t,i.refresh()})}),o.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},CustomCommandBlockMorph.prototype.alternatives=function(){var t=this.receiver(),o=t.parentThatIsA(StageMorph),e=t.customBlocks.concat(o.globalBlocks),i=this;return e.filter(function(t){return t!==i.definition&&t.type===i.definition.type})},CustomReporterBlockMorph.prototype=new ReporterBlockMorph,CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph,CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype,CustomReporterBlockMorph.prototype.init=function(t,o,e){this.definition=t,this.isPrototype=e||!1,CustomReporterBlockMorph.uber.init.call(this,o),this.category=t.category,this.selector="evaluateCustomBlock",t&&this.refresh()},CustomReporterBlockMorph.prototype.refresh=function(){CustomCommandBlockMorph.prototype.refresh.call(this),this.isPrototype||(this.isPredicate="predicate"===this.definition.type),this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null),this.drawNew()},CustomReporterBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomReporterBlockMorph.uber.mouseClickLeft.call(this)},CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder,CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec,CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit,CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart,CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames,CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName,CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames,CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments,CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments,CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments,CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype,CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes,CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs,CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults,CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse,CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu,CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition,CustomReporterBlockMorph.prototype.mouseEnter=CustomCommandBlockMorph.prototype.mouseEnter,CustomReporterBlockMorph.prototype.mouseLeave=CustomCommandBlockMorph.prototype.mouseLeave,CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp,CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp,CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel,CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives,JaggedBlockMorph.prototype=new ReporterBlockMorph,JaggedBlockMorph.prototype.constructor=JaggedBlockMorph,JaggedBlockMorph.uber=ReporterBlockMorph.prototype,JaggedBlockMorph.prototype.jag=5,JaggedBlockMorph.prototype.init=function(t){JaggedBlockMorph.uber.init.call(this),t&&this.setSpec(t),"%cs"===t&&(this.minWidth=25,this.fixLayout())},JaggedBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawBackground(t),MorphicPreferences.isFlat||this.drawEdges(t),this.eraseHoles(t)},JaggedBlockMorph.prototype.drawBackground=function(t){var o,e,i=this.width(),n=this.height(),r=Math.round(n/this.jag),s=n/r;for(t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),e=0,o=0;r>o;o+=1)e+=s/2,t.lineTo(i-this.jag/2,e),e+=s/2,t.lineTo(i,e);for(t.lineTo(0,n),e=n,o=0;r>o;o+=1)e-=s/2,t.lineTo(this.jag/2,e),e-=s/2,t.lineTo(0,e);t.closePath(),t.fill()},JaggedBlockMorph.prototype.drawEdges=function(t){var o,e,i,n=this.width(),r=this.height(),s=Math.round(r/this.jag),p=r/s,l=this.edge/2;for(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(l,l),t.lineTo(n-l,l),t.stroke(),i=0,e=0;s>e;e+=1)t.strokeStyle=this.cachedClrDark,t.beginPath(),t.moveTo(n-l,i),i+=p/2,t.lineTo(n-this.jag/2-l,i),t.stroke(),i+=p/2;for(o=t.createLinearGradient(0,r-this.edge,0,r),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(n-l,r-l),t.lineTo(l,r-l),t.stroke(),i=r,e=0;s>e;e+=1)t.strokeStyle=this.cachedClrBright,t.beginPath(),t.moveTo(l,i),i-=p/2,t.lineTo(this.jag/2+l,i),t.stroke(),i-=p/2},BlockDialogMorph.prototype=new DialogBoxMorph,BlockDialogMorph.prototype.constructor=BlockDialogMorph,BlockDialogMorph.uber=DialogBoxMorph.prototype,BlockDialogMorph.prototype.init=function(t,o,e){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,BlockDialogMorph.uber.init.call(this,t,o,e),this.key="makeABlock",this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.scopes=new AlignmentMorph("row",this.padding),this.add(this.scopes),this.categories=new BoxMorph,this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.createScopeButtons(),this.fixLayout()},BlockDialogMorph.prototype.openForChange=function(t,o,e,i,n,r){var s=SpriteMorph.prototype.blockColor[o];this.key="changeABlock",this.category=o,this.blockType=e,this.categories.children.forEach(function(t){t.refresh()}),this.types.children.forEach(function(t){t.setColor(s),t.refresh()}),this.labelString=t,this.createLabel(),n&&this.setPicture(n),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),r&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.drawNew(),this.popUp(i)},BlockDialogMorph.prototype.createCategoryButtons=function(){var t=this,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,SpriteMorph.prototype.categories.forEach(function(o){t.addCategoryButton(o)}),Morph.prototype.trackChanges=o},BlockDialogMorph.prototype.addCategoryButton=function(t){var o,e=75,i=this,n=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[t]];return o=new ToggleButtonMorph(n,this,function(){i.category=t,i.categories.children.forEach(function(t){t.refresh()}),i.types&&i.types.children.forEach(function(t){t.setColor(n[2])}),i.edit()},t[0].toUpperCase().concat(t.slice(1)),function(){return i.category===t},null,null,null,e,!0),o.corner=8,o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=n[1],o.labelColor=IDE_Morph.prototype.buttonLabelColor,o.contrast=this.buttonContrast,o.fixLayout(),o.refresh(),this.categories.add(o),o},BlockDialogMorph.prototype.fixCategoriesLayout=function(){var t,o,e=this.categories.children[0].width(),i=this.categories.children[0].height(),n=15,r=2,s=10,p=Math.ceil(this.categories.children.length/2),l=this.categories.left(),h=this.categories.top(),a=0,c=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.categories.children.forEach(function(p){a+=1,t=Math.ceil(a/2),o=2-a%2,p.setPosition(new Point(l+(o*n+(o-1)*e),h+(t*r+(t-1)*i+s)))}),MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new Point(3*n+2*e,(p+1)*r+p*i+2*s)),Morph.prototype.trackChanges=c,this.categories.changed()},BlockDialogMorph.prototype.createTypeButtons=function(){var t,o=this,e=SpriteMorph.prototype.blockColor[this.category];t=new CommandBlockMorph,t.setColor(e),t.setSpec(localize("命令")),this.addBlockTypeButton(function(){o.setType("command")},t,function(){return"command"===o.blockType}),t=new ReporterBlockMorph,t.setColor(e),t.setSpec(localize("数值")),this.addBlockTypeButton(function(){o.setType("reporter")},t,function(){return"reporter"===o.blockType}),t=new ReporterBlockMorph(!0),t.setColor(e),t.setSpec(localize("判断")),this.addBlockTypeButton(function(){o.setType("predicate")},t,function(){return"predicate"===o.blockType})},BlockDialogMorph.prototype.addBlockTypeButton=function(t,o,e){var i=new ToggleElementMorph(this,t,o,e,null,null,"rebuild");return i.refresh(),this.types.add(i),i},BlockDialogMorph.prototype.addTypeButton=function(t,o,e){var i=new ToggleMorph("radiobutton",this,t,o,e);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.types.add(i),i},BlockDialogMorph.prototype.setType=function(t){this.blockType=t||this.blockType,this.types.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.createScopeButtons=function(){var t=this;this.addScopeButton(function(){t.setScope("gobal")},"对所有角色",function(){return t.isGlobal}),this.addScopeButton(function(){t.setScope("local")},"只对这个角色",function(){return!t.isGlobal})},BlockDialogMorph.prototype.addScopeButton=function(t,o,e){var i=new ToggleMorph("radiobutton",this,t,o,e);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.scopes.add(i),i},BlockDialogMorph.prototype.setScope=function(t){this.isGlobal="gobal"===t,this.scopes.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.getInput=function(){var t,o,e;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),o=new CustomBlockDefinition(t),o.type=this.blockType,o.category=this.category,o.isGlobal=this.isGlobal,("reporter"===o.type||"predicate"===o.type)&&(e=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0),e.outerContext=null,o.body=e),o},BlockDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(t+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockEditorMorph.prototype=new DialogBoxMorph,BlockEditorMorph.prototype.constructor=BlockEditorMorph,BlockEditorMorph.uber=DialogBoxMorph.prototype,BlockEditorMorph.prototype.init=function(t,o){var e,i,n,r,s,p=this;this.definition=t,this.handle=null,BlockEditorMorph.uber.init.call(this,o,function(){p.updateDefinition()},o),this.key="editBlock"+t.spec,this.labelString="Block Editor",this.createLabel(),e=new ScriptsMorph(o),e.isDraggable=!1,e.color=IDE_Morph.prototype.groupColor,e.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,e.cleanUpMargin=10,i=new PrototypeHatBlockMorph(this.definition),i.setPosition(e.position().add(10)),null!==t.comment&&(s=t.comment.fullCopy(),i.comment=s,s.block=i),null!==t.body&&i.nextBlock(t.body.expression.fullCopy()),e.add(i),i.fixBlockColor(null,!0),this.definition.scripts.forEach(function(t){r=t.fullCopy(),r.setPosition(e.position().add(t.position())),e.add(r),r instanceof BlockMorph&&r.allComments().forEach(function(t){t.align(r)})}),i.allComments().forEach(function(t){t.align(i)}),n=new ScrollFrameMorph(e),n.padding=10,n.growth=50,n.isDraggable=!1,n.acceptsDrops=!1,n.contents.acceptsDrops=!0,e.scrollFrame=n,this.addBody(n),this.addButton("ok","确认"),this.addButton("updateDefinition","应用"),this.addButton("cancel","取消"),this.setExtent(new Point(375,300)),this.fixLayout(),i.children[0].fixLayout(),e.fixMultiArgs()},BlockEditorMorph.prototype.popUp=function(){var t=this.target.world();t&&(BlockEditorMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,280,220,this.corner,this.corner))},BlockEditorMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.close()},BlockEditorMorph.prototype.cancel=function(){this.close()},BlockEditorMorph.prototype.close=function(){var t,o,e=this;return this.definition.isGlobal&&(o=detect(this.body.contents.allChildren(),function(t){return t.definition&&!t.definition.isGlobal}))?(o=o.definition.blockInstance(),o.addShadow(),void(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",e.world(),o.fullImage())):(t=this.target.doubleDefinitionsFor(this.definition),t.length>0?(o=t[0].blockInstance(),o.addShadow(),void new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","存在名字相同的程序块了哦，\n确定要将它替换掉吗？",e.world(),o.fullImage())):void this.destroy())},BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.destroy()},BlockEditorMorph.prototype.refreshAllBlockInstances=function(){var t=this.target.paletteBlockInstance(this.definition);this.target.allBlockInstances(this.definition).forEach(function(t){t.refresh()}),t&&t.refreshDefaults()},BlockEditorMorph.prototype.updateDefinition=function(){var t,o,e,i=this.body.contents.position(),n=this;this.definition.receiver=this.target,this.definition.spec=this.prototypeSpec(),this.definition.declarations=this.prototypeSlots(),this.definition.scripts=[],this.body.contents.children.forEach(function(o){o instanceof PrototypeHatBlockMorph?t=o:(o instanceof BlockMorph||o instanceof CommentMorph&&!o.block)&&(e=o.fullCopy(),e.parent=null,e.setPosition(o.position().subtract(i)),n.definition.scripts.push(e))}),t&&(this.definition.category=t.blockCategory,this.definition.type=t.type,t.comment?(this.definition.comment=t.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null),this.definition.body=this.context(t),this.refreshAllBlockInstances(),o=this.target.parentThatIsA(IDE_Morph),o.flushPaletteCache(),o.refreshPalette()},BlockEditorMorph.prototype.context=function(t){var o,e,i;return o=t||detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}),e=o.nextBlock(),null===e?null:(e.allChildren().forEach(function(t){t instanceof BlockMorph&&(t.cachedInputs=null)}),i=Process.prototype.reify.call(null,e,new List(this.definition.inputNames()),!0),i.outerContext=null,i)},BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()},BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()},BlockEditorMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},PrototypeHatBlockMorph.prototype=new HatBlockMorph,PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph,PrototypeHatBlockMorph.uber=HatBlockMorph.prototype,PrototypeHatBlockMorph.prototype.init=function(t){var o=t.prototypeInstance();this.definition=t,this.blockCategory=t?t.category:null,this.type=t?t.type:null,HatBlockMorph.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.control,this.category="control",this.add(o),o.refreshPrototypeSlotTypes(),this.fixLayout()},PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){this.children[0].mouseClickLeft()},PrototypeHatBlockMorph.prototype.userMenu=function(){return this.children[0].userMenu()},PrototypeHatBlockMorph.prototype.fixBlockColor=function(t,o){
var e=this.children[0]||t;if(this.zebraContrast||o){if(!this.zebraContrast&&o)return this.forceNormalColoring();e.category===this.category?e.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor(),o&&this.fixChildrensBlockColor(!0)}},BlockLabelFragment.prototype.defSpecFragment=function(){var t=this.type?"%'":"";return this.isDeleted?"":t+this.labelString+(this.type?"'":"")},BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var t="";return this.type?(this.isUpvar()?t=" ↑":this.isMultipleInput()?t="...":"%cs"===this.type?t=" λ":"%b"===this.type?t=" ?":"%l"===this.type?t=" ︙":"%obj"===this.type?t=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?t=" λ":this.defaultValue?t="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&(t=" #"),this.labelString+t):this.defSpecFragment()},BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},BlockLabelFragment.prototype.copy=function(){var t=new BlockLabelFragment(this.labelString);return t.type=this.type,t.defaultValue=this.defaultValue,t.options=this.options,t.isReadOnly=this.isReadOnly,t},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},BlockLabelFragment.prototype.isMultipleInput=function(){return this.type?this.type.indexOf("%mult")>-1:!1},BlockLabelFragment.prototype.isUpvar=function(){return this.type?"%upvar"===this.type:!1},BlockLabelFragment.prototype.setToSingleInput=function(){return this.type?void("%upvar"===this.type?this.type="%s":this.type=this.singleInputType()):null},BlockLabelFragment.prototype.setToMultipleInput=function(){return this.type?("%upvar"===this.type&&(this.type="%s"),void(this.type="%mult".concat(this.singleInputType()))):null},BlockLabelFragment.prototype.setToUpvar=function(){return this.type?void(this.type="%upvar"):null},BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},BlockLabelFragment.prototype.setSingleInputType=function(t){this.type&&this.isMultipleInput()?this.type="%mult".concat(t):this.type=t},BlockLabelFragmentMorph.prototype=new StringMorph,BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph,BlockLabelFragmentMorph.uber=StringMorph.prototype,BlockLabelFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type=null,this.sO=null,BlockLabelFragmentMorph.uber.init.call(this,t,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)},BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO,this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var t=this.fragment.copy(),o=this,e=this instanceof BlockLabelPlaceHolderMorph,i=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(t,null,function(){o.updateBlockLabel(t)},this,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":e?"Create input name":"Edit input name",t.labelString,this.world(),null,e||i)},BlockLabelFragmentMorph.prototype.updateBlockLabel=function(t){var o=this.parentThatIsA(BlockMorph);this.fragment=t,o&&o.refreshPrototype()},BlockLabelFragmentMorph.prototype.userMenu=function(){var t=this,o=new Color(100,100,130),e=new MenuMorph(function(o){var e=t.text.split("-");t.changed(),e[0]="$"+o,t.text=e.join("-"),t.fragment.labelString=t.text,t.drawNew(),t.changed()},null,this,this.fontSize);return SymbolMorph.prototype.names.forEach(function(t){e.addItem([new SymbolMorph(t,e.fontSize,o),t],t)}),e},BlockLabelPlaceHolderMorph.prototype=new StringMorph,BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph,BlockLabelPlaceHolderMorph.uber=StringMorph.prototype,BlockLabelPlaceHolderMorph.prototype.plainLabel=!1,BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,BlockLabelFragmentMorph.uber.init.call(this,"+")},BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var t,o,e,i,n,r;this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.image=newCanvas(),t=this.image.getContext("2d"),t.font=this.font(),o=Math.max(t.measureText(this.text).width+Math.abs(this.shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(o,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y))),this.image.width=o,this.image.height=this.height(),this.isHighlighted&&(n=Math.floor(o/2),r=Math.floor(this.height()/2),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(n,1.2*r,Math.min(n,r),radians(0),radians(360),!1),t.closePath(),t.fill()),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(e=Math.max(this.shadowOffset.x,0),i=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(this.text,e,fontHeight(this.fontSize)+i)),e=Math.abs(Math.min(this.shadowOffset.x,0)),i=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.isHighlighted?"white":this.color.toString(),t.fillText(this.text,e,fontHeight(this.fontSize)+i),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){this.isHighlighted=!0,this.drawNew(),this.changed()},BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){this.isHighlighted=!1,this.drawNew(),this.changed()},BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,BlockInputFragmentMorph.prototype=new TemplateSlotMorph,BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph,BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype,BlockInputFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type="%s",BlockInputFragmentMorph.uber.init.call(this,t)},BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,InputSlotDialogMorph.prototype=new DialogBoxMorph,InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph,InputSlotDialogMorph.uber=DialogBoxMorph.prototype,InputSlotDialogMorph.prototype.isLaunchingExpanded=!1,InputSlotDialogMorph.prototype.init=function(t,o,e,i,n){var r=SyntaxElementMorph.prototype.scale,s=fontHeight(10)/1.2*r;this.fragment=t||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=n||"other",this.cachedRadioButton=null,BlockDialogMorph.uber.init.call(this,o,e,i),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(s+10),10.4*(s+10*r))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},InputSlotDialogMorph.prototype.createTypeButtons=function(){var t,o,e=this,i=SpriteMorph.prototype.blockColor[this.category];t=new JaggedBlockMorph(localize("Title text")),t.setColor(i),this.addBlockTypeButton(function(){e.setType(null)},t,function(){return null===e.fragment.type}),t=new JaggedBlockMorph("%inputName"),t.setColor(i),this.addBlockTypeButton(function(){e.setType("%s")},t,function(){return null!==e.fragment.type}),o=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2),o.noticesTransparentClick=!0,this.types.add(o),this.types.fixLayout(),o.refresh=function(){null===e.fragment.type?(e.isExpanded=!1,o.hide(),e.drawNew()):(o.show(),e.isExpanded?o.direction="down":o.direction="right",o.drawNew(),o.changed())},o.mouseClickLeft=function(){o.isVisible&&(e.isExpanded=!e.isExpanded,e.types.children.forEach(function(t){t.refresh()}),e.drawNew(),e.edit())},o.refresh()},InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton,InputSlotDialogMorph.prototype.setType=function(t){this.textfield.choices=t?null:this.symbolMenu,this.textfield.drawNew(),this.fragment.type=t||null,this.types.children.forEach(function(t){t.refresh()}),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.getInput=function(){var t;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),t?(this.fragment.labelString=t,this.fragment.defaultValue=this.slots.defaultInputField.getValue(),t):(this.fragment.isDeleted=!0,null)},InputSlotDialogMorph.prototype.fixLayout=function(){var t,o=this.left(),e=fontHeight(this.titleFontSize)+2*this.titlePadding;return this.isExpanded?(this.slots.show(),t=this.slots.width(),this.body.setPosition(this.position().add(new Point(this.padding+(t-this.body.width())/2,e+this.padding))),this.label.setLeft(o+this.padding+(t-this.label.width())/2),this.label.setTop(this.top()+(e-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(o+this.padding+(t-this.types.width())/2),this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach(function(t){t.refresh()}),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),this.buttons.setLeft(o+this.padding+(t-this.buttons.width())/2),this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding),void this.silentSetWidth(this.slots.right()-this.left()+this.padding)):(this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this))},InputSlotDialogMorph.prototype.open=function(t,o,e,i,n){var r=new InputFieldMorph(o),s=Morph.prototype.trackChanges;this.fragment.type||(r.choices=this.symbolMenu),Morph.prototype.trackChanges=!1,this.isExpanded=this.isLaunchingExpanded,r.setWidth(250),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(r),r.drawNew(),this.textfield=r,this.addButton("ok","OK"),n||this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(e),this.add(this.types),Morph.prototype.trackChanges=s,this.changed()},InputSlotDialogMorph.prototype.symbolMenu=function(){var t=[],o=new Color(100,100,130),e=this;return SymbolMorph.prototype.names.forEach(function(i){t.push([[new SymbolMorph(i,e.fontSize,o),localize(i)],"$"+i])}),t},InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0,this.accept()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var t,o,e=this,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){e.setSlotArity("single")},"Single input.",function(){return e.fragment.isSingleInput()}),this.addSlotArityButton(function(){e.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return e.fragment.isMultipleInput()}),this.addSlotArityButton(function(){e.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return e.fragment.isUpvar()}),t=new StringMorph(localize("Default Value:")),t.fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(new Color(255,255,255)),t.refresh=function(){e.isExpanded&&contains(["%s","%n","%txt","%anyUE"],e.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),o=new InputFieldMorph(this.fragment.defaultValue),o.contents().fontSize=t.fontSize,o.contrast=90,o.contents().drawNew(),o.setWidth(50),o.refresh=function(){t.isVisible?(o.show(),"%n"===e.fragment.type?o.setIsNumeric(!0):o.setIsNumeric(!1)):o.hide()},this.slots.defaultInputField=o,this.slots.add(o),o.drawNew(),Morph.prototype.trackChanges=i},InputSlotDialogMorph.prototype.setSlotType=function(t){this.fragment.setSingleInputType(t),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.addSlotTypeButton=function(t,o){var e,i,n=this,r=function(){n.setSlotType(o)},s=new JaggedBlockMorph(o);return e=function(){return n.fragment.singleInputType()===o},s.setCategory(this.category),s.rebuild(),i=new ToggleMorph("radiobutton",this,r,t,e,null,null,this.cachedRadioButton,s.fullImage(),"rebuild"),i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.isBold=!1,i.label.setColor(new Color(255,255,255)),this.cachedRadioButton||(this.cachedRadioButton=i),this.slots.add(i),i},InputSlotDialogMorph.prototype.addSlotArityButton=function(t,o,e){var i=new ToggleMorph("radiobutton",this,t,o,e,null,null,this.cachedRadioButton);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.setColor(new Color(255,255,255)),this.slots.add(i),this.cachedRadioButton||(this.cachedRadioButton=i),i},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var t,o,e=this.slots,i=SyntaxElementMorph.prototype.scale,n=10*i,r=14*i,s=(fontHeight(10)/1.2+15)*i,p=(fontHeight(10)/1.2+10)*i,l=12,h=[e.left()+n,e.left()+e.width()/3,e.left()+2*e.width()/3],a=[e.top()+r,e.top()+r+s,e.top()+r+2*s,e.top()+r+3*s,e.top()+r+4*s,e.top()+r+5*s,e.top()+r+5*s+p,e.top()+r+5*s+2*p],c=-1,u=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,t=0;l>t;t+=1)o=t%3,t%3===0&&(c+=1),e.children[t].setPosition(new Point(h[o],a[c]));for(o=0,c=5,t=l;l+3>t;t+=1)e.children[t].setPosition(new Point(h[o],a[c+t-l]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=u,this.slots.changed()},InputSlotDialogMorph.prototype.addSlotsMenu=function(){var t=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],t.fragment.type)){var o=new MenuMorph(t),e="☑ ",i="☐ ";return o.addItem("options...","editSlotOptions"),o.addItem((t.fragment.isReadOnly?e:i)+localize("read-only"),function(){t.fragment.isReadOnly=!t.fragment.isReadOnly}),o}return Morph.prototype.userMenu.call(t)}},InputSlotDialogMorph.prototype.editSlotOptions=function(){var t=this;new DialogBoxMorph(t,function(o){t.fragment.options=o.trim()},t).promptCode("Input Slot Options",t.fragment.options,t.world(),null,localize('Enter one option per line.Optionally use "=" as key/value delimiter\ne.g.\n   the answer=42'))},InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0,this.changed()},VariableDialogMorph.prototype=new DialogBoxMorph,VariableDialogMorph.prototype.constructor=VariableDialogMorph,VariableDialogMorph.uber=DialogBoxMorph.prototype,VariableDialogMorph.prototype.init=function(t,o,e){this.types=null,this.isGlobal=!0,BlockDialogMorph.uber.init.call(this,t,o,e),this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.createTypeButtons()},VariableDialogMorph.prototype.createTypeButtons=function(){var t=this;this.addTypeButton(function(){t.setType("gobal")},"对所有角色",function(){return t.isGlobal}),this.addTypeButton(function(){t.setType("local")},"对这个角色",function(){return!t.isGlobal})},VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,VariableDialogMorph.prototype.setType=function(t){this.isGlobal="gobal"===t,this.types.children.forEach(function(t){t.refresh()}),this.edit()},VariableDialogMorph.prototype.getInput=function(){var t=this.normalizeSpaces(this.body.getValue());return t?[t,this.isGlobal]:null},VariableDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.key="blockExport",BlockExportDialogMorph.prototype.init=function(t,o){var e=this;this.serializer=t,this.blocks=o.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,null,function(){e.exportBlocks()},null),this.labelString="Export blocks",this.createLabel(),this.buildContents()},BlockExportDialogMorph.prototype.buildContents=function(){var t,o,e,i,n,r,s=this,p=4;t=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),t.color=SpriteMorph.prototype.paletteColor,t.padding=p,t.isDraggable=!1,t.acceptsDrops=!1,t.contents.acceptsDrops=!1,o=t.left()+p,e=t.top()+p,SpriteMorph.prototype.categories.forEach(function(l){s.blocks.forEach(function(h){h.category===l&&(r&&l!==r&&(e+=p),r=l,i=h.templateInstance(),n=new ToggleMorph("checkbox",s,function(){var t=s.blocks.indexOf(h);t>-1?s.blocks.splice(t,1):s.blocks.push(h)},null,function(){return contains(s.blocks,h)},null,null,null,i.fullImage()),n.setPosition(new Point(o,e+(n.top()-n.toggleElement.top()))),t.addContents(n),e+=n.fullBounds().height()+p)})}),t.scrollX(p),t.scrollY(p),this.addBody(t),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.popUp=function(t){var o=t||this.target.world();o&&(BlockExportDialogMorph.uber.popUp.call(this,o),this.handle=new HandleMorph(this,200,220,this.corner,this.corner))},BlockExportDialogMorph.prototype.userMenu=function(){var t=new MenuMorph(this,"select");return t.addItem("all","selectAll"),t.addItem("none","selectNone"),t},BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(t){t.state||t.trigger()})},BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach(function(t){t.refresh()})},BlockExportDialogMorph.prototype.exportBlocks=function(){var t=encodeURIComponent(this.serializer.serialize(this.blocks));this.blocks.length>0?window.open('data:text/xml,<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+t+"</blocks>"):(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype=new DialogBoxMorph,BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockImportDialogMorph.uber=DialogBoxMorph.prototype,BlockImportDialogMorph.prototype.key="blockImport",BlockImportDialogMorph.prototype.init=function(t,o,e){var i=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,o,function(){i.importBlocks(e)},null),this.labelString=localize("Import blocks")+(e?": ":"")+e||"",this.createLabel(),this.buildContents()},BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockImportDialogMorph.prototype.importBlocks=function(t){var o=this.target.parentThatIsA(IDE_Morph);o&&(this.blocks.length>0?(this.blocks.forEach(function(t){t.receiver=o.stage,o.stage.globalBlocks.push(t),o.stage.replaceDoubleDefinitionsFor(t)}),o.flushPaletteCache(),o.refreshPalette(),o.showMessage("Imported Blocks Module"+(t?": "+t:"")+".",2)):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))},BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;