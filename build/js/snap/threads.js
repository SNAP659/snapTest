function snapEquals(t,e){if(t instanceof List||e instanceof List)return t instanceof List&&e instanceof List?t.equalTo(e):!1;var o,r=+t,n=+e,i=[!0,!1,""];for(o=9;13>=o;o+=1)i.push(String.fromCharCode(o));return i.push(String.fromCharCode(160)),(isNaN(r)||isNaN(n)||[t,e].some(function(t){return contains(i,t)||isString(t)&&t.indexOf(" ")>-1}))&&(r=t,n=e),isString(r)&&isString(n)?r.toLowerCase()===n.toLowerCase():r===n}function ThreadManager(){this.processes=[]}function Process(t,e){this.topBlock=t||null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context,this.lastYield=Date.now(),this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=e||null,this.procedureCount=0,t&&(this.homeContext.receiver=t.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),this.pushContext("doYield"))}function Context(t,e,o,r){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=r||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.startTime=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.emptySlots=0,this.tag=null}function Variable(t){this.value=t}function VariableFrame(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}modules.threads="2015-May-01";var ThreadManager,Process,Context,VariableFrame;ThreadManager.prototype.toggleProcess=function(t){var e=this.findProcess(t);return e?void e.stop():this.startProcess(t)},ThreadManager.prototype.startProcess=function(t,e,o,r){var n,i=this.findProcess(t),s=t.topBlock();if(i){if(e)return i;i.stop(),this.removeTerminatedProcesses()}return n=new Process(t.topBlock(),r),n.exportResult=o,n.homeContext.receiver.isClone||s.addHighlight(),this.processes.push(n),n},ThreadManager.prototype.stopAll=function(t){this.processes.forEach(function(e){e!==t&&e.stop()})},ThreadManager.prototype.stopAllForReceiver=function(t,e){this.processes.forEach(function(o){o.homeContext.receiver===t&&o!==e&&(o.stop(),t.isClone&&(o.isDead=!0))})},ThreadManager.prototype.stopProcess=function(t){var e=this.findProcess(t);e&&e.stop()},ThreadManager.prototype.pauseAll=function(t){this.processes.forEach(function(t){t.pause()}),t&&t.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(t){return t.isPaused})},ThreadManager.prototype.resumeAll=function(t){this.processes.forEach(function(t){t.resume()}),t&&t.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){this.processes.forEach(function(t){t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()}),this.removeTerminatedProcesses()},ThreadManager.prototype.removeTerminatedProcesses=function(){var t=[];this.processes.forEach(function(e){!e.isRunning()&&!e.errorFlag||e.isDead?(e.topBlock instanceof BlockMorph&&e.topBlock.removeHighlight(),e.prompter&&(e.prompter.destroy(),e.homeContext.receiver.stopTalking&&e.homeContext.receiver.stopTalking()),e.topBlock instanceof ReporterBlockMorph&&(e.onComplete instanceof Function?e.onComplete(e.homeContext.inputs[0]):e.homeContext.inputs[0]instanceof List?e.topBlock.showBubble(new ListWatcherMorph(e.homeContext.inputs[0]),e.exportResult):e.topBlock.showBubble(e.homeContext.inputs[0],e.exportResult))):t.push(e)}),this.processes=t},ThreadManager.prototype.findProcess=function(t){var e=t.topBlock();return detect(this.processes,function(t){return t.topBlock===e})},Process.prototype={},Process.prototype.contructor=Process,Process.prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1;!this.readyToYield&&this.context&&(this.isAtomic?Date.now()-this.lastYield<this.timeout:!0);){if(this.isPaused)return this.pauseStep();this.evaluateContext()}if(this.lastYield=Date.now(),this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic()},Process.prototype.pause=function(){this.isPaused=!0,this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime)},Process.prototype.resume=function(){this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},Process.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof MultiArgMorph?this.evaluateMultiSlot(t,t.inputs().length):t instanceof ArgLabelMorph?this.evaluateArgLabel(t):t instanceof ArgMorph||t.bindingID?this.evaluateInput(t):t instanceof BlockMorph?this.evaluateBlock(t,t.inputs().length):isString(t)?this[t]():void this.popContext()},Process.prototype.evaluateBlock=function(t,e){if(contains(["reportOr","reportAnd","doReport"],t.selector))return this[t.selector](t);var o=this.context.receiver||this.topBlock.receiver(),r=this.context.inputs;if(e>r.length)this.evaluateNextInput(t);else if(this[t.selector]&&(o=this),this.isCatchingErrors)try{this.returnValueToParentContext(o[t.selector].apply(o,r)),this.popContext()}catch(n){this.handleError(n,t)}else this.returnValueToParentContext(o[t.selector].apply(o,r)),this.popContext()},Process.prototype.reportOr=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):e[0]?(this.returnValueToParentContext(!0),this.popContext()):e.length<2?this.evaluateNextInput(t):(this.returnValueToParentContext(e[1]===!0),this.popContext())},Process.prototype.reportAnd=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):e[0]?e.length<2?this.evaluateNextInput(t):(this.returnValueToParentContext(e[1]===!0),this.popContext()):(this.returnValueToParentContext(!1),this.popContext())},Process.prototype.doReport=function(t){var e=this.context.outerContext;if(this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e)},Process.prototype.evaluateMultiSlot=function(t,e){var o,r=this.context.inputs;if(t.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(t.bindingID)}catch(n){this.handleError(n,t)}else o=this.context.variables.getVar(t.bindingID);this.returnValueToParentContext(o),this.popContext()}else e>r.length?this.evaluateNextInput(t):(this.returnValueToParentContext(new List(r)),this.popContext())},Process.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},Process.prototype.evaluateInput=function(t){var e;if(t.bindingID)if(this.isCatchingErrors)try{e=this.context.variables.getVar(t.bindingID)}catch(o){this.handleError(o,t)}else e=this.context.variables.getVar(t.bindingID);else e=t.evaluate(),e&&(contains([CommandSlotMorph,ReporterSlotMorph],t.constructor)||t instanceof CSlotMorph&&!t.isStatic)&&(e=this.reify(e,new List));this.returnValueToParentContext(e),this.popContext()},Process.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,r=this.context.isCustomBlock;e===t.length-1?(this.context=new Context(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=r):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},Process.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs(),r=o[e],n=this.context.outerContext;r.isUnevaluated&&(r.isUnevaluated===!0||r.isUnevaluated())?contains(["reify","reportScript"],this.context.expression.selector)?this.context.addInput(r):this.context.addInput(this.reify(r,new List)):this.pushContext(r,n)},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(t,e){var o=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(o)||isNil(o.world()))&&(o=this.topBlock),o.showBubble((o===e?"":"Inside: ")+t.name+"\n"+t.message)},Process.prototype.reify=function(t,e,o){var r=new Context(null,null,this.context?this.context.outerContext:null),n=0;return t?(r.expression=t.fullCopy(),r.expression.show(),o||(r.expression.allEmptySlots().forEach(function(t){n+=1,t instanceof MultiArgMorph?t.bindingID=["arguments"]:t.bindingID=n}),r.emptySlots=n)):r.expression=[this.context.expression.fullCopy()],r.inputs=e.asArray(),r.receiver=this.context?this.context.receiver:t.receiver(),r},Process.prototype.reportScript=function(t,e){return this.reify(e,t)},Process.prototype.reifyScript=function(t,e){return this.reify(t,e)},Process.prototype.reifyReporter=function(t,e){return this.reify(t,e)},Process.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},Process.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},Process.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},Process.prototype.evaluate=function(t,e,o){if(!t)return null;if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var r,n,i,s,a=new Context(null,null,t.outerContext),p=this.context.parentContext,c=e.asArray();if(a.receiver||(a.receiver=t.receiver),n=new Context(this.context.parentContext,t.expression,a,t.receiver),this.context.parentContext=n,t.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),c.length>0){for(i=0;i<t.inputs.length;i+=1)s=0,isNil(c[i])||(s=c[i]),a.variables.addVar(t.inputs[i],s);if(0===t.inputs.length)if(a.variables.addVar(["arguments"],e),1===c.length)for(i=1;i<=t.emptySlots;i+=1)a.variables.addVar(i,c[0]);else if(c.length===t.emptySlots)for(i=1;i<=c.length;i+=1)a.variables.addVar(i,c[i-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+c.length)}n.expression instanceof CommandBlockMorph&&(n.expression=n.expression.blockSequence(),o||(p?p.tag="exit":(r=new Context(n.parentContext,"expectReport",a,a.receiver),r.tag="exit",n.parentContext=r)))},Process.prototype.fork=function(t,e){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var o,r,n=new Context(null,null,t.outerContext),i=new Context(null,t.expression,n),s=e.asArray(),a=this.homeContext.receiver.parentThatIsA(StageMorph),p=new Process;if(s.length>0){for(o=0;o<t.inputs.length;o+=1)r=0,isNil(s[o])||(r=s[o]),n.variables.addVar(t.inputs[o],r);if(0===t.inputs.length)if(n.variables.addVar(["arguments"],e),1===s.length)for(o=1;o<=t.emptySlots;o+=1)n.variables.addVar(o,s[0]);else if(s.length===t.emptySlots)for(o=1;o<=s.length;o+=1)n.variables.addVar(o,s[o-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+s.length)}i.expression instanceof CommandBlockMorph&&(i.expression=i.expression.blockSequence()),p.homeContext=t.outerContext,p.topBlock=t.expression,p.context=i,p.pushContext("doYield"),a.threads.processes.push(p)},Process.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if(isNil(t))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},Process.prototype.doCallCC=function(t,e){this.evaluate(t,new List([this.context.continuation()]),!e)},Process.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},Process.prototype.runContinuation=function(t,e){var o=e.asArray();this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},Process.prototype.evaluateCustomBlock=function(){var t,e,o,r,n,i=this.context.parentContext,s=this.context.expression.definition.body,a=this.context.expression.definition.declarations,p=new List(this.context.inputs),c=p.asArray();if(!s)return null;if(this.procedureCount+=1,n=new Context,n.receiver=this.context.receiver,n.variables.parentFrame=n.receiver?n.receiver.variables:null,t=new Context(this.context.parentContext,s.expression,n,n.receiver),t.isCustomBlock=!0,this.context.parentContext=t,c.length>0)for(o=0;o<s.inputs.length;o+=1)r=0,isNil(c[o])||(r=c[o]),n.variables.addVar(s.inputs[o],r),"%upvar"===a[s.inputs[o]][0]&&(this.context.outerContext.variables.vars[r]=n.variables.vars[s.inputs[o]]);"command"!==this.context.expression.definition.type?(i?i.tag="exit":(e=new Context(t.parentContext,"expectReport",n,n.receiver),e.tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),i&&!i.tag&&(i.tag=this.procedureCount),this.isAtomic||(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},Process.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach(function(t){e.addVar(t)})},Process.prototype.doSetVar=function(t,e){var o=this.context.variables,r=t;return r instanceof Context&&"reportGetVar"===r.expression.selector?void r.variables.setVar(r.expression.blockSpec,e):void o.setVar(r,e,this.blockReceiver())},Process.prototype.doChangeVar=function(t,e){var o=this.context.variables,r=t;return r instanceof Context&&"reportGetVar"===r.expression.selector?void r.variables.changeVar(r.expression.blockSpec,e):void o.changeVar(r,e,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},Process.prototype.doShowVar=function(t){var e,o,r,n,i,s,a=this.context.variables,p=t;if(p instanceof Context&&"reportGetVar"===p.expression.selector&&(p=p.expression.blockSpec),this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))){if(r=a.find(p),o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===p}),null!==o)return o.show(),void o.fixLayout();s=contains(this.homeContext.receiver.variables.parentFrame.names(),t),n=s||r.owner?p:p+" "+localize("(temporary)"),o=new WatcherMorph(n,SpriteMorph.prototype.blockColor.variables,r,p),o.setPosition(e.position().add(10)),i=e.watchers(o.left()),i.length>0&&o.setTop(i[i.length-1].bottom()),e.add(o),o.fixLayout()}},Process.prototype.doHideVar=function(t){var e,o,r,n=this.context.variables,i=t;return i instanceof Context&&"reportGetVar"===i.expression.selector&&(i=i.expression.blockSpec),i?void(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&(r=n.find(i),o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===i}),null!==o&&(o.isTemporary()?o.destroy():o.hide())))):void this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.watchers().forEach(function(t){t.isTemporary()&&t.destroy()}))},Process.prototype.reportNewList=function(t){return t},Process.prototype.reportCONS=function(t,e){return(new List).cons(t,e)},Process.prototype.reportCDR=function(t){return t.cdr()},Process.prototype.doAddToList=function(t,e){e.add(t)},Process.prototype.doDeleteFromList=function(t,e){var o=t;if("all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},Process.prototype.doInsertInList=function(t,e,o){var r=e;return""===e?null:("any"===this.inputOption(e)&&(r=this.reportRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(r=o.length()+1),void o.add(t,r))},Process.prototype.doReplaceInList=function(t,e,o){var r=t;return""===t?null:("any"===this.inputOption(t)&&(r=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(r=e.length()),void e.put(o,r))},Process.prototype.reportListItem=function(t,e){var o=t;return""===t?"":("any"===this.inputOption(t)&&(o=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(o=e.length()),e.at(o))},Process.prototype.reportListLength=function(t){return t.length()},Process.prototype.reportListContainsItem=function(t,e){return t.contains(e)},Process.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(t.threads.resumeAll(t),t.keysPressed={},t.threads.stopAll(),t.stopAllActiveSounds(),t.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),t.removeAllClones()),e=t.parentThatIsA(IDE_Morph))},Process.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:nop()}},Process.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(t){var e,o=this.context.outerContext,r=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&(e.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=r,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(t.fps=t.frameRate))},Process.prototype.reportIsFastTracking=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(IDE_Morph))?t.stage.isFastTracked:!1},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph),e&&(t?e.startFastTracking():e.stopFastTracking()))},Process.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.threads.pauseAll(t),e=t.parentThatIsA(IDE_Morph))},Process.prototype.doForever=function(t){this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(t,e){var o=this.context.expression,r=this.context.outerContext,n=this.context.isCustomBlock;return 1>t?null:(this.popContext(),this.pushContext(o,r),this.context.isCustomBlock=n,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),void this.pushContext())},Process.prototype.doUntil=function(t,e){return t?(this.popContext(),this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),void this.pushContext())},Process.prototype.doWaitUntil=function(t){return t?(this.popContext(),this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),void this.pushContext())},Process.prototype.reportMap=function(t,e){var o;if(e.isLinked){if(this.context.inputs.length<3&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(e)),0===this.context.inputs[4].length())return this.context.inputs[3].rest=e.cons(this.context.inputs[5]),void this.returnValueToParentContext(this.context.inputs[2].cdr());this.context.inputs.length>5&&(this.context.inputs[3].rest=e.cons(this.context.inputs[5]),this.context.inputs[3]=this.context.inputs[3].rest,this.context.inputs.splice(5)),o=this.context.inputs[4].at(1),this.context.inputs[4]=this.context.inputs[4].cdr(),this.pushContext(),this.evaluate(t,new List([o]))}else{if(this.context.inputs.length-2===e.length())return void this.returnValueToParentContext(new List(this.context.inputs.slice(2)));o=e.at(this.context.inputs.length-1),this.pushContext(),this.evaluate(t,new List([o]))}},Process.prototype.doForEach=function(t,e,o){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var r=this.context.inputs[3];this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,e.at(r)),r>e.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(o,new List,!0))},Process.prototype.doWait=function(t){return this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doGlide=function(t,e,o){return this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t?(this.blockReceiver().gotoXY(e,o),null):(this.blockReceiver().glide(1e3*t,e,o,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),void this.pushContext())},Process.prototype.doSayFor=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e?(this.blockReceiver().stopTalking(),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doThinkFor=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e?(this.blockReceiver().stopTalking(),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver},Process.prototype.doPlaySoundUntilDone=function(t){var e=this.homeContext.receiver;return null===this.context.activeAudio&&(this.context.activeAudio=e.playSound(t)),this.context.activeAudio.ended||this.context.activeAudio.terminated?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);t&&(t.threads.processes.forEach(function(t){t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())}),t.stopAllActiveSounds())},Process.prototype.bubble=function(t){"use strict";this.blockReceiver().bubble(t)},Process.prototype.doAsk=function(t){var e,o=this.homeContext.receiver.parentThatIsA(StageMorph),r=this.blockReceiver()instanceof StageMorph;if(o.keysPressed={},this.prompter){if(this.prompter.isDone)return o.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,r||this.blockReceiver().stopTalking(),null}else e=detect(o.children,function(t){return t instanceof StagePrompterMorph}),e||(r||this.blockReceiver().bubble(t,!1,!0),this.prompter=new StagePrompterMorph(r?t:null),o.scale<1?this.prompter.setWidth(o.width()-10):this.prompter.setWidth(o.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(o.center()),this.prompter.setBottom(o.bottom()-this.prompter.border),o.add(this.prompter),this.prompter.inputField.edit(),o.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET","http://"+t,!0),this.httpRequest.send(null);this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph),o=[],r=[],n=world.children[0],i=null;if(preloadConfig=window.codemao.preloadConfig||{},""!==t){if(preloadConfig&&preloadConfig.message&&(i=preloadConfig.message[t]))return alert("I!"),n&&n.corralBar?n.stopAllScripts():e.fireStopAllEvent(),[];e.lastMessage=t,e.children.concat(e).forEach(function(e){(e instanceof SpriteMorph||e instanceof StageMorph)&&(o=o.concat(e.allHatBlocksFor(t)))}),o.forEach(function(t){r.push(e.threads.startProcess(t,e.isThreadSafe))})}return r},Process.prototype.doBroadcastAndWait=function(t){return this.context.activeSends||(this.context.activeSends=this.doBroadcast(t)),this.context.activeSends=this.context.activeSends.filter(function(t){return t.isRunning()}),0===this.context.activeSends.length?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getLastMessage():""},Process.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},Process.prototype.reportTypeOf=function(t){var e;return null===t||void 0===t?"nothing":t===!0||t===!1?"Boolean":isNaN(+t)?isString(t)?"text":t instanceof List?"list":t instanceof Context?t.expression instanceof RingMorph?t.expression.dataType():t.expression instanceof ReporterBlockMorph?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0],e.isPredicate?"predicate":e instanceof RingMorph?e.dataType():e instanceof ReporterBlockMorph?"reporter":e instanceof CommandBlockMorph?"command":"reporter"):t.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number"},Process.prototype.reportSum=function(t,e){return+t+ +e},Process.prototype.reportDifference=function(t,e){return+t-+e},Process.prototype.reportProduct=function(t,e){return+t*+e},Process.prototype.reportQuotient=function(t,e){return+t/+e},Process.prototype.reportModulus=function(t,e){var o=+t,r=+e;return(o%r+r)%r},Process.prototype.reportRandom=function(t,e){var o=+t,r=+e;return o%1!==0||r%1!==0?Math.random()*(r-o)+o:Math.floor(Math.random()*(r-o+1))+o},Process.prototype.reportLessThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),r>o},Process.prototype.reportNot=function(t){return!t},Process.prototype.reportGreaterThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),o>r},Process.prototype.reportEquals=function(t,e){return snapEquals(t,e)},Process.prototype.reportContains=function(t,e){var o=""+t,r=""+e;return o=o.toLowerCase(),r=r.toLowerCase(),-1!=o.indexOf(r)},Process.prototype.reportIsIdentical=function(t,e){function o(){Object.prototype.hasOwnProperty.call(t,r)&&delete t[r],Object.prototype.hasOwnProperty.call(e,r)&&delete e[r]}var r="idTag";return this.isImmutable(t)||this.isImmutable(e)?snapEquals(t,e):(o(),t[r]=Date.now(),e[r]===t[r]?(o(),!0):(o(),!1))},Process.prototype.isImmutable=function(t){return contains(["nothing","Boolean","text","number","undefined"],this.reportTypeOf(t))},Process.prototype.reportTrue=function(){return!0},Process.prototype.reportFalse=function(){return!1},Process.prototype.reportRound=function(t){return Math.round(+t)},Process.prototype.reportMonadic=function(t,e){var o=+e,r=0;switch(this.inputOption(t)){case"abs":r=Math.abs(o);break;case"floor":r=Math.floor(o);break;case"sqrt":r=Math.sqrt(o);break;case"sin":r=Math.sin(radians(o));break;case"cos":r=Math.cos(radians(o));break;case"tan":r=Math.tan(radians(o));break;case"asin":r=degrees(Math.asin(o));break;case"acos":r=degrees(Math.acos(o));break;case"atan":r=degrees(Math.atan(o));break;case"ln":r=Math.log(o);break;case"log":r=0;break;case"e^":r=Math.exp(o);break;case"10^":r=0;break;default:nop()}return r},Process.prototype.reportTextFunction=function(t,e){var o=(isNil(e)?"":e).toString(),r="";switch(this.inputOption(t)){case"encode URI":r=encodeURI(o);break;case"decode URI":r=decodeURI(o);break;case"encode URI component":r=encodeURIComponent(o);break;case"decode URI component":r=decodeURIComponent(o);break;case"XML escape":r=(new XML_Element).escape(o);break;case"XML unescape":r=(new XML_Element).unescape(o);break;case"hex sha512 hash":r=hex_sha512(o);break;default:nop()}return r},Process.prototype.reportJoin=function(t,e){var o=(isNil(t)?"":t).toString(),r=(isNil(e)?"":e).toString();return o.concat(r)},Process.prototype.reportJoinWords=function(t){return t instanceof List?t.asText():(t||"").toString()},Process.prototype.reportLetter=function(t,e){if(e instanceof List)return"";var o=+(t||0),r=(e||"").toString();return r[o-1]||""},Process.prototype.reportStringSize=function(t){if(t instanceof List)return t.length();var e=(t||"").toString();return e.length},Process.prototype.reportUnicode=function(t){var e=(t||"").toString()[0];return e?e.charCodeAt(0):0},Process.prototype.reportUnicodeAsLetter=function(t){var e=+(t||0);return String.fromCharCode(e)},Process.prototype.reportTextSplit=function(t,e){var o,r,n=["text","number"],i=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(n,i))throw new Error("expecting text instead of a "+i);if(!contains(n,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=(t||"").toString(),this.inputOption(e)){case"line":r=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":r="	";break;case"cr":r="\r";break;case"whitespace":o=o.trim(),r=/\s+/;break;case"letter":r="";break;default:r=(e||"").toString()}return new List(o.split(r))},Process.prototype.alert=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.world(),e.isDevMode&&alert("Snap! "+t.asArray()))},Process.prototype.log=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.world(),e.isDevMode&&console.log("Snap! "+t.asArray()))},Process.prototype.getOtherObject=function(t,e,o){var r=isNil(o)?e.parentThatIsA(StageMorph):o,n=null;return r&&(n=detect(r.children,function(e){return e.name===t}),n||(n=detect(r.world().hand.children,function(e){return e instanceof SpriteMorph&&e.name===t}))),n},Process.prototype.getObjectsNamed=function(t,e,o){function r(e){return e instanceof SpriteMorph&&e.isClone?e.cloneOriginName===t:e.name===t;
}var n=isNil(o)?e.parentThatIsA(StageMorph):o,i=[];return n&&(i=n.children.filter(r),i.length||(i=n.world().hand.children.filter(r))),i},Process.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.faceToXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver),e&&o.faceToXY(e.xPosition(),e.yPosition())))},Process.prototype.doGotoObject=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.gotoXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver),e&&o.gotoXY(e.xPosition(),e.yPosition())))},Process.prototype.createClone=function(t){var e,o=this.homeContext.receiver;t&&o&&("myself"===this.inputOption(t)?o.createClone():(e=this.getOtherObject(t,o),e&&e.createClone()))},Process.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return e?this.objectTouchingObject(e,t):!1},Process.prototype.objectTouchingObject=function(t,e){var o,r,n,i,s=this;if("mouse-pointer"===this.inputOption(e)){if(i=t.world().hand.position(),t.bounds.containsPoint(i)&&!t.isTransparentAt(i))return!0}else if(r=t.parentThatIsA(StageMorph)){if("edge"===this.inputOption(e)&&(n=t.bounds,!t.costume&&t.penBounds&&(n=t.penBounds.translateBy(t.position())),!r.bounds.containsRectangle(n)))return!0;if("pen trails"===this.inputOption(e)&&t.isTouching(r.penTrailsMorph()))return!0;if(o=this.getObjectsNamed(e,t,r),o.some(function(e){return e.isVisible!==!1?t.isTouching(e):void 0}))return!0}return t.parts.some(function(t){return s.objectTouchingObject(t,e)})},Process.prototype.reportTouchingColor=function(t){var e,o=this.homeContext.receiver;return o&&(e=o.parentThatIsA(StageMorph))?o.isTouching(e.colorFiltered(t,o))?!0:o.parts.some(function(o){return o.isTouching(e.colorFiltered(t,o))}):!1},Process.prototype.reportColorIsTouchingColor=function(t,e){var o,r=this.homeContext.receiver;return r&&(o=r.parentThatIsA(StageMorph))?r.colorFiltered(t).isTouching(o.colorFiltered(e,r))?!0:r.parts.some(function(r){return r.colorFiltered(t).isTouching(o.colorFiltered(e,r))}):!1},Process.prototype.reportDistanceTo=function(t){var e,o,r,n,i=this.blockReceiver();return i?(r=i.rotationCenter(),n=r,"mouse-pointer"===this.inputOption(t)&&(n=i.world().hand.position()),o=i.parentThatIsA(StageMorph),e=this.getOtherObject(t,i,o),e&&(n=e.rotationCenter()),r.distanceTo(n)/o.scale):0},Process.prototype.reportAttributeOf=function(t,e){var o,r,n=this.blockReceiver();if(n&&(r=n.parentThatIsA(StageMorph),o=r.name===t?r:this.getOtherObject(t,n,r))){if(e instanceof Context)return this.reportContextFor(e,o);if(isString(e))return o.variables.getVar(e);switch(this.inputOption(e)){case"x position":return o.xPosition?o.xPosition():"";case"y position":return o.yPosition?o.yPosition():"";case"direction":return o.direction?o.direction():"";case"costume #":return o.getCostumeIdx();case"costume name":return o.costume?o.costume.name:o instanceof SpriteMorph?localize("Turtle"):localize("Empty");case"size":return o.getScale?o.getScale():""}}return""},Process.prototype.reportContextFor=function(t,e){var o=copy(t);return o.receiver=e,o.outerContext&&(o.outerContext=copy(o.outerContext),o.outerContext.receiver=e,o.outerContext.variables.parentFrame=e.variables),o},Process.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(e=t.world()))?(e.hand.position().x-t.center().x)/t.scale:0},Process.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(e=t.world()))?(t.center().y-e.hand.position().y)/t.scale:0},Process.prototype.reportMouseDown=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.world())?"left"===t.hand.mouseButton:!1},Process.prototype.reportKeyPressed=function(t){var e;return this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))?void 0!==e.keysPressed[t]:!1},Process.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.resetTimer())},Process.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTimer():0};var dateMap={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};Process.prototype.reportDate=function(t){var e=this.inputOption(t),o=new Date,r=dateMap[e],n=o[r]();return dateMap[e]?(("month"===e||"day of week"===e)&&(n+=1),n):""},Process.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},Process.prototype.doMapHeader=function(t,e){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mapHeader(e||""):void 0},Process.prototype.doMapCode=function(t,e){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mapCode(e||""):void 0},Process.prototype.doMapStringCode=function(t){StageMorph.prototype.codeMappings.string=t||"<#1>"},Process.prototype.doMapListCode=function(t,e,o){var r="",n="delim";"parameters"===this.inputOption(e)?r="parms_":"variables"===this.inputOption(e)&&(r="tempvars_"),"list"===this.inputOption(t)?n="list":"item"===this.inputOption(t)&&(n="item"),StageMorph.prototype.codeMappings[r+n]=o||""},Process.prototype.reportMappedCode=function(t){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mappedCode():""},Process.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},Process.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTempo():0},Process.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&e.changeTempo(t))},Process.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&e.setTempo(t))},Process.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},Process.prototype.doPlayNoteForSecs=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play()),Date.now()-this.context.startTime>=1e3*e?(this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},Process.prototype.pushContext=function(t,e){this.context=new Context(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(t){if(void 0!==t){var e=this.context?this.context.parentContext||this.homeContext:this.homeContext;e.addInput(t)}},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Context.prototype.toString=function(){var t=this.expression;return t instanceof Array&&t.length>0&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},Context.prototype.image=function(){var t,e,o=new RingMorph;return this.expression instanceof Morph?(t=this.expression.fullCopy(),this.isContinuation&&(e=detect(t.allInputs(),function(t){return 1===t.bindingID}),e&&t.revertToDefaultInput(e,!0)),o.embed(t,this.inputs),o.fullImage()):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy(),t instanceof RingMorph&&!t.contents()?t.fullImage():(o.embed(t,this.isContinuation?[]:this.inputs),o.fullImage())):(o.color=SpriteMorph.prototype.blockColor.other,o.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(t){o.parts()[1].addInput(t)}),o.fullImage())},Context.prototype.continuation=function(){var t;if(this.expression instanceof Array)t=this;else{if(!this.parentContext)return new Context(null,"doYield");t=this.parentContext}return t=t.copyForContinuation(),t.tag=null,t.isContinuation=!0,t},Context.prototype.copyForContinuation=function(){var t=copy(this),e=t,o=!(this.expression instanceof Array||isString(this.expression));if(o)for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),e=e.parentContext,e.inputs=[];return t},Context.prototype.copyForContinuationCall=function(){var t=copy(this),e=t,o=!(this.expression instanceof Array||isString(this.expression));if(o)for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),e=e.parentContext,e.inputs=[];return t},Context.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),t=this.expression.inputs()[e],t&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(t){this.inputs.push(t)},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return"a Variable ["+this.value+"]"},Variable.prototype.copy=function(){return new Variable(this.value)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},VariableFrame.prototype.copy=function(){var t=new VariableFrame(this.parentFrame),e=this;return this.names().forEach(function(o){t.addVar(o,e.getVar(o))}),t},VariableFrame.prototype.deepCopy=function(){var t;return t=new VariableFrame(this.parentFrame?this.parentFrame.deepCopy():this.parentFrame),t.vars=copy(this.vars),t},VariableFrame.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(t){return void 0!==this.vars[t]?this:this.parentFrame?this.parentFrame.silentFind(t):null},VariableFrame.prototype.setVar=function(t,e){var o=this.find(t);o&&(o.vars[t].value=e)},VariableFrame.prototype.changeVar=function(t,e){var o,r=this.find(t);r&&(o=parseFloat(r.vars[t].value),isNaN(o)?r.vars[t].value=e:r.vars[t].value=o+parseFloat(e))},VariableFrame.prototype.getVar=function(t){var e,o=this.silentFind(t);if(o)return e=o.vars[t].value,0===e?0:e===!1?!1:""===e?"":e||0;if("number"==typeof t)return"";throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(t,e){this.vars[t]=new Variable(0===e?0:e===!1?!1:""===e?"":e||0)},VariableFrame.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},VariableFrame.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},VariableFrame.prototype.allNamesDict=function(){function t(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}for(var e={},o=this;o;)t(o.vars,e),o=o.parentFrame;return e},VariableFrame.prototype.allNames=function(){var t,e=[],o=this.allNamesDict();for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&e.push(t);return e};