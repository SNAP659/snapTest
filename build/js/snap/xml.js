function ReadStream(t){this.contents=t||"",this.index=0}function XML_Element(t,e,n){this.init(t,e,n)}modules.xml="2014-January-09";var ReadStream,XML_Element;ReadStream.prototype.space=/[\s]/,ReadStream.prototype.next=function(t){var e,n;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(n=this.index,this.index+=t,this.contents.slice(n,this.index))},ReadStream.prototype.empty=function(){return void 0===this.contents||0===this.contents.length},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(t){this.index+=t||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(t){var e,n;return isString(this.contents)?(e=this.contents.substr(this.index).search(t),-1===e?"":(n=this.index,this.index+=e,this.contents.substring(n,this.index))):""},ReadStream.prototype.peekUpTo=function(t){if(!isString(this.contents))return"";var e=this.contents.substr(this.index).search(t);return-1===e?"":this.contents.substring(this.index,this.index+e)},ReadStream.prototype.skipSpace=function(){if(!isString(this.contents))return"";for(var t=this.peek();this.space.test(t)&&""!==t;)this.skip(),t=this.peek()},ReadStream.prototype.word=function(){var t,e;return isString(this.contents)?(t=this.contents.substr(this.index).search(/[\s\>\/\=]|$/),-1===t?"":(e=this.index,this.index+=t,this.contents.substring(e,this.index))):""},XML_Element.prototype=new Node,XML_Element.prototype.constructor=XML_Element,XML_Element.uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(t,e,n){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",XML_Element.uber.init.call(this),n instanceof XML_Element&&n.addChild(this)},XML_Element.prototype.require=function(t){var e=this.childNamed(t);if(!e)throw new Error("Missing required element <"+t+">!");return e},XML_Element.prototype.childNamed=function(t){return detect(this.children,function(e){return e.tag===t})},XML_Element.prototype.childrenNamed=function(t){return this.children.filter(function(e){return e.tag===t})},XML_Element.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},XML_Element.prototype.toString=function(t,e){var n,i,r="",s="",o=e||0;if(t){for(i=0;o>i;i+=1)s+=this.indentation;r+=s}r+="<"+this.tag;for(n in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,n)&&this.attributes[n]&&(r+=" "+n+'="'+this.attributes[n]+'"');return this.contents.length||this.children.length?(r+=">",r+=this.contents,this.children.forEach(function(e){t&&(r+="\n"),r+=e.toString(t,o+1)}),t&&this.children.length&&(r+="\n"+s),r+="</"+this.tag+">"):r+="/>",r},XML_Element.prototype.escape=function(t,e){var n,i,r=isNil(t)?"":t.toString(),s="";for(n=0;n<r.length;n+=1)switch(i=r[n]){case"'":s+="&apos;";break;case'"':s+=e?i:"&quot;";break;case"<":s+="&lt;";break;case">":s+="&gt;";break;case"&":s+="&amp;";break;case"\n":s+="&#xD;";break;case"~":s+="&#126;";break;default:s+=i}return s},XML_Element.prototype.unescape=function(t){function e(t){s+=t,r.upTo(";"),r.skip()}for(var n,i,r=new ReadStream(t),s="";!r.atEnd();)if(n=r.next(),"&"===n)switch(i=r.peekUpTo(";")){case"apos":e("'");break;case"quot":e('"');break;case"lt":e("<");break;case"gt":e(">");break;case"amp":e("&");break;case"#xD":e("\n");break;case"#126":e("~");break;default:s+=n}else s+=n;return s},XML_Element.prototype.parseString=function(t){var e=new ReadStream(t);e.upTo("<"),e.skip(),this.parseStream(e)},XML_Element.prototype.parseStream=function(t){var e,n,i,r;if(t.empty())throw new Error("没有收到任何数据 (Did not receive any data)");for(this.tag=t.word(),t.skipSpace(),i=t.peek();">"!==i&&"/"!==i;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),i=t.next(),'"'!==i&&"'"!==i)throw new Error("Expected single- or double-quoted attribute value");n=t.upTo(i),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(n),i=t.peek()}if("/"!==t.peek()){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if(i=t.next(),"<"===i){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}r=new XML_Element(null,null,this),r.parseStream(t)}else this.contents+=i}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')};