var materialVM;!function(){"use strict";function e(){this._audio=document.createElement("audio"),this._curAudio={categoryId:"-1",id:"-1"}}function t(e){switch(e){case 0:return"image";case 1:return"image-set";case 2:return"image-bg";case 3:return"audio";case 4:return"xml"}}function i(e){e.scrollTop=0,document.querySelector('[class^="slider__tc"]').style.height="0"}createScrollBar({wrapper:document.querySelector("#material-store .scroll-wrapper"),target:document.querySelector("#material-store .material-wrapper"),touch:!0,color:"#2EBCFA"});var a={tab:{juese:1,beijing:2,yinyue:3,weixin:4,activity:5,1:"juese",2:"beijing",3:"yinyue",4:"weixin",5:"activity"},categoryID:{juese:8,beijing:1,yinyue:4,weixin:14,activity:15},classNameOfTab:{juese:"juese",beijing:"beijing",yinyue:"yinyue",weixin:"weixin",activity:"activity"},carouselInterval:800},r={getContent:function(e,i){if(e===a.categoryID.weixin){var r=new XMLHttpRequest;r.open("get",window.codemao.apiServer+"/user/material/category/"+e),r.withCredentials=!0,r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);if(200==e.code){var a=[];e.data.materials.forEach(function(e){var i=t(e.file_type);"image"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-set"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-bg"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"audio"===i&&a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,src:e.preview,isNew:e.show_sign})}),i({myStuff:a})}}},r.send(null)}else if(e===a.categoryID.activity){var r=new XMLHttpRequest;r.open("get",window.codemao.apiServer+"/user/material/category/"+e),r.withCredentials=!0,r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);if(200==e.code){var a=[];e.data.materials.forEach(function(e){var i=t(e.file_type);"image"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-set"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-bg"===i?a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"audio"===i&&a.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,src:e.preview,isNew:e.show_sign})}),i({myStuff:a})}}},r.send(null)}else d.parallel([function(i){var a=new XMLHttpRequest;a.open("get",window.codemao.apiServer+"/user/material/category/"+e),a.withCredentials=!0,a.onload=function(){if(200===a.status){var e=JSON.parse(a.responseText);if(200==e.code){var r=[];e.data.materials.forEach(function(e){var i=t(e.file_type);"image"===i?r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-set"===i?r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"image-bg"===i?r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,isNew:e.show_sign}):"audio"===i&&r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,src:e.preview,isNew:e.show_sign})}),i(r)}else i([])}else i([])},a.send(null)},function(i){var a=new XMLHttpRequest;a.open("get",window.codemao.apiServer+"/material/category/"+e),a.withCredentials=!0,a.onload=function(){if(200===a.status){var e=JSON.parse(a.responseText);if(200==e.code){var r=[];e.data.materials.forEach(function(e){if(1!=e.isbuy){var i=t(e.file_type);"image"===i?r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,gold:e.gold}):"image-set"===i?r.push({categoryId:e.category_id,id:e.id,type:t(e.file_type),description:e.description,name:e.name,preview:e.preview,gold:e.gold}):"image-bg"===i?r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,preview:e.preview,gold:e.gold}):"audio"===i&&r.push({categoryId:e.category_id,id:e.id,type:i,description:e.description,name:e.name,src:e.preview,gold:e.gold})}}),i(r)}else i([])}else i([])},a.send(null)}],function(e){i({myStuff:e[0],storeStuff:e[1]})})},getUserGold:function(e){var t=new XMLHttpRequest;t.open("get",window.codemao.apiServer+"/user/material/category/"),t.withCredentials=!0,t.onload=function(){if(200===t.status){var i=JSON.parse(t.responseText);e(i.data.user_gold)}},t.send()},buyStuff:function(e,t){var i=new XMLHttpRequest;i.open("post",window.codemao.apiServer+"/user/material"),i.onload=function(){r.curConnection-=1,200===i.status&&t(JSON.parse(i.responseText))},i.withCredentials=!0,i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send("materialid="+e.id+"&categoryid="+e.categoryId)},getQrCode:function(e){var t=new XMLHttpRequest;t.open("get",window.codemao.apiServer+"/wechat/qrcode"),t.withCredentials=!0,t.onload=function(){if(200===t.status){var i=JSON.parse(t.responseText);200==i.code&&e(i.data.url)}},t.send(null)},deleteWeixinItem:function(e,t){var i=new XMLHttpRequest;i.open("delete",window.codemao.apiServer+"/user/material/"+e.id),i.withCredentials=!0,i.onload=function(){if(200===i.status){var e=JSON.parse(i.responseText);200==e.code&&t()}},i.send(null)},getTokenFromQiniu:function(e,t,i){var a=new XMLHttpRequest;a.open("get",window.codemao.apiServer+"/program/cdn/upload/token"),a.withCredentials=!0,a.onload=function(){if(200===a.status){var o=JSON.parse(a.responseText);200==o.code&&r._uploadToQiniu(o.data,e,t,i)}},a.send(null)},_getFileKey:function(e,t,i){var a=new XMLHttpRequest;a.open("get",window.codemao.apiServer+"/program/cdn/upload/fileurl?filekey="+e.fileKey),a.withCredentials=!0,a.onload=function(){if(200===a.status){var e=JSON.parse(a.responseText);200==e.code&&r._recordToOurServer(e.data,t,i)}},a.send(null)},_uploadToQiniu:function(e,t,i,a){var o=new FormData;o.append("token",e.token),o.append("file",t);var n=new XMLHttpRequest;n.upload.addEventListener("progress",function(e){e.lengthComputable&&(i.progress=parseInt(e.loaded/e.total*100)+"%")}),n.upload.onload=function(){},n.open("post","https://up.qbox.me"),n.onload=function(){if(200===n.status){var i=JSON.parse(n.responseText);200==i.code&&r._getFileKey(e,t,a)}},n.send(o)},_recordToOurServer:function(e,t,i){var a=new XMLHttpRequest;a.open("post",window.codemao.apiServer+"/user/material/from/local"),a.withCredentials=!0,a.onload=function(){if(200===a.status){var e=JSON.parse(a.responseText);i(200==e.code?null:{code:e.code,msg:e.msg})}},a.setRequestHeader("Content-Type","application/json");var r="";/image/i.test(t.type)?r=0:/audio/i.test(t.type)&&(r=3),""!==r&&a.send(JSON.stringify({type:r,fileUrl:e.fileurl}))}},o=new Vue({el:"#material-store-wrapper",data:{displayMaterialWindow:!1,curTab:a.tab.juese,showStoreItemPreviewWindow:!1,showStorePreviewWrapper:!1,showMaterialStoreDialogWindow:!1,messageObj:{content:"",targetItem:{}},buyResultText:"",buyResultCode:-1,curPlayingAudio:{},carouselTarget:{},carouselTimeId:-1,curStoreItem:{},myStuff:[],storeStuff:[],userGold:-1,qrCodeImage:"",showUploadWindow:!1,upload:{error:{content:""},progress:""},init:!1},watch:{displayMaterialWindow:function(e){var t=this;t.init||r.getContent(a.categoryID.juese,function(e){t.init=!0,t.curTab=a.tab.juese,t.myStuff=e.myStuff,t.storeStuff=e.storeStuff,u.build()}),e&&r.getUserGold(function(e){t.userGold=e})},curTab:function(e){var t=this;t.displayMaterialWindow&&(t.curTab===a.tab.weixin,r.getQrCode(function(e){t.qrCodeImage=e}))}},computed:{classNameOfMaterialStore:function(){return this.curTab===a.tab.juese?a.classNameOfTab.juese:this.curTab===a.tab.beijing?a.classNameOfTab.beijing:this.curTab===a.tab.yinyue?a.classNameOfTab.yinyue:this.curTab===a.tab.weixin?a.classNameOfTab.weixin:this.curTab===a.tab.activity?a.classNameOfTab.activity:void 0}},methods:{handleCloseMaterialStore:function(e){e.currentTarget===e.target&&(this.displayMaterialWindow=!1,n.pause())},handleCloseMaterialStoreBtn:function(){this.displayMaterialWindow=!1,n.pause()},handleJueseTabClick:function(){var e=this;r.getContent(a.categoryID.juese,function(t){e.curTab=a.tab.juese,e.myStuff=t.myStuff,e.storeStuff=t.storeStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handleBeijingTabClick:function(){var e=this;r.getContent(a.categoryID.beijing,function(t){e.curTab=a.tab.beijing,e.myStuff=t.myStuff,e.storeStuff=t.storeStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handleYinyueTabClick:function(){var e=this;r.getContent(a.categoryID.yinyue,function(t){e.curTab=a.tab.yinyue,e.myStuff=t.myStuff,e.storeStuff=t.storeStuff}),i(e.$els.materialWrapper),n.pause()},handleWeixinTabClick:function(){var e=this;r.getContent(a.categoryID.weixin,function(t){e.curTab=a.tab.weixin,e.myStuff=t.myStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handleActivityTabClick:function(){var e=this;r.getContent(a.categoryID.activity,function(t){e.curTab=a.tab.activity,e.myStuff=t.myStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handlePrevTabClick:function(){var e=this,t=e.curTab-1;t>0&&r.getContent(a.categoryID[a.tab[t]],function(i){e.curTab=t,e.myStuff=i.myStuff,e.storeStuff=i.storeStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handleNextTabClick:function(){var e=this,t=e.curTab+1;5>=t&&r.getContent(a.categoryID[a.tab[t]],function(i){e.curTab=t,e.myStuff=i.myStuff,e.storeStuff=i.storeStuff,u.build()}),i(e.$els.materialWrapper),n.pause()},handleStoreItemClick:function(e){this.showStoreItemPreviewWindow=!0,this.showStorePreviewWrapper=!0,this.curStoreItem=e,n.pause()},handleCloseStoreItemPreviewWindow:function(){this.showStoreItemPreviewWindow=!1},handleConfirmBuyStuff:function(){var e=this;r.buyStuff(e.curStoreItem,function(t){e.showStorePreviewWrapper=!1,setTimeout(function(){e.showStorePreviewWrapper=!0,e.showStoreItemPreviewWindow=!1},1e3),e.buyResultCode=t.code,200==t.code?(s.play(),e.userGold=e.userGold-e.curStoreItem.gold,e.buyResultText=t.msg,e.storeStuff.$remove(e.curStoreItem),e.$set("curStoreItem.isAppend","1"),e.myStuff.push(e.curStoreItem),e.curStoreItem={}):e.buyResultText=t.msg})},handlePlayAudio:function(e){n.play(e)&&(this.curPlayingAudio=e)},_handleCarousel:function(e){var t=this,i=1,r=t.targetCarousel.preview.length;t.carouselTimeId=setInterval(function(){r>i?(e.src=t.targetCarousel.preview[i],i++):(i=0,e.src=t.targetCarousel.preview[i])},a.carouselInterval)},handleStartCarousel:function(e,t){this.targetCarousel=e,this._handleCarousel(t.currentTarget.querySelector(".target-img"))},handleEndCarousel:function(e){e.currentTarget.querySelector(".target-img").src=this.targetCarousel.preview[0],this.targetCarousel={},clearInterval(this.carouselTimeId)},handleReadImage:function(e){world.hand.readImagee(e.preview,1,e.name),this.displayMaterialWindow=!1},handleReadImageBg:function(e){world.hand.readImagee(e.preview,2,e.name),this.displayMaterialWindow=!1},handleReadAudio:function(e){world.hand.readAudioo(e.src,e.name),this.displayMaterialWindow=!1,n.pause()},handleReadImageSet:function(e){for(var t=0;t<e.preview.length;t++)0===t?world.hand.readImagee(e.preview[t],1,e.name+"-"+t):world.hand.readImagee(e.preview[t],3,e.name+"-"+t);this.displayMaterialWindow=!1},handleDeleteWeixinItem:function(e){this.showMaterialStoreDialogWindow=!0,this.messageObj.content="确定删除此素材?",this.messageObj.type="deleteWeixinItem",this.messageObj.targetItem=e},handleCloseMaterialStoreDialogWindow:function(){this.showMaterialStoreDialogWindow=!1,this.messageObj.content="",this.messageObj.type="",this.messageObj.targetItem={}},handleMsgConfirm:function(){var e=this;"deleteWeixinItem"===e.messageObj.type&&r.deleteWeixinItem(e.messageObj.targetItem,function(){e.myStuff.$remove(e.messageObj.targetItem),e.handleCloseMaterialStoreDialogWindow()})},handleUploadMaterial:function(){this.$els.uploadMaterialInput.click()},handleCloseUploadWindow:function(){this.showUploadWindow=!1,this.upload.error.content="",this.upload.progress="",this.$els.uploadMaterialInput.value=""},_handleInputChange:function(e){var t=this;t.showUploadWindow=!0;var i=e.target.files[0];/mp3/i.test(i.type)?i.size<2e6?r.getTokenFromQiniu(i,t.upload,function(e,i){e||(t.handleCloseUploadWindow(),t.handleWeixinTabClick())}):(e.target.value="",t.upload.error.content="上传的音频不能超过2MB"):/image/i.test(i.type)&&(i.size<1e6?r.getTokenFromQiniu(i,t.upload,function(e,i){e||(t.handleCloseUploadWindow(),t.handleWeixinTabClick())}):(e.target.value="",t.upload.error.content="上传的图片不能超过1MB"))}},ready:function(){var e=this;r.getUserGold(function(t){e.userGold=t})}});materialVM=o;var n=new e;e.prototype._addMusic=function(e){this._audio.src=e.src,this._curAudio={categoryId:e.categoryId,id:e.id},this._audio.addEventListener("ended",function(){o.curPlayingAudio={}}),this._audio.addEventListener("pause",function(){o.curPlayingAudio={}})},e.prototype.play=function(e){return"-1"==this._curAudio.categoryId?(this._addMusic(e),this._audio.play(),!0):this._curAudio.categoryId==e.categoryId&&this._curAudio.id==e.id?this._audio.paused?(this._audio.play(),!0):(this._audio.pause(),!1):(this._addMusic(e),this._audio.play(),!0)},e.prototype.pause=function(){this._audio.pause()};var s=document.createElement("audio");s.src="https://o44j7l4g3.qnssl.com/codemao%2Fmaterial-store%2Fbuy-success.mp3";var d={parallel:function(e,t){for(var i=0,a=e,r=t,o=[],n=0;n<e.length;n++)!function(t){e[t](function(e){o[t]=e,i++,i===a.length&&"function"==typeof r&&r(o)})}(n)}},u={_l:null,build:function(){var e=this;setTimeout(function(){e._l&&e._l._destroy(),e._l=new Layzr({container:".material-wrapper",selector:"[data-layzr]",attr:"data-layzr",retinaAttr:"data-layzr-retina",bgAttr:"data-layzr-bg",hiddenAttr:"data-layzr-hidden",threshold:0,callback:null})},0)}}}();