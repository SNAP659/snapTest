!function(e,t){function a(e){this._token="",this._fileKey="",this.url=null,this._isAsyn=e!==!1}a.prototype.uploadingList=[],a.prototype.getToken=function(e,n,o,r,s){var i=this,p=new XMLHttpRequest,l=o||{};a.prototype.uploadingList.push(i),p.onreadystatechange=function(){if(4==p.readyState){var t=JSON.parse(p.responseText);if(i._token=t.data.token,i._fileKey=t.data.fileKey,l.fileKey=i._fileKey,r)switch(r){case"fileType":i.uploadFile(e,s,n,l);break;case"thumbnail":i.uploadThumbnail(e,n,l);break;default:i.upload(e,n,l)}else i.upload(e,n,l)}},p.open("GET",t.codemao.apiServer+"/program/cdn/upload/token",this._isAsyn),p.send()},a.prototype.upload=function(e,a,n){var o,r,s=this,i=n||{};if(e=e.replace(/^data:[\s\S]*?base64,/,""),!this._token)throw new Error('Params error:"token" can\'t empty');if(!e)throw new Error('Params error:"file" can\'t empty');o=t.codemao.cdnPath,r=new XMLHttpRequest,r.onreadystatechange=function(){if(4==r.readyState){var e=JSON.parse(r.responseText),n=new XMLHttpRequest;console.log(e),s.url=s._fileKey,i.src=s.url,n.onreadystatechange=function(){var t=-1;4==n.readyState&&(e=JSON.parse(n.responseText),s.url=e.data.fileurl,i.src=s.url,a&&a(i),t=s.uploadingList.indexOf(s),-1!==t&&s.uploadingList.splice(t,1))},n.open("GET",t.codemao.apiServer+"/program/cdn/upload/fileurl?filekey="+s._fileKey,s._isAsyn),n.send()}},r.open("POST",o,this._isAsyn),r.setRequestHeader("Content-Type","application/octet-stream"),r.setRequestHeader("Authorization","UpToken "+this._token),r.send(e)},a.prototype.uploadThumbnail=function(e,a,n){var o=this,r=n||{};if(e=e.replace(/^data:image\/png;base64,/,""),e=e.replace(/^data:audio\/mp3;base64,/,""),!this._token)throw new Error('Params error:"token" can\'t empty');if(!e)throw new Error('Params error:"file" can\'t empty');var s=t.codemao.cdnPath,i=new XMLHttpRequest;i.onreadystatechange=function(){var e=-1;if(4==i.readyState){var t=JSON.parse(i.responseText);console.log(t),o.url=o._fileKey,r.src=o.url,a&&a(r),e=o.uploadingList.indexOf(o),-1!==e&&o.uploadingList.splice(e,1)}},i.open("POST",s,this._isAsyn),i.setRequestHeader("Content-Type","application/octet-stream"),i.setRequestHeader("Authorization","UpToken "+this._token),i.send(e)},a.prototype.uploadFile=function(e,a,n,o){var r="//up.qbox.me",s=this,i=new XMLHttpRequest;i.open("POST",r,!0);var p;p=new FormData,null!==a&&void 0!==a&&p.append("key",a),p.append("token",this._token),p.append("file",e);i.onreadystatechange=function(e){if(4==i.readyState&&200==i.status&&""!=i.responseText){JSON.parse(i.responseText)}else 200!=i.status&&i.responseText},i.onreadystatechange=function(){if(4==i.readyState){var e=new XMLHttpRequest;e.onreadystatechange=function(){var t=-1;if(4==e.readyState){console.log(e.responseText);var a=JSON.parse(e.responseText);s.url=a.data.fileurl,o.src=s.url,n&&n(o),t=s.uploadingList.indexOf(s),-1!==t&&s.uploadingList.splice(t,1)}},e.open("GET",t.codemao.apiServer+"/program/cdn/upload/fileurl?filekey="+s._fileKey,s._isAsyn),e.send()}},i.send(p)},t.CDNUpload=a}($,window);